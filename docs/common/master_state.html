<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.6.0"/>
    <title>common.master_state API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../common.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;common</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#MasterState">MasterState</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#MasterState.__init__">MasterState</a>
                        </li>
                        <li>
                                <a class="variable" href="#MasterState.current_master_state">current_master_state</a>
                        </li>
                        <li>
                                <a class="variable" href="#MasterState.temporary_save_flag">temporary_save_flag</a>
                        </li>
                        <li>
                                <a class="variable" href="#MasterState.advance_save_flag">advance_save_flag</a>
                        </li>
                        <li>
                                <a class="variable" href="#MasterState.store_block_in_blockchain_in_memory_flag">store_block_in_blockchain_in_memory_flag</a>
                        </li>
                        <li>
                                <a class="variable" href="#MasterState.storage_sharding">storage_sharding</a>
                        </li>
                        <li>
                                <a class="variable" href="#MasterState.temporary_storage_sharding">temporary_storage_sharding</a>
                        </li>
                        <li>
                                <a class="function" href="#MasterState.get_master_state_from_memory_from_transaction">get_master_state_from_memory_from_transaction</a>
                        </li>
                        <li>
                                <a class="function" href="#MasterState.get_account_list_transaction">get_account_list_transaction</a>
                        </li>
                        <li>
                                <a class="function" href="#MasterState.get_master_state_from_memory_from_user">get_master_state_from_memory_from_user</a>
                        </li>
                        <li>
                                <a class="function" href="#MasterState.get_master_state_from_memory_from_account_list">get_master_state_from_memory_from_account_list</a>
                        </li>
                        <li>
                                <a class="function" href="#MasterState.update_master_state_memory">update_master_state_memory</a>
                        </li>
                        <li>
                                <a class="function" href="#MasterState.update_master_state">update_master_state</a>
                        </li>
                        <li>
                                <a class="function" href="#MasterState.update_old_utxo_key">update_old_utxo_key</a>
                        </li>
                        <li>
                                <a class="function" href="#MasterState.store_master_state_in_memory">store_master_state_in_memory</a>
                        </li>
                        <li>
                                <a class="function" href="#MasterState.delete_TempBlockPoH">delete_TempBlockPoH</a>
                        </li>
                        <li>
                                <a class="function" href="#MasterState.clean_temporary_file_master_state">clean_temporary_file_master_state</a>
                        </li>
                        <li>
                                <a class="function" href="#MasterState.extract_account_list_from_locking_script">extract_account_list_from_locking_script</a>
                        </li>
                        <li>
                                <a class="function" href="#MasterState.extract_account_list_from_unlocking_public_key_hash">extract_account_list_from_unlocking_public_key_hash</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../common.html">common</a><wbr>.master_state    </h1>

                
                        <input id="mod-master_state-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-master_state-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="kn">import</span> <span class="nn">json</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="kn">import</span> <span class="nn">logging</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="kn">import</span> <span class="nn">copy</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="kn">from</span> <span class="nn">common.utils</span> <span class="kn">import</span> <span class="n">normal_round</span><span class="p">,</span><span class="n">check_marketplace_step1</span><span class="p">,</span><span class="n">check_smart_contract_consistency</span><span class="p">,</span><span class="n">check_marketplace_step2</span><span class="p">,</span><span class="n">extract_marketplace_account</span><span class="p">,</span><span class="n">check_marketplace_step</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="kn">from</span> <span class="nn">common.values</span> <span class="kn">import</span> <span class="n">ROUND_VALUE_DIGIT</span><span class="p">,</span> <span class="n">DEFAULT_TRANSACTION_FEE_PERCENTAGE</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="kn">from</span> <span class="nn">common.io_storage_sharding</span> <span class="kn">import</span> <span class="n">StorageSharding</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a>        
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="k">class</span> <span class="nc">MasterState</span><span class="p">:</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="sd">    Class to manage the state of each NIG account including SmartContract. </span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="sd">    Each state of account is stored in an unique file.</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="sd">    It&#39;s faster than reading all the transactions associated to an account in the blockchain.</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a>        <span class="kn">from</span> <span class="nn">common.values</span> <span class="kn">import</span> <span class="n">MASTER_STATE_DIR</span><span class="p">,</span><span class="n">MASTER_STATE_DEEPTH</span><span class="p">,</span><span class="n">MASTER_STATE_DIR_TEMP</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="o">=</span><span class="p">{}</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">temporary_save_flag</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;temporary_save_flag&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">advance_save_flag</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;advance_save_flag&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">store_block_in_blockchain_in_memory_flag</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;store_block_in_blockchain_in_memory_flag&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">storage_sharding</span><span class="o">=</span><span class="n">StorageSharding</span><span class="p">(</span><span class="n">MASTER_STATE_DIR</span><span class="p">,</span><span class="n">deepth</span><span class="o">=</span><span class="n">MASTER_STATE_DEEPTH</span><span class="p">)</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">temporary_storage_sharding</span><span class="o">=</span><span class="n">StorageSharding</span><span class="p">(</span><span class="n">MASTER_STATE_DIR_TEMP</span><span class="p">,</span><span class="n">deepth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a>    <span class="k">def</span> <span class="nf">get_master_state_from_memory_from_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">transactions</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a>        <span class="n">block_PoH</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;block_PoH&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>        <span class="n">leader_node_flag</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;leader_node_flag&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>        <span class="c1">#logging.info(f&quot;==&gt;block_PoH1:{block_PoH}&quot;)</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a>        <span class="n">previous_PoH_hash</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;previous_PoH_hash&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a>        <span class="n">NIGthreading_flag</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;NIGthreading_flag&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>        <span class="c1">#logging.info(&quot;Getting master state from memory for a transaction&quot;)</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>        <span class="n">account_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_account_list_transaction</span><span class="p">(</span><span class="n">transactions</span><span class="p">)</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>        <span class="c1">#logging.info(f&quot;==&gt;account_list:{account_list}&quot;)</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;==&gt;transactions:</span><span class="si">{</span><span class="n">transactions</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">get_master_state_from_memory_from_account_list</span><span class="p">(</span><span class="n">account_list</span><span class="p">,</span><span class="n">block_PoH</span><span class="o">=</span><span class="n">block_PoH</span><span class="p">,</span><span class="n">previous_PoH_hash</span><span class="o">=</span><span class="n">previous_PoH_hash</span><span class="p">,</span><span class="n">leader_node_flag</span><span class="o">=</span><span class="n">leader_node_flag</span><span class="p">,</span><span class="n">NIGthreading_flag</span><span class="o">=</span><span class="n">NIGthreading_flag</span><span class="p">)</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a>    <span class="k">def</span> <span class="nf">get_account_list_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">transactions</span><span class="p">):</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a>        <span class="n">account_list</span><span class="o">=</span><span class="p">[]</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>        <span class="c1">#logging.info(f&quot;####transactions55:{transactions}&quot;)</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a>            <span class="c1">#account_list.append(transactions[&#39;inputs&#39;][0][&#39;transaction_hash&#39;]+&#39;_&#39;+str(transactions[&#39;inputs&#39;][0][&#39;output_index&#39;]))</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a>            <span class="k">for</span> <span class="n">utxo</span> <span class="ow">in</span> <span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;outputs&#39;</span><span class="p">]:</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a>                <span class="n">test1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_account_list_from_locking_script</span><span class="p">(</span><span class="s2">&quot;OP_SC&quot;</span><span class="p">,</span><span class="n">utxo</span><span class="p">)</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a>                <span class="n">test2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_account_list_from_locking_script</span><span class="p">(</span><span class="s2">&quot;OP_DEL_SC&quot;</span><span class="p">,</span><span class="n">utxo</span><span class="p">)</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a>                <span class="c1">#logging.info(f&quot;####OP_SC:{test1}&quot;)</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>                <span class="c1">#logging.info(f&quot;####OP_DEL_SC:{test2}&quot;)</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a>                <span class="n">account_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_account_list_from_locking_script</span><span class="p">(</span><span class="s2">&quot;OP_SC&quot;</span><span class="p">,</span><span class="n">utxo</span><span class="p">))</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a>                <span class="n">account_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_account_list_from_locking_script</span><span class="p">(</span><span class="s2">&quot;OP_DEL_SC&quot;</span><span class="p">,</span><span class="n">utxo</span><span class="p">))</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a>            <span class="k">for</span> <span class="n">inputs</span> <span class="ow">in</span> <span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">]:</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a>                <span class="n">new_account</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_account_list_from_unlocking_public_key_hash</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;unlocking_public_key_hash&#39;</span><span class="p">])</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a>                <span class="k">if</span> <span class="n">new_account</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">account_list</span><span class="p">:</span><span class="n">account_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_account</span><span class="p">)</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**** Transaction2: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a>        <span class="k">return</span> <span class="n">account_list</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>    <span class="k">def</span> <span class="nf">get_master_state_from_memory_from_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">user</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>        <span class="n">block_PoH</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;block_PoH&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>        <span class="n">leader_node_flag</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;leader_node_flag&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>        <span class="n">NIGthreading_flag</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;NIGthreading_flag&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">get_master_state_from_memory_from_account_list</span><span class="p">([</span><span class="n">user</span><span class="p">],</span><span class="n">block_PoH</span><span class="o">=</span><span class="n">block_PoH</span><span class="p">,</span><span class="n">leader_node_flag</span><span class="o">=</span><span class="n">leader_node_flag</span><span class="p">,</span><span class="n">NIGthreading_flag</span><span class="o">=</span><span class="n">NIGthreading_flag</span><span class="p">)</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>        
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>    <span class="k">def</span> <span class="nf">get_master_state_from_memory_from_account_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">account_list</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>        <span class="n">block_PoH</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;block_PoH&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>        <span class="n">leader_node_flag</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;leader_node_flag&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>        <span class="n">NIGthreading_flag</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;NIGthreading_flag&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>        <span class="n">previous_PoH_hash</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;previous_PoH_hash&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>        <span class="c1">#previous_PoH_hash is used by leaderNode to reference the previous block which is stored in the memory</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>        <span class="c1">#as the new block is not yet saved in the memory</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>        
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>        <span class="c1">#logging.info(f&quot;==&gt;account_list:{account_list}&quot;)</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>        <span class="c1">#STEP 1 retrieval of the last_block_pointer block_PoH</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>        <span class="kn">from</span> <span class="nn">common.io_blockchain</span> <span class="kn">import</span> <span class="n">BlockchainMemory</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>        <span class="n">blockchain_memory</span> <span class="o">=</span> <span class="n">BlockchainMemory</span><span class="p">()</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>        <span class="c1">#STEP 2 Retrievel of the last block_PoH in consensus_blockchain ONLY for temporary_storage_sharding</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>        <span class="k">if</span> <span class="n">block_PoH</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">block_PoH</span><span class="o">!=</span><span class="s2">&quot;TempBlockPoH&quot;</span> <span class="ow">and</span> <span class="n">block_PoH</span><span class="o">!=</span><span class="s2">&quot;add_in_blockchain&quot;</span><span class="p">:</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>            <span class="c1">#let&#39;s retrieve the last received block of the blockchain belonging to that block_PoH</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>            <span class="c1">#to ensure that the MasterState is up to date</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>            <span class="c1">#ONLY for temporary_storage_sharding (self.temporary_save_flag=True)</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>            <span class="kn">from</span> <span class="nn">common.consensus_blockchain</span> <span class="kn">import</span> <span class="n">consensus_blockchain</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>            <span class="c1">#logging.info(f&quot;### CHANGE OF block_PoH:w{block_PoH}&quot;)</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>            <span class="k">for</span> <span class="n">backlog_chain_list_counter</span> <span class="ow">in</span> <span class="n">consensus_blockchain</span><span class="o">.</span><span class="n">backlog_chain_list</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>                <span class="k">if</span> <span class="n">block_PoH</span> <span class="ow">in</span> <span class="n">consensus_blockchain</span><span class="o">.</span><span class="n">backlog_chain_list</span><span class="p">[</span><span class="n">backlog_chain_list_counter</span><span class="p">][</span><span class="s1">&#39;list&#39;</span><span class="p">]:</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>                    <span class="n">block_PoH</span><span class="o">=</span><span class="n">consensus_blockchain</span><span class="o">.</span><span class="n">backlog_chain_list</span><span class="p">[</span><span class="n">backlog_chain_list_counter</span><span class="p">][</span><span class="s1">&#39;last&#39;</span><span class="p">]</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>                    <span class="k">break</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>            <span class="c1">#logging.info(f&quot;### NEW block_PoH:{block_PoH}&quot;)</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>        <span class="c1">#STEP 2 retrieval of the block with the block_PoH</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>        <span class="k">if</span> <span class="n">block_PoH</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">block_PoH</span><span class="o">==</span><span class="s2">&quot;TempBlockPoH&quot;</span> <span class="ow">and</span> <span class="n">block_PoH</span><span class="o">!=</span><span class="s2">&quot;add_in_blockchain&quot;</span><span class="p">:</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>            <span class="n">block_PoH</span><span class="o">=</span><span class="n">blockchain_memory</span><span class="o">.</span><span class="n">backlog_storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;last_block_pointer&quot;</span><span class="p">)</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>            <span class="k">if</span> <span class="n">block_PoH</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span><span class="n">block_PoH</span><span class="o">=</span><span class="n">blockchain_memory</span><span class="o">.</span><span class="n">storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;last_block_pointer&quot;</span><span class="p">)</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>        <span class="k">elif</span> <span class="n">block_PoH</span><span class="o">==</span><span class="s2">&quot;add_in_blockchain&quot;</span><span class="p">:</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>            <span class="c1">#specific process when adding a new block in the BlockChain</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>            <span class="n">block_PoH</span><span class="o">=</span><span class="n">blockchain_memory</span><span class="o">.</span><span class="n">storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;last_block_pointer&quot;</span><span class="p">)</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>        <span class="n">blockchain_block_PoH</span><span class="o">=</span><span class="n">blockchain_memory</span><span class="o">.</span><span class="n">storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;last_block_pointer&quot;</span><span class="p">)</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>        <span class="n">block_PoH_chain_list</span><span class="o">=</span><span class="p">[</span><span class="n">block_PoH</span><span class="p">]</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>        <span class="k">if</span> <span class="n">blockchain_block_PoH</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span><span class="n">blockchain_block_PoH</span><span class="o">=</span><span class="n">block_PoH</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>        <span class="c1">#else:block_PoH_chain_list.append(blockchain_block_PoH)</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>        
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>        <span class="c1">#STEP 2 retrieval of all the block_PoH until blockchain_block_PoH</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>        <span class="c1">#logging.info(f&quot;### block_PoH:{block_PoH}&quot;)</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>        <span class="c1">#logging.info(f&quot;### previous_PoH_hash:{previous_PoH_hash}&quot;)</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>        <span class="c1">#logging.info(f&quot;### blockchain_block_PoH:{blockchain_block_PoH}&quot;)</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>        <span class="k">while</span> <span class="n">block_PoH</span><span class="o">!=</span><span class="n">blockchain_block_PoH</span><span class="p">:</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>            
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>            <span class="k">if</span> <span class="n">previous_PoH_hash</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>                <span class="n">block_dict</span><span class="o">=</span><span class="n">blockchain_memory</span><span class="o">.</span><span class="n">backlog_storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">block_PoH</span><span class="p">)</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>                <span class="k">if</span> <span class="n">block_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span><span class="n">block_dict</span><span class="o">=</span><span class="n">blockchain_memory</span><span class="o">.</span><span class="n">storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">block_PoH</span><span class="p">)</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>                <span class="c1">#Specific process only for LeaderNode when saving the Temporay Block</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>                <span class="n">block_dict</span><span class="o">=</span><span class="n">blockchain_memory</span><span class="o">.</span><span class="n">backlog_storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">previous_PoH_hash</span><span class="p">)</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>                <span class="k">if</span> <span class="n">block_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span><span class="n">block_dict</span><span class="o">=</span><span class="n">blockchain_memory</span><span class="o">.</span><span class="n">storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">previous_PoH_hash</span><span class="p">)</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>                <span class="n">block_PoH_chain_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">previous_PoH_hash</span><span class="p">)</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>                <span class="n">previous_PoH_hash</span><span class="o">=</span><span class="kc">None</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>            <span class="k">if</span> <span class="n">block_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span><span class="k">break</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>            <span class="c1">#logging.info(f&quot;###=&gt; block_PoH_chain_list:{block_PoH_chain_list}&quot;)</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>            <span class="c1">#logging.info(f&quot;###=&gt; block_dict:{block_dict}&quot;)</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>            <span class="n">previous_block_PoH</span><span class="o">=</span><span class="n">block_dict</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;previous_PoH_hash&#39;</span><span class="p">]</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>            <span class="n">block_PoH_chain_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">previous_block_PoH</span><span class="p">)</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>            <span class="n">block_PoH</span><span class="o">=</span><span class="n">previous_block_PoH</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>            <span class="k">if</span> <span class="n">block_PoH</span><span class="o">==</span><span class="s1">&#39;111&#39;</span><span class="p">:</span><span class="k">break</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>        <span class="n">block_PoH_chain_list</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>        <span class="c1">#if block_PoH==&quot;TempBlockPoH&quot;:block_PoH_chain_list.insert(0,&quot;TempBlockPoH&quot;)</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>        <span class="c1">#if block_PoH==&quot;TempBlockPoH&quot;:block_PoH_chain_list.append(&quot;TempBlockPoH&quot;)</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>        <span class="c1">#if leader_node_flag is True:block_PoH_chain_list.append(&quot;TempBlockPoH&quot;)</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>        <span class="k">if</span> <span class="n">NIGthreading_flag</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span><span class="n">block_PoH_chain_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;TempBlockPoH&quot;</span><span class="p">)</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>        <span class="c1">#logging.info(f&quot;### block_PoH_chain_list:{block_PoH_chain_list}&quot;)</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>        <span class="k">for</span> <span class="n">account</span> <span class="ow">in</span> <span class="n">account_list</span><span class="p">:</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>            <span class="c1">#read the file</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>            <span class="n">file_master_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>            <span class="k">if</span> <span class="n">file_master_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">file_master_state</span><span class="p">)</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>                <span class="c1">#logging.info(f&quot;########### current_master_state: {account} {self.current_master_state[account]}&quot;)</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>            
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>            <span class="c1">#read the temporary file for LeaderNode</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>            <span class="c1">#if self.store_block_in_blockchain_in_memory_flag is False:</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>            <span class="n">temporary_file_master_state_raw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temporary_storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>            <span class="k">if</span> <span class="n">temporary_file_master_state_raw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>                <span class="c1">#logging.info(f&quot;### check TempBlockPoH 0 block_PoH:{block_PoH}&quot;)</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>                <span class="c1">#Sanity check to ensure that old TempBlockPoH is well deleted</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>                <span class="n">block_PoH_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">temporary_file_master_state_raw</span><span class="p">)</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>                    <span class="n">TempBlockPoH_index</span><span class="o">=</span><span class="n">block_PoH_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;TempBlockPoH&#39;</span><span class="p">)</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;### check TempBlockPoH 2 </span><span class="si">{</span><span class="n">TempBlockPoH_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>                    <span class="k">if</span> <span class="n">TempBlockPoH_index</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">block_PoH_list</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;### check TempBlockPoH 3&quot;</span><span class="p">)</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>                        <span class="c1">#a previousTempBlockPoH needs to be deleted</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>                        <span class="c1"># because a most recent BlockPoH is existing</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>                        <span class="k">try</span><span class="p">:</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>                            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;### check TempBlockPoH 4&quot;</span><span class="p">)</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>                            <span class="n">temporary_file_master_state_raw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;TempBlockPoH&quot;</span><span class="p">)</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>                            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;****ERROR removal of old TempBlockPoH for account: </span><span class="si">{</span><span class="n">account</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>                        <span class="k">except</span><span class="p">:</span><span class="k">pass</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>                <span class="k">except</span><span class="p">:</span><span class="k">pass</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>                <span class="k">for</span> <span class="n">block_PoH</span> <span class="ow">in</span> <span class="n">block_PoH_chain_list</span><span class="p">:</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">update_master_state_memory</span><span class="p">(</span><span class="n">account</span><span class="p">,</span><span class="n">temporary_file_master_state_raw</span><span class="p">,</span><span class="n">block_PoH</span><span class="p">)</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>    <span class="k">def</span> <span class="nf">update_master_state_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">account</span><span class="p">,</span><span class="n">file_master_state_raw</span><span class="p">,</span><span class="n">block_PoH</span><span class="p">):</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>            <span class="n">file_master_state</span><span class="o">=</span><span class="n">file_master_state_raw</span><span class="p">[</span><span class="n">block_PoH</span><span class="p">]</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">file_master_state</span><span class="p">)</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span><span class="o">=</span><span class="n">file_master_state</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>            <span class="k">pass</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>    <span class="k">def</span> <span class="nf">update_master_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span><span class="n">block_PoH</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>        <span class="n">previous_PoH_hash</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;previous_PoH_hash&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>        <span class="n">leader_node_flag</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;leader_node_flag&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>        <span class="c1">#logging.info(f&quot;==&gt;block_PoH2:{block_PoH}&quot;)</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>        <span class="n">NIGthreading_flag</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;NIGthreading_flag&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>        <span class="c1">#previous_PoH_hash is used by leaderNode to reference the previous block which is stored in the memory</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>        <span class="c1">#as the new block is not yet saved in the memory</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>        <span class="c1">#logging.info(&quot;Update master state with transaction&quot;)</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>        
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>        <span class="c1">#Step 1 uploading of previous master state for that transaction</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">get_master_state_from_memory_from_transaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span><span class="n">block_PoH</span><span class="o">=</span><span class="n">block_PoH</span><span class="p">,</span><span class="n">previous_PoH_hash</span><span class="o">=</span><span class="n">previous_PoH_hash</span><span class="p">,</span><span class="n">leader_node_flag</span><span class="o">=</span><span class="n">leader_node_flag</span><span class="p">,</span><span class="n">NIGthreading_flag</span><span class="o">=</span><span class="n">NIGthreading_flag</span><span class="p">)</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>        <span class="c1">#Step 2 in case of SmartContract, ensure that the consistency of the SmartContract:</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>        <span class="c1">#only 1 input, only 1 output except for marketplace</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>        <span class="c1">#transaction_hash of input of new transaxction = UTXO of SmartContrat</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>        <span class="n">smart_contract_flag</span><span class="p">,</span><span class="n">smart_contract_error_list</span><span class="o">=</span><span class="n">check_smart_contract_consistency</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>        <span class="k">if</span> <span class="n">smart_contract_flag</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>            <span class="n">smart_contract_transaction_hash</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s2">&quot;transaction_hash&quot;</span><span class="p">]</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>            <span class="n">check_input_flag</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">])):</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>                <span class="n">smart_contract_input_transaction_hash</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;transaction_hash&#39;</span><span class="p">]</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>                <span class="n">smart_contract_output_index</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;output_index&#39;</span><span class="p">]</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>                <span class="n">unlocking_public_key_hash</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;unlocking_public_key_hash&#39;</span><span class="p">]</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>                <span class="n">smart_contract_account</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_account_list_from_unlocking_public_key_hash</span><span class="p">(</span><span class="n">unlocking_public_key_hash</span><span class="p">)</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>                <span class="k">if</span> <span class="n">smart_contract_account</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>                    <span class="c1">#smart_contract_account=&#39;&#39; when initializing BlockChain</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;#smart_contract_account:</span><span class="si">{</span><span class="n">smart_contract_account</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>                        <span class="n">smart_contract_account_account_dic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">smart_contract_account</span><span class="p">]</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>                    <span class="k">except</span><span class="p">:</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>                        <span class="n">smart_contract_account_account_dic</span><span class="o">=</span><span class="kc">None</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>                    <span class="k">if</span> <span class="n">smart_contract_account_account_dic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>                        <span class="k">if</span> <span class="n">smart_contract_input_transaction_hash</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">smart_contract_output_index</span><span class="p">)</span> <span class="ow">in</span> <span class="n">smart_contract_account_account_dic</span><span class="p">[</span><span class="s1">&#39;utxos&#39;</span><span class="p">]:</span> <span class="n">check_input_flag</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>                           
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>            <span class="k">if</span> <span class="n">check_input_flag</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>                <span class="c1">#any input_transaction_hash doesn&#39;t equal of the UTXO of the SmartContract which is not possible</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>                <span class="c1">#let&#39;s raise an issue</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;#transaction:</span><span class="si">{</span><span class="n">transaction</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;###ERROR UPDATE MASTER STATE of SmartContract with transaction_hash: </span><span class="si">{</span><span class="n">smart_contract_transaction_hash</span><span class="si">}</span><span class="s1"> INPUT of new transaction is not in current SmartContract UTXO&#39;</span><span class="p">)</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>        <span class="k">if</span> <span class="n">smart_contract_flag</span><span class="o">==</span><span class="s2">&quot;error&quot;</span><span class="p">:</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>            <span class="c1">#there is an issue with the SmartContrat</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>            <span class="n">smart_contract_transaction_hash</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s2">&quot;transaction_hash&quot;</span><span class="p">]</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;#transaction:</span><span class="si">{</span><span class="n">transaction</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;###ERROR UPDATE MASTER STATE of SmartContract with transaction_hash: </span><span class="si">{</span><span class="n">smart_contract_transaction_hash</span><span class="si">}</span><span class="s1"> ERROR:</span><span class="si">{</span><span class="n">smart_contract_error_list</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>        
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>        
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>        <span class="c1">#Step 3 deletion of older UTXO</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>        <span class="n">deleted_utxo</span><span class="o">=</span><span class="kc">None</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>        <span class="n">old_utxo_key</span><span class="o">=</span><span class="kc">None</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>        <span class="n">old_utxo_account</span><span class="o">=</span><span class="kc">None</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>        <span class="c1">#if check_marketplace_step1(transaction[&#39;outputs&#39;]) is False and &quot;BlockVote&quot; not in str(transaction[&#39;outputs&#39;]):</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>        <span class="c1">#if check_marketplace_step1(transaction[&#39;outputs&#39;]) is False and check_marketplace_step(98,transaction[&#39;outputs&#39;]) is False and check_marketplace_step(99,transaction[&#39;outputs&#39;]) is False:</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>        <span class="k">if</span> <span class="n">check_marketplace_step1</span><span class="p">(</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;outputs&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">])):</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>                    <span class="k">if</span> <span class="s2">&quot;_&quot;</span> <span class="ow">in</span> <span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;transaction_hash&#39;</span><span class="p">]:</span><span class="n">old_utxo_key</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;transaction_hash&#39;</span><span class="p">]</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>                    <span class="k">else</span><span class="p">:</span><span class="n">old_utxo_key</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;transaction_hash&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;output_index&#39;</span><span class="p">])</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>                    <span class="c1">#special process Smart Contract</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>                    <span class="c1">#when there is &quot;SC&quot; in unlocking_public_key_hash ex: &quot;31f2ac8088005412c7b031a6e342b17a65a48d01 SC f998212b2adc762f114c9ec2b0b2d9bd6c811688</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>                    <span class="n">old_utxo_account</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_account_list_from_unlocking_public_key_hash</span><span class="p">(</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;unlocking_public_key_hash&#39;</span><span class="p">])</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>                    <span class="c1">#extract of the data</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>                    <span class="k">if</span> <span class="n">old_utxo_account</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>                        <span class="c1">#logging.info(f&quot;###### current_master_state:{self.current_master_state}&quot;)</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>                        <span class="n">account_dic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">old_utxo_account</span><span class="p">]</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>                        <span class="k">if</span> <span class="n">account_dic</span><span class="o">!=</span><span class="p">{}:</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>                            <span class="n">deleted_utxo</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos_data&#39;</span><span class="p">][</span><span class="n">old_utxo_key</span><span class="p">])</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>                            <span class="c1">#logging.info(f&quot;###### deleted_utxo[&#39;output&#39;]1:{deleted_utxo[&#39;output&#39;]}&quot;)</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span><span class="o">-=</span><span class="n">normal_round</span><span class="p">(</span><span class="n">deleted_utxo</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="s1">&#39;amount&#39;</span><span class="p">],</span><span class="n">ROUND_VALUE_DIGIT</span><span class="p">)</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span> <span class="o">!=</span> <span class="n">old_utxo_key</span><span class="p">,</span> <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos&#39;</span><span class="p">]))</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">old_utxo_key</span><span class="p">)</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">old_utxo_account</span><span class="p">]</span><span class="o">=</span><span class="n">account_dic</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**** Transaction5: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>                <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>        <span class="k">if</span> <span class="n">check_marketplace_step2</span><span class="p">(</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;outputs&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>            <span class="c1">#check that there is not more than 2 utxos for marketplace_step2</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>            <span class="n">smart_contract_account</span><span class="o">=</span><span class="n">extract_marketplace_account</span><span class="p">(</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;outputs&#39;</span><span class="p">])</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>            <span class="k">if</span> <span class="n">smart_contract_account</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>                <span class="n">account_dic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">smart_contract_account</span><span class="p">]</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos&#39;</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;###ERROR UPDATE MASTER STATE of SmartContract: </span><span class="si">{</span><span class="n">smart_contract_account</span><span class="si">}</span><span class="s1"> with transaction_hash: </span><span class="si">{</span><span class="n">smart_contract_transaction_hash</span><span class="si">}</span><span class="s1"> More than 2 UTXO for marketplace_step2&#39;</span><span class="p">)</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>            
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>        <span class="c1">#Step 3 update of new UTXO</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>            <span class="n">output_index</span><span class="o">=</span><span class="mi">0</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>            <span class="n">transaction_hash</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;transaction_hash&#39;</span><span class="p">]</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>            <span class="n">timestamp</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>            <span class="n">new_utxo_value_input_list</span><span class="o">=</span><span class="p">[]</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>            <span class="n">account_credit_list</span><span class="o">=</span><span class="p">[]</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>            <span class="n">reputation_acount</span><span class="o">=</span><span class="kc">None</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>            <span class="k">for</span> <span class="n">utxo</span> <span class="ow">in</span> <span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">]:</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>                <span class="n">new_utxo_value_input</span><span class="o">=</span><span class="p">{}</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>                <span class="n">new_utxo_value_input</span><span class="p">[</span><span class="s1">&#39;unlocking_public_key_hash&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;unlocking_public_key_hash&#39;</span><span class="p">]</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>                <span class="c1">#special process Smart Contract</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>                <span class="c1">#when there is &quot;SC&quot; in unlocking_public_key_hash ex: &quot;31f2ac8088005412c7b031a6e342b17a65a48d01 SC f998212b2adc762f114c9ec2b0b2d9bd6c811688</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>                <span class="n">account_credit_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_account_list_from_unlocking_public_key_hash</span><span class="p">(</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;unlocking_public_key_hash&#39;</span><span class="p">]))</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>                <span class="n">new_utxo_value_input</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">]</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>                <span class="n">new_utxo_value_input</span><span class="p">[</span><span class="s1">&#39;transaction_hash&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;transaction_hash&#39;</span><span class="p">]</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>                <span class="n">new_utxo_value_input</span><span class="p">[</span><span class="s1">&#39;output_index&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;output_index&#39;</span><span class="p">]</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>                <span class="n">new_utxo_value_input_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_utxo_value_input</span><span class="p">)</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>            <span class="k">for</span> <span class="n">utxo</span> <span class="ow">in</span> <span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;outputs&#39;</span><span class="p">]:</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>                <span class="c1">#removal of amount in account</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>                <span class="n">new_utxo_key</span><span class="o">=</span><span class="n">transaction_hash</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">output_index</span><span class="p">)</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>                <span class="n">new_utxo_value_output</span><span class="o">=</span><span class="p">{}</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>                <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>                <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;locking_script&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;locking_script&#39;</span><span class="p">]</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>                <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">]</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>                <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;transaction_hash&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">transaction_hash</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>                <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">timestamp</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>                <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;output_index&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">output_index</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>                <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;fee_interface&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;fee_interface&#39;</span><span class="p">]</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>                <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;fee_miner&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;fee_miner&#39;</span><span class="p">]</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>                <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;fee_node&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;fee_node&#39;</span><span class="p">]</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>                <span class="k">try</span><span class="p">:</span><span class="n">marketplace_transaction_flag</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;marketplace_transaction_flag&#39;</span><span class="p">]</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>                <span class="k">except</span><span class="p">:</span><span class="n">marketplace_transaction_flag</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>                <span class="k">try</span><span class="p">:</span><span class="n">smart_contract_transaction_flag</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_transaction_flag&#39;</span><span class="p">]</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>                <span class="k">except</span><span class="p">:</span><span class="n">smart_contract_transaction_flag</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>                <span class="n">account_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_account_list_from_locking_script</span><span class="p">(</span><span class="s2">&quot;OP_SC&quot;</span><span class="p">,</span><span class="n">utxo</span><span class="p">)</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>                <span class="c1">#logging.info(f&quot;====&gt;account_list:{account_list}&quot;)</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>                
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>                <span class="c1">#reputation account management</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>                <span class="k">if</span> <span class="s2">&quot;OP_RE&quot;</span> <span class="ow">in</span> <span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;locking_script&#39;</span><span class="p">]:</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>                    <span class="n">reputation_acount</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_account_list_from_locking_script</span><span class="p">(</span><span class="s2">&quot;OP_SC&quot;</span><span class="p">,</span><span class="n">utxo</span><span class="p">)</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>                    <span class="c1">#logging.info(f&quot;====&gt;reputation_acount1:{reputation_acount}&quot;)</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>                <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;account_list&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">account_list</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>                <span class="n">marketplace_place_step4_flag</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>                <span class="n">marketplace_place_step4_buyer</span><span class="o">=</span><span class="kc">None</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>                <span class="n">marketplace_place_step4_seller</span><span class="o">=</span><span class="kc">None</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>                <span class="n">marketplace_place_step4_requested_amount</span><span class="o">=</span><span class="kc">None</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>                <span class="n">marketplace_place_step4_requested_currency</span><span class="o">=</span><span class="kc">None</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>                <span class="n">marketplace_place_step4</span><span class="o">=</span><span class="mi">0</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>                <span class="n">marketplace_place_step4_requested_nig</span><span class="o">=</span><span class="mi">0</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>                <span class="n">marketplace_place_archiving_flag</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>                    <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_sender&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_sender&#39;</span><span class="p">]</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>                    <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_new&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_new&#39;</span><span class="p">]</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>                    <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_account&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_account&#39;</span><span class="p">]</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>                    <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_flag&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_flag&#39;</span><span class="p">]</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>                    <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_gas&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_gas&#39;</span><span class="p">]</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>                    <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_memory&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_memory&#39;</span><span class="p">]</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>                    <span class="c1">#check if the transaction is in step 4 or 45 (partial payment) or 66 (payment default) or 98 (expiration) or 99 (cancellation) to put in Marketplace_archive if needed</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>                    <span class="n">smart_contract_memory</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_memory&#39;</span><span class="p">]</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">])):</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>                        <span class="k">if</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;step&#39;</span><span class="p">:</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>                            <span class="k">if</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">4</span> <span class="ow">or</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">45</span> <span class="ow">or</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">66</span> <span class="ow">or</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">98</span> <span class="ow">or</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">99</span><span class="p">:</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>                                <span class="n">marketplace_place_step4</span><span class="o">=</span><span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>                                <span class="n">marketplace_place_step4_flag</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>                                <span class="c1">#step = 99 is used to archive the cancelled marketplace request </span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>                                <span class="k">if</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">99</span><span class="p">:</span><span class="n">marketplace_place_archiving_flag</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>                                <span class="c1">#step = 98 is used to archive the expired marketplace request </span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>                                <span class="k">if</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">98</span><span class="p">:</span><span class="n">marketplace_place_archiving_flag</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>                                <span class="c1">#logging.info(f&quot;======&gt; MarketPlace {smart_contract_memory[0][3][j]}: {transaction_hash}&quot;)</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>                        <span class="k">if</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;requested_amount&#39;</span><span class="p">:</span><span class="n">marketplace_place_step4_requested_amount</span><span class="o">=</span><span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>                        <span class="k">if</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;requested_currency&#39;</span><span class="p">:</span><span class="n">marketplace_place_step4_requested_currency</span><span class="o">=</span><span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>                        <span class="k">if</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;buyer_public_key_hash&#39;</span><span class="p">:</span><span class="n">marketplace_place_step4_buyer</span><span class="o">=</span><span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>                        <span class="k">if</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;seller_public_key_hash&#39;</span><span class="p">:</span><span class="n">marketplace_place_step4_seller</span><span class="o">=</span><span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>                        <span class="k">if</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;requested_nig&#39;</span><span class="p">:</span><span class="n">marketplace_place_step4_requested_nig</span><span class="o">=</span><span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>                        
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>                        
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>                    <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_memory_size&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_memory_size&#39;</span><span class="p">]</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>                    <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_type&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_type&#39;</span><span class="p">]</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>                    <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_payload&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_payload&#39;</span><span class="p">]</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>                    <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_result&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_result&#39;</span><span class="p">]</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>                    <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_transaction_hash&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">new_utxo_key</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>                    <span class="k">if</span> <span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_type&#39;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;source&quot;</span><span class="p">:</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>                        <span class="c1">#smart_contract_previous_transaction is only updated with source call</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>                        <span class="k">if</span> <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_new&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span><span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_previous_transaction&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>                        <span class="k">else</span><span class="p">:</span><span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_previous_transaction&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_previous_transaction&#39;</span><span class="p">]</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>                        <span class="c1">#smart_contract_previous_transaction is not updated with API call</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>                        <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_previous_transaction&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_previous_transaction&#39;</span><span class="p">]</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>                    <span class="k">pass</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>                <span class="k">for</span> <span class="n">account</span> <span class="ow">in</span> <span class="n">account_list</span><span class="p">:</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>                        <span class="c1">#there are values for this account, let&#39;s update them</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>                        <span class="n">account_dic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>                        <span class="k">if</span> <span class="n">account_dic</span><span class="o">==</span><span class="p">{}:</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos_data&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;marketplace&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;marketplace_archive&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;reputation&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;smart_contract&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;debit&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>                    <span class="k">except</span><span class="p">:</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>                        <span class="c1">#there is no value for this account, let&#39;s create them</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>                        <span class="n">account_dic</span><span class="o">=</span><span class="p">{}</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>                        <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>                        <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>                        <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>                        <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos_data&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>                        <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;marketplace&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>                        <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;marketplace_archive&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>                        <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;reputation&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>                        <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;smart_contract&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>                        <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>                        <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>                        <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;debit&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>                    
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>                    <span class="k">if</span> <span class="n">marketplace_transaction_flag</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">smart_contract_transaction_flag</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">or</span> <span class="n">account</span><span class="o">==</span><span class="n">account_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>                        <span class="c1">#account==account_list[0] means that it&#39;s the datas of the SmartContract so we need to update the data of the Smart Contract</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>                        <span class="k">if</span> <span class="n">account_dic</span><span class="o">!=</span><span class="p">{}:</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>                            <span class="k">if</span> <span class="n">new_utxo_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos&#39;</span><span class="p">]:</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>                                <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span><span class="o">+=</span><span class="n">normal_round</span><span class="p">(</span><span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">],</span><span class="n">ROUND_VALUE_DIGIT</span><span class="p">)</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>                                <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_utxo_key</span><span class="p">)</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>                                <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos_data&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>                                <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos_data&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">new_utxo_value_output</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>                                <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos_data&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">][</span><span class="s1">&#39;input&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">new_utxo_value_input_list</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>                                <span class="c1">#update of balance</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>                                <span class="k">if</span> <span class="n">old_utxo_key</span><span class="o">==</span><span class="n">account</span><span class="p">:</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>                                    <span class="c1">#try:account_dic[&#39;balance&#39;][&#39;credit&#39;].pop(old_utxo_key)</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>                                    <span class="c1">#except:pass</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>                                    <span class="k">pass</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>                                <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;account_credit_list&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">account_credit_list</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>                                <span class="c1">#if old_utxo_account is not None and old_utxo_account!=account:account_dic[&#39;balance&#39;][&#39;credit&#39;][new_utxo_key]=new_utxo_value_output</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>                                <span class="c1">#if old_utxo_account is not None and old_utxo_account!=account:self.update_old_utxo_key(old_utxo_account,old_utxo_key,account,new_utxo_value_output)</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>                                <span class="c1">#if old_utxo_account!=account:account_dic[&#39;balance&#39;][&#39;credit&#39;][new_utxo_key]=new_utxo_value_output</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>                                <span class="k">try</span><span class="p">:</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>                                    <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_flag&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_flag&#39;</span><span class="p">]</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>                                    <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">]</span><span class="o">=</span><span class="n">new_utxo_value_output</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>                                    <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">][</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>                                <span class="k">except</span><span class="p">:</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>                                    <span class="k">if</span> <span class="n">old_utxo_account</span><span class="o">!=</span><span class="n">account</span><span class="p">:</span><span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">]</span><span class="o">=</span><span class="n">new_utxo_value_output</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>                        
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>                                <span class="k">if</span> <span class="n">old_utxo_account</span><span class="o">!=</span><span class="n">account</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">update_old_utxo_key</span><span class="p">(</span><span class="n">old_utxo_account</span><span class="p">,</span><span class="n">old_utxo_key</span><span class="p">,</span><span class="n">new_utxo_key</span><span class="p">,</span><span class="n">new_utxo_value_output</span><span class="p">)</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>                            
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>                                <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">]</span><span class="o">=</span><span class="n">new_utxo_value_output</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>                                <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">][</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span><span class="o">=</span><span class="n">account_dic</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>                            <span class="k">if</span> <span class="n">marketplace_place_step4_flag</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>                                <span class="c1">#this is transaction fully validated (step 4, 45, 66, 98 or 99)</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>                                <span class="c1">#let&#39;s archive it in the associated account to increase speed</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>                                <span class="k">if</span> <span class="n">marketplace_place_archiving_flag</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span><span class="n">associated_account_dic_step4_list</span><span class="o">=</span><span class="p">[</span><span class="n">marketplace_place_step4_buyer</span><span class="p">,</span><span class="n">marketplace_place_step4_seller</span><span class="p">]</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>                                <span class="k">else</span><span class="p">:</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>                                    <span class="c1">#this is an expired request which needs to be archived</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>                                    <span class="c1">#marketplace_place_step4_seller can be None in that case (ex:if step = 1)</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>                                    <span class="k">if</span> <span class="n">marketplace_place_step4_seller</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">marketplace_place_step4_seller</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span><span class="n">associated_account_dic_step4_list</span><span class="o">=</span><span class="p">[</span><span class="n">marketplace_place_step4_buyer</span><span class="p">]</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>                                    <span class="k">else</span><span class="p">:</span><span class="n">associated_account_dic_step4_list</span><span class="o">=</span><span class="p">[</span><span class="n">marketplace_place_step4_buyer</span><span class="p">,</span><span class="n">marketplace_place_step4_seller</span><span class="p">]</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>                                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;INFO ### associated_account_dic_step4_list:</span><span class="si">{</span><span class="n">associated_account_dic_step4_list</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>                                <span class="n">step</span><span class="o">=</span><span class="mi">0</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>                                <span class="k">for</span> <span class="n">associated_account_dic_step4</span> <span class="ow">in</span> <span class="n">associated_account_dic_step4_list</span><span class="p">:</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>                                    <span class="n">step</span><span class="o">+=</span><span class="mi">1</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>                                    <span class="n">associated_account_dic_step4_to_update</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">associated_account_dic_step4</span><span class="p">]</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>                                    <span class="k">if</span> <span class="n">account_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_archive&#39;</span><span class="p">]:</span><span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_archive&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">account_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>                                    <span class="k">try</span><span class="p">:</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>                                        <span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">account_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>                                        <span class="c1">#update of added value/gain</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>                                        <span class="k">if</span> <span class="n">marketplace_place_step4</span><span class="o">==</span><span class="mi">4</span> <span class="ow">or</span> <span class="n">marketplace_place_step4</span><span class="o">==</span><span class="mi">45</span><span class="p">:</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>                                            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;INFO ### marketplace_place added value&quot;</span><span class="p">)</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>                                            <span class="k">try</span><span class="p">:</span><span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">]</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>                                            <span class="k">except</span><span class="p">:</span><span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>                                            <span class="k">try</span><span class="p">:</span><span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">][</span><span class="n">marketplace_place_step4_requested_currency</span><span class="p">]</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>                                            <span class="k">except</span><span class="p">:</span><span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">][</span><span class="n">marketplace_place_step4_requested_currency</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>                                            <span class="k">if</span> <span class="n">step</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>                                                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;INFO ### marketplace_place added value buyer&quot;</span><span class="p">)</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>                                                <span class="c1">#this is the buyer</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>                                                <span class="k">try</span><span class="p">:</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>                                                    <span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">][</span><span class="n">marketplace_place_step4_requested_currency</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">]</span><span class="o">+=</span><span class="n">marketplace_place_step4_requested_amount</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>                                                    <span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">][</span><span class="n">marketplace_place_step4_requested_currency</span><span class="p">][</span><span class="s1">&#39;credit_nig&#39;</span><span class="p">]</span><span class="o">+=</span><span class="n">normal_round</span><span class="p">(</span><span class="n">marketplace_place_step4_requested_nig</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">DEFAULT_TRANSACTION_FEE_PERCENTAGE</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">),</span><span class="n">ROUND_VALUE_DIGIT</span><span class="p">)</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>                                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>                                                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;####CHECK1###&quot;</span><span class="p">)</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>                                                    <span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">][</span><span class="n">marketplace_place_step4_requested_currency</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">marketplace_place_step4_requested_amount</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>                                                    <span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">][</span><span class="n">marketplace_place_step4_requested_currency</span><span class="p">][</span><span class="s1">&#39;credit_nig&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">normal_round</span><span class="p">(</span><span class="n">marketplace_place_step4_requested_nig</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">DEFAULT_TRANSACTION_FEE_PERCENTAGE</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">),</span><span class="n">ROUND_VALUE_DIGIT</span><span class="p">)</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>                                            <span class="k">if</span> <span class="n">step</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>                                                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;INFO ### marketplace_place added value seller&quot;</span><span class="p">)</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>                                                <span class="c1">#this is the seller</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>                                                <span class="k">try</span><span class="p">:</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>                                                    <span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">][</span><span class="n">marketplace_place_step4_requested_currency</span><span class="p">][</span><span class="s1">&#39;debit&#39;</span><span class="p">]</span><span class="o">+=</span><span class="n">marketplace_place_step4_requested_amount</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>                                                    <span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">][</span><span class="n">marketplace_place_step4_requested_currency</span><span class="p">][</span><span class="s1">&#39;debit_nig&#39;</span><span class="p">]</span><span class="o">+=</span><span class="n">marketplace_place_step4_requested_nig</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>                                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>                                                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;####CHECK2###&quot;</span><span class="p">)</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>                                                    <span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">][</span><span class="n">marketplace_place_step4_requested_currency</span><span class="p">][</span><span class="s1">&#39;debit&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">marketplace_place_step4_requested_amount</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>                                                    <span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">][</span><span class="n">marketplace_place_step4_requested_currency</span><span class="p">][</span><span class="s1">&#39;debit_nig&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">marketplace_place_step4_requested_nig</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>                                            <span class="k">try</span><span class="p">:</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>                                                <span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">account_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>                                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>                                                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;marketplace_place_step4 removal issue with account: </span><span class="si">{</span><span class="n">account_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>                                                <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>                                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>                                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;marketplace_place_step4 removal issue with account: </span><span class="si">{</span><span class="n">account_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>                                        <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>                                    
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>                                    <span class="n">data1</span><span class="o">=</span><span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace&#39;</span><span class="p">]</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>                                    <span class="n">data2</span><span class="o">=</span><span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_archive&#39;</span><span class="p">]</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>                                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;======&gt; associated_account_dic_step4: </span><span class="si">{</span><span class="n">associated_account_dic_step4</span><span class="si">}</span><span class="s2"> account_dic[&#39;marketplace&#39;]: </span><span class="si">{</span><span class="n">data1</span><span class="si">}</span><span class="s2"> account_dic[&#39;marketplace_archive&#39;] :</span><span class="si">{</span><span class="n">data2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>                                    <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">associated_account_dic_step4</span><span class="p">]</span><span class="o">=</span><span class="n">associated_account_dic_step4_to_update</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>                                    
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>                                    
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span><span class="o">+=</span><span class="n">normal_round</span><span class="p">(</span><span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">],</span><span class="n">ROUND_VALUE_DIGIT</span><span class="p">)</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_utxo_key</span><span class="p">)</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos_data&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos_data&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">new_utxo_value_output</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos_data&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">][</span><span class="s1">&#39;input&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">new_utxo_value_input_list</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>                            <span class="c1">#update of balance</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>                            <span class="k">if</span> <span class="n">old_utxo_key</span><span class="o">==</span><span class="n">account</span><span class="p">:</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>                                <span class="c1">#try:account_dic[&#39;balance&#39;][&#39;credit&#39;].pop(old_utxo_key)</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>                                <span class="c1">#except:pass</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>                                <span class="k">pass</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a>                            <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;account_credit_list&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">account_credit_list</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a>                            <span class="c1">#if old_utxo_account is not None and old_utxo_account!=account:account_dic[&#39;balance&#39;][&#39;credit&#39;][new_utxo_key]=new_utxo_value_output</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a>                            <span class="c1">#if old_utxo_account is not None and old_utxo_account!=account:self.update_old_utxo_key(old_utxo_account,old_utxo_key,new_utxo_key,new_utxo_value_output)</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a>                            <span class="c1">#if old_utxo_account!=account:account_dic[&#39;balance&#39;][&#39;credit&#39;][new_utxo_key]=new_utxo_value_output</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a>                        
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a>                            <span class="k">try</span><span class="p">:</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a>                                <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_flag&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_flag&#39;</span><span class="p">]</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a>                                <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">]</span><span class="o">=</span><span class="n">new_utxo_value_output</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a>                                <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">][</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a>                            <span class="k">except</span><span class="p">:</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>                                <span class="k">if</span> <span class="n">old_utxo_account</span><span class="o">!=</span><span class="n">account</span><span class="p">:</span><span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">]</span><span class="o">=</span><span class="n">new_utxo_value_output</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>                        
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a>                            <span class="k">if</span> <span class="n">old_utxo_account</span><span class="o">!=</span><span class="n">account</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">update_old_utxo_key</span><span class="p">(</span><span class="n">old_utxo_account</span><span class="p">,</span><span class="n">old_utxo_key</span><span class="p">,</span><span class="n">new_utxo_key</span><span class="p">,</span><span class="n">new_utxo_value_output</span><span class="p">)</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">]</span><span class="o">=</span><span class="n">new_utxo_value_output</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">][</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span><span class="o">=</span><span class="n">account_dic</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>                        <span class="c1">#account_list[0] is the Smart Contract account</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>                        <span class="c1">#account_list[1 and + ] are the other account associated to that Smart Contrat</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>                        <span class="k">if</span> <span class="n">marketplace_transaction_flag</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">marketplace_place_step4_flag</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>                            <span class="c1">#this is a marketplace transaction</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a>                            <span class="k">if</span> <span class="n">account_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;marketplace&#39;</span><span class="p">]:</span><span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;marketplace&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">account_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>                        <span class="k">elif</span> <span class="n">smart_contract_transaction_flag</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>                            <span class="c1">#this is a smart contract transaction</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>                            <span class="k">if</span> <span class="n">account_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;smart_contract&#39;</span><span class="p">]:</span><span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;smart_contract&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">account_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>                        <span class="c1">#reputation_acount management</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>                        <span class="c1">#logging.info(f&quot;====&gt;reputation_acount2:{reputation_acount}&quot;)</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>                        <span class="k">if</span> <span class="n">reputation_acount</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;reputation&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">reputation_acount</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>                            <span class="k">try</span><span class="p">:</span><span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;smart_contract&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">reputation_acount</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>                            <span class="k">except</span><span class="p">:</span><span class="k">pass</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span><span class="o">=</span><span class="n">account_dic</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>                <span class="c1">#Removal of association between some account and this SmartContract</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>                <span class="n">account_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_account_list_from_locking_script</span><span class="p">(</span><span class="s2">&quot;OP_DEL_SC&quot;</span><span class="p">,</span><span class="n">utxo</span><span class="p">)</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>                <span class="k">for</span> <span class="n">account</span> <span class="ow">in</span> <span class="n">account_list</span><span class="p">:</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>                    <span class="n">smart_contract_account</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s2">&quot;smart_contract_account&quot;</span><span class="p">]</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>                    <span class="n">account_2_remove_dic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>                    <span class="k">if</span> <span class="n">smart_contract_account</span> <span class="ow">in</span> <span class="n">account_2_remove_dic</span><span class="p">[</span><span class="s1">&#39;marketplace&#39;</span><span class="p">]:</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>                        <span class="n">account_2_remove_dic</span><span class="p">[</span><span class="s1">&#39;marketplace&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">smart_contract_account</span><span class="p">)</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span><span class="o">=</span><span class="n">account_2_remove_dic</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>                    <span class="c1">#FYI, transaction are never removed from marketplace_archive to keep tracked</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a>                    
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a>                <span class="n">output_index</span><span class="o">+=</span><span class="mi">1</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>            
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**** Transaction6: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>        <span class="c1">#Step 4 update of balance</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>    <span class="k">def</span> <span class="nf">update_old_utxo_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">old_utxo_account</span><span class="p">,</span><span class="n">old_utxo_key</span><span class="p">,</span><span class="n">new_utxo_key</span><span class="p">,</span><span class="n">new_utxo_value_output</span><span class="p">):</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a>        <span class="k">if</span> <span class="n">old_utxo_account</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">old_utxo_account</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">old_utxo_account</span><span class="p">][</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;debit&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">]</span><span class="o">=</span><span class="n">new_utxo_value_output</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a>                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**** Transaction7: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a>                <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a>    
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a>    <span class="k">def</span> <span class="nf">store_master_state_in_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">BlockPoH</span><span class="p">):</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;to store the transaction in a file =&gt;store_master_state_in_memory</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a>            <span class="c1">#logging.info(f&quot;**** self.current_master_state.keys(): {self.current_master_state.keys():}&quot;)</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a>            <span class="k">for</span> <span class="n">account</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a>                <span class="n">new_master_state</span><span class="o">=</span><span class="p">{}</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a>                <span class="n">current_master_state</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a>                <span class="n">new_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a>                <span class="c1">#saving the file</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporary_save_flag</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a>                    <span class="c1">#on a temporary file for LeaderNode</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a>                    <span class="n">temporary_file_master_state_raw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temporary_storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a>                    <span class="k">if</span> <span class="n">temporary_file_master_state_raw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a>                        <span class="k">try</span><span class="p">:</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a>                            <span class="n">temporary_file_master_state_raw</span><span class="p">[</span><span class="n">BlockPoH</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a>                        <span class="k">except</span><span class="p">:</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a>                            <span class="n">temporary_file_master_state_raw</span><span class="o">=</span><span class="p">{}</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a>                            <span class="n">temporary_file_master_state_raw</span><span class="p">[</span><span class="n">BlockPoH</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a>                        <span class="n">temporary_file_master_state_raw</span><span class="o">=</span><span class="p">{}</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a>                        <span class="n">temporary_file_master_state_raw</span><span class="p">[</span><span class="n">BlockPoH</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">temporary_storage_sharding</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">account</span><span class="p">,</span><span class="n">temporary_file_master_state_raw</span><span class="p">)</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a>                    <span class="c1">#logging.info(f&quot;**** account: {account} ==&gt; new_master_state:{new_master_state[account]}&quot;)</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">storage_sharding</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">account</span><span class="p">,</span><span class="n">new_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">])</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**** Transaction8: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a>    <span class="k">def</span> <span class="nf">delete_TempBlockPoH</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">transaction</span><span class="p">):</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;to delete TempBlockPoH associated to the Transaction </span>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a><span class="sd">        at the end of the block creation</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a>        <span class="n">account_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_account_list_transaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a>        <span class="c1">#logging.info(f&quot;**** account_list: {account_list}&quot;)</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a>        <span class="k">for</span> <span class="n">account</span> <span class="ow">in</span> <span class="n">account_list</span><span class="p">:</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a>            <span class="n">temporary_file_master_state_raw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temporary_storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a>            <span class="k">if</span> <span class="n">temporary_file_master_state_raw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a>                    <span class="c1">#logging.info(f&quot;**** temporary_file_master_state_raw: {type(temporary_file_master_state_raw)} {temporary_file_master_state_raw}&quot;)</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a>                    <span class="n">temporary_file_master_state_raw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;TempBlockPoH&quot;</span><span class="p">)</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">temporary_storage_sharding</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">account</span><span class="p">,</span><span class="n">temporary_file_master_state_raw</span><span class="p">)</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a>                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**** Transaction9: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a>                    <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a>    <span class="k">def</span> <span class="nf">clean_temporary_file_master_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">transaction</span><span class="p">,</span><span class="n">BlockPoH</span><span class="p">,</span><span class="n">master_state_readiness</span><span class="p">):</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;to delete the transaction in the temporary_file_master</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a>        <span class="n">account_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_account_list_transaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a>        <span class="k">for</span> <span class="n">account</span> <span class="ow">in</span> <span class="n">account_list</span><span class="p">:</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a>            <span class="n">temporary_file_master_state_raw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temporary_storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a>            <span class="k">if</span> <span class="n">temporary_file_master_state_raw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a>                    <span class="n">temporary_file_master_state_raw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">BlockPoH</span><span class="p">)</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a>                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**** Transaction10: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a>                    <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a>                <span class="k">if</span> <span class="n">temporary_file_master_state_raw</span><span class="o">==</span><span class="p">{}:</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a>                    <span class="c1">#the file is empty, let&#39;s delete it</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">temporary_storage_sharding</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">account</span><span class="p">,</span><span class="n">master_state_readiness</span><span class="p">)</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">temporary_storage_sharding</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">account</span><span class="p">,</span><span class="n">temporary_file_master_state_raw</span><span class="p">)</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a>
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a>    <span class="k">def</span> <span class="nf">extract_account_list_from_locking_script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">op_elem</span><span class="p">,</span><span class="n">utxo</span><span class="p">):</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a>        <span class="n">account_list</span><span class="o">=</span><span class="p">[]</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a>        <span class="n">op_elem_account_list</span><span class="o">=</span><span class="p">[]</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a>        <span class="n">locking_script</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;locking_script&#39;</span><span class="p">]</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a>        <span class="n">locking_script_list</span> <span class="o">=</span> <span class="n">locking_script</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a>        <span class="c1">#list of op_elem</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a>        <span class="c1"># =&gt;OP_SC is used to associate an account to a SmartContract</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos">644</span></a>        <span class="c1"># =&gt;OP_DEL_SC is used to deassociate an account from a SmartContract</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos">645</span></a>        <span class="c1">#ex: OP_DUP OP_HASH160 31f2ac8088005412c7b031a6e342b17a65a48d01 OP_EQUAL_VERIFY OP_CHECKSIG OP_SC 47866ef83717f16c24cb246deeef1f75f798b8e5 </span>
</span><span id="L-646"><a href="#L-646"><span class="linenos">646</span></a>        <span class="c1">##OP_SC 531c2e528bd177866f7213b192833846018686e5 OP_DEL_SC 3243223324GFDG</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos">647</span></a>        <span class="n">flag_for_adding</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos">648</span></a>        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">locking_script_list</span><span class="p">:</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos">649</span></a>            <span class="c1">#Step 1 list of account when there is no specific OP like OP_SC, OP_DEL_SC</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos">650</span></a>            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;OP&quot;</span><span class="p">):</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos">651</span></a>                <span class="k">pass</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos">652</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos">653</span></a>                <span class="k">if</span> <span class="n">element</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">account_list</span><span class="p">:</span><span class="n">account_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos">654</span></a>            <span class="c1">#Step 2 list for specific OP like OP_SC, OP_DEL_SC</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos">655</span></a>            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">op_elem</span><span class="p">):</span><span class="n">flag_for_adding</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos">656</span></a>            <span class="k">elif</span> <span class="n">flag_for_adding</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos">657</span></a>                <span class="k">if</span> <span class="n">element</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">op_elem_account_list</span><span class="p">:</span><span class="n">op_elem_account_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos">658</span></a>                <span class="n">flag_for_adding</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos">659</span></a>        
</span><span id="L-660"><a href="#L-660"><span class="linenos">660</span></a>        <span class="k">if</span> <span class="n">op_elem_account_list</span><span class="o">!=</span><span class="p">[]:</span><span class="k">return</span> <span class="n">op_elem_account_list</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos">661</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos">662</span></a>            <span class="k">if</span> <span class="n">op_elem</span><span class="o">==</span><span class="s2">&quot;OP_DEL_SC&quot;</span><span class="p">:</span><span class="k">return</span> <span class="p">[]</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos">663</span></a>            <span class="k">else</span><span class="p">:</span><span class="k">return</span> <span class="n">account_list</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos">664</span></a>
</span><span id="L-665"><a href="#L-665"><span class="linenos">665</span></a>    <span class="k">def</span> <span class="nf">extract_account_list_from_unlocking_public_key_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">utxo_account</span><span class="p">):</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos">666</span></a>        <span class="c1">#special process Smart Contract</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos">667</span></a>        <span class="c1">#when there is &quot;SC&quot; in unlocking_public_key_hash ex: &quot;31f2ac8088005412c7b031a6e342b17a65a48d01 SC f998212b2adc762f114c9ec2b0b2d9bd6c811688</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos">668</span></a>        <span class="n">new_utxo_account</span><span class="o">=</span><span class="n">utxo_account</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos">669</span></a>        <span class="k">if</span> <span class="n">utxo_account</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;SC &quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos">670</span></a>            <span class="n">new_utxo_account</span><span class="o">=</span><span class="n">utxo_account</span><span class="p">[</span><span class="n">utxo_account</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;SC &quot;</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">utxo_account</span><span class="p">)]</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos">671</span></a>        <span class="k">return</span> <span class="n">new_utxo_account</span>
</span></pre></div>


            </section>
                <section id="MasterState">
                            <input id="MasterState-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">MasterState</span>:

                <label class="view-source-button" for="MasterState-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MasterState"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MasterState-14"><a href="#MasterState-14"><span class="linenos"> 14</span></a><span class="k">class</span> <span class="nc">MasterState</span><span class="p">:</span>
</span><span id="MasterState-15"><a href="#MasterState-15"><span class="linenos"> 15</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MasterState-16"><a href="#MasterState-16"><span class="linenos"> 16</span></a><span class="sd">    Class to manage the state of each NIG account including SmartContract. </span>
</span><span id="MasterState-17"><a href="#MasterState-17"><span class="linenos"> 17</span></a><span class="sd">    Each state of account is stored in an unique file.</span>
</span><span id="MasterState-18"><a href="#MasterState-18"><span class="linenos"> 18</span></a><span class="sd">    It&#39;s faster than reading all the transactions associated to an account in the blockchain.</span>
</span><span id="MasterState-19"><a href="#MasterState-19"><span class="linenos"> 19</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="MasterState-20"><a href="#MasterState-20"><span class="linenos"> 20</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="MasterState-21"><a href="#MasterState-21"><span class="linenos"> 21</span></a>        <span class="kn">from</span> <span class="nn">common.values</span> <span class="kn">import</span> <span class="n">MASTER_STATE_DIR</span><span class="p">,</span><span class="n">MASTER_STATE_DEEPTH</span><span class="p">,</span><span class="n">MASTER_STATE_DIR_TEMP</span>
</span><span id="MasterState-22"><a href="#MasterState-22"><span class="linenos"> 22</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState-23"><a href="#MasterState-23"><span class="linenos"> 23</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">temporary_save_flag</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;temporary_save_flag&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MasterState-24"><a href="#MasterState-24"><span class="linenos"> 24</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">advance_save_flag</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;advance_save_flag&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MasterState-25"><a href="#MasterState-25"><span class="linenos"> 25</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">store_block_in_blockchain_in_memory_flag</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;store_block_in_blockchain_in_memory_flag&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MasterState-26"><a href="#MasterState-26"><span class="linenos"> 26</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">storage_sharding</span><span class="o">=</span><span class="n">StorageSharding</span><span class="p">(</span><span class="n">MASTER_STATE_DIR</span><span class="p">,</span><span class="n">deepth</span><span class="o">=</span><span class="n">MASTER_STATE_DEEPTH</span><span class="p">)</span>
</span><span id="MasterState-27"><a href="#MasterState-27"><span class="linenos"> 27</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">temporary_storage_sharding</span><span class="o">=</span><span class="n">StorageSharding</span><span class="p">(</span><span class="n">MASTER_STATE_DIR_TEMP</span><span class="p">,</span><span class="n">deepth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="MasterState-28"><a href="#MasterState-28"><span class="linenos"> 28</span></a>
</span><span id="MasterState-29"><a href="#MasterState-29"><span class="linenos"> 29</span></a>    <span class="k">def</span> <span class="nf">get_master_state_from_memory_from_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">transactions</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="MasterState-30"><a href="#MasterState-30"><span class="linenos"> 30</span></a>        <span class="n">block_PoH</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;block_PoH&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
</span><span id="MasterState-31"><a href="#MasterState-31"><span class="linenos"> 31</span></a>        <span class="n">leader_node_flag</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;leader_node_flag&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MasterState-32"><a href="#MasterState-32"><span class="linenos"> 32</span></a>        <span class="c1">#logging.info(f&quot;==&gt;block_PoH1:{block_PoH}&quot;)</span>
</span><span id="MasterState-33"><a href="#MasterState-33"><span class="linenos"> 33</span></a>        <span class="n">previous_PoH_hash</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;previous_PoH_hash&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
</span><span id="MasterState-34"><a href="#MasterState-34"><span class="linenos"> 34</span></a>        <span class="n">NIGthreading_flag</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;NIGthreading_flag&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MasterState-35"><a href="#MasterState-35"><span class="linenos"> 35</span></a>        <span class="c1">#logging.info(&quot;Getting master state from memory for a transaction&quot;)</span>
</span><span id="MasterState-36"><a href="#MasterState-36"><span class="linenos"> 36</span></a>        <span class="n">account_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_account_list_transaction</span><span class="p">(</span><span class="n">transactions</span><span class="p">)</span>
</span><span id="MasterState-37"><a href="#MasterState-37"><span class="linenos"> 37</span></a>        <span class="c1">#logging.info(f&quot;==&gt;account_list:{account_list}&quot;)</span>
</span><span id="MasterState-38"><a href="#MasterState-38"><span class="linenos"> 38</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;==&gt;transactions:</span><span class="si">{</span><span class="n">transactions</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="MasterState-39"><a href="#MasterState-39"><span class="linenos"> 39</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">get_master_state_from_memory_from_account_list</span><span class="p">(</span><span class="n">account_list</span><span class="p">,</span><span class="n">block_PoH</span><span class="o">=</span><span class="n">block_PoH</span><span class="p">,</span><span class="n">previous_PoH_hash</span><span class="o">=</span><span class="n">previous_PoH_hash</span><span class="p">,</span><span class="n">leader_node_flag</span><span class="o">=</span><span class="n">leader_node_flag</span><span class="p">,</span><span class="n">NIGthreading_flag</span><span class="o">=</span><span class="n">NIGthreading_flag</span><span class="p">)</span>
</span><span id="MasterState-40"><a href="#MasterState-40"><span class="linenos"> 40</span></a>
</span><span id="MasterState-41"><a href="#MasterState-41"><span class="linenos"> 41</span></a>    <span class="k">def</span> <span class="nf">get_account_list_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">transactions</span><span class="p">):</span>
</span><span id="MasterState-42"><a href="#MasterState-42"><span class="linenos"> 42</span></a>        <span class="n">account_list</span><span class="o">=</span><span class="p">[]</span>
</span><span id="MasterState-43"><a href="#MasterState-43"><span class="linenos"> 43</span></a>        <span class="c1">#logging.info(f&quot;####transactions55:{transactions}&quot;)</span>
</span><span id="MasterState-44"><a href="#MasterState-44"><span class="linenos"> 44</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState-45"><a href="#MasterState-45"><span class="linenos"> 45</span></a>            <span class="c1">#account_list.append(transactions[&#39;inputs&#39;][0][&#39;transaction_hash&#39;]+&#39;_&#39;+str(transactions[&#39;inputs&#39;][0][&#39;output_index&#39;]))</span>
</span><span id="MasterState-46"><a href="#MasterState-46"><span class="linenos"> 46</span></a>            <span class="k">for</span> <span class="n">utxo</span> <span class="ow">in</span> <span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;outputs&#39;</span><span class="p">]:</span>
</span><span id="MasterState-47"><a href="#MasterState-47"><span class="linenos"> 47</span></a>                <span class="n">test1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_account_list_from_locking_script</span><span class="p">(</span><span class="s2">&quot;OP_SC&quot;</span><span class="p">,</span><span class="n">utxo</span><span class="p">)</span>
</span><span id="MasterState-48"><a href="#MasterState-48"><span class="linenos"> 48</span></a>                <span class="n">test2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_account_list_from_locking_script</span><span class="p">(</span><span class="s2">&quot;OP_DEL_SC&quot;</span><span class="p">,</span><span class="n">utxo</span><span class="p">)</span>
</span><span id="MasterState-49"><a href="#MasterState-49"><span class="linenos"> 49</span></a>                <span class="c1">#logging.info(f&quot;####OP_SC:{test1}&quot;)</span>
</span><span id="MasterState-50"><a href="#MasterState-50"><span class="linenos"> 50</span></a>                <span class="c1">#logging.info(f&quot;####OP_DEL_SC:{test2}&quot;)</span>
</span><span id="MasterState-51"><a href="#MasterState-51"><span class="linenos"> 51</span></a>                <span class="n">account_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_account_list_from_locking_script</span><span class="p">(</span><span class="s2">&quot;OP_SC&quot;</span><span class="p">,</span><span class="n">utxo</span><span class="p">))</span>
</span><span id="MasterState-52"><a href="#MasterState-52"><span class="linenos"> 52</span></a>                <span class="n">account_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_account_list_from_locking_script</span><span class="p">(</span><span class="s2">&quot;OP_DEL_SC&quot;</span><span class="p">,</span><span class="n">utxo</span><span class="p">))</span>
</span><span id="MasterState-53"><a href="#MasterState-53"><span class="linenos"> 53</span></a>            <span class="k">for</span> <span class="n">inputs</span> <span class="ow">in</span> <span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">]:</span>
</span><span id="MasterState-54"><a href="#MasterState-54"><span class="linenos"> 54</span></a>                <span class="n">new_account</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_account_list_from_unlocking_public_key_hash</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;unlocking_public_key_hash&#39;</span><span class="p">])</span>
</span><span id="MasterState-55"><a href="#MasterState-55"><span class="linenos"> 55</span></a>                <span class="k">if</span> <span class="n">new_account</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">account_list</span><span class="p">:</span><span class="n">account_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_account</span><span class="p">)</span>
</span><span id="MasterState-56"><a href="#MasterState-56"><span class="linenos"> 56</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="MasterState-57"><a href="#MasterState-57"><span class="linenos"> 57</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**** Transaction2: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="MasterState-58"><a href="#MasterState-58"><span class="linenos"> 58</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="MasterState-59"><a href="#MasterState-59"><span class="linenos"> 59</span></a>        <span class="k">return</span> <span class="n">account_list</span>
</span><span id="MasterState-60"><a href="#MasterState-60"><span class="linenos"> 60</span></a>
</span><span id="MasterState-61"><a href="#MasterState-61"><span class="linenos"> 61</span></a>    <span class="k">def</span> <span class="nf">get_master_state_from_memory_from_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">user</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="MasterState-62"><a href="#MasterState-62"><span class="linenos"> 62</span></a>        <span class="n">block_PoH</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;block_PoH&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
</span><span id="MasterState-63"><a href="#MasterState-63"><span class="linenos"> 63</span></a>        <span class="n">leader_node_flag</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;leader_node_flag&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MasterState-64"><a href="#MasterState-64"><span class="linenos"> 64</span></a>        <span class="n">NIGthreading_flag</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;NIGthreading_flag&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MasterState-65"><a href="#MasterState-65"><span class="linenos"> 65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">get_master_state_from_memory_from_account_list</span><span class="p">([</span><span class="n">user</span><span class="p">],</span><span class="n">block_PoH</span><span class="o">=</span><span class="n">block_PoH</span><span class="p">,</span><span class="n">leader_node_flag</span><span class="o">=</span><span class="n">leader_node_flag</span><span class="p">,</span><span class="n">NIGthreading_flag</span><span class="o">=</span><span class="n">NIGthreading_flag</span><span class="p">)</span>
</span><span id="MasterState-66"><a href="#MasterState-66"><span class="linenos"> 66</span></a>        
</span><span id="MasterState-67"><a href="#MasterState-67"><span class="linenos"> 67</span></a>    <span class="k">def</span> <span class="nf">get_master_state_from_memory_from_account_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">account_list</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="MasterState-68"><a href="#MasterState-68"><span class="linenos"> 68</span></a>        <span class="n">block_PoH</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;block_PoH&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
</span><span id="MasterState-69"><a href="#MasterState-69"><span class="linenos"> 69</span></a>        <span class="n">leader_node_flag</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;leader_node_flag&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MasterState-70"><a href="#MasterState-70"><span class="linenos"> 70</span></a>        <span class="n">NIGthreading_flag</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;NIGthreading_flag&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MasterState-71"><a href="#MasterState-71"><span class="linenos"> 71</span></a>        <span class="n">previous_PoH_hash</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;previous_PoH_hash&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
</span><span id="MasterState-72"><a href="#MasterState-72"><span class="linenos"> 72</span></a>        <span class="c1">#previous_PoH_hash is used by leaderNode to reference the previous block which is stored in the memory</span>
</span><span id="MasterState-73"><a href="#MasterState-73"><span class="linenos"> 73</span></a>        <span class="c1">#as the new block is not yet saved in the memory</span>
</span><span id="MasterState-74"><a href="#MasterState-74"><span class="linenos"> 74</span></a>        
</span><span id="MasterState-75"><a href="#MasterState-75"><span class="linenos"> 75</span></a>        <span class="c1">#logging.info(f&quot;==&gt;account_list:{account_list}&quot;)</span>
</span><span id="MasterState-76"><a href="#MasterState-76"><span class="linenos"> 76</span></a>        <span class="c1">#STEP 1 retrieval of the last_block_pointer block_PoH</span>
</span><span id="MasterState-77"><a href="#MasterState-77"><span class="linenos"> 77</span></a>        <span class="kn">from</span> <span class="nn">common.io_blockchain</span> <span class="kn">import</span> <span class="n">BlockchainMemory</span>
</span><span id="MasterState-78"><a href="#MasterState-78"><span class="linenos"> 78</span></a>        <span class="n">blockchain_memory</span> <span class="o">=</span> <span class="n">BlockchainMemory</span><span class="p">()</span>
</span><span id="MasterState-79"><a href="#MasterState-79"><span class="linenos"> 79</span></a>
</span><span id="MasterState-80"><a href="#MasterState-80"><span class="linenos"> 80</span></a>        <span class="c1">#STEP 2 Retrievel of the last block_PoH in consensus_blockchain ONLY for temporary_storage_sharding</span>
</span><span id="MasterState-81"><a href="#MasterState-81"><span class="linenos"> 81</span></a>        <span class="k">if</span> <span class="n">block_PoH</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">block_PoH</span><span class="o">!=</span><span class="s2">&quot;TempBlockPoH&quot;</span> <span class="ow">and</span> <span class="n">block_PoH</span><span class="o">!=</span><span class="s2">&quot;add_in_blockchain&quot;</span><span class="p">:</span>
</span><span id="MasterState-82"><a href="#MasterState-82"><span class="linenos"> 82</span></a>            <span class="c1">#let&#39;s retrieve the last received block of the blockchain belonging to that block_PoH</span>
</span><span id="MasterState-83"><a href="#MasterState-83"><span class="linenos"> 83</span></a>            <span class="c1">#to ensure that the MasterState is up to date</span>
</span><span id="MasterState-84"><a href="#MasterState-84"><span class="linenos"> 84</span></a>            <span class="c1">#ONLY for temporary_storage_sharding (self.temporary_save_flag=True)</span>
</span><span id="MasterState-85"><a href="#MasterState-85"><span class="linenos"> 85</span></a>            <span class="kn">from</span> <span class="nn">common.consensus_blockchain</span> <span class="kn">import</span> <span class="n">consensus_blockchain</span>
</span><span id="MasterState-86"><a href="#MasterState-86"><span class="linenos"> 86</span></a>            <span class="c1">#logging.info(f&quot;### CHANGE OF block_PoH:w{block_PoH}&quot;)</span>
</span><span id="MasterState-87"><a href="#MasterState-87"><span class="linenos"> 87</span></a>            <span class="k">for</span> <span class="n">backlog_chain_list_counter</span> <span class="ow">in</span> <span class="n">consensus_blockchain</span><span class="o">.</span><span class="n">backlog_chain_list</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="MasterState-88"><a href="#MasterState-88"><span class="linenos"> 88</span></a>                <span class="k">if</span> <span class="n">block_PoH</span> <span class="ow">in</span> <span class="n">consensus_blockchain</span><span class="o">.</span><span class="n">backlog_chain_list</span><span class="p">[</span><span class="n">backlog_chain_list_counter</span><span class="p">][</span><span class="s1">&#39;list&#39;</span><span class="p">]:</span>
</span><span id="MasterState-89"><a href="#MasterState-89"><span class="linenos"> 89</span></a>                    <span class="n">block_PoH</span><span class="o">=</span><span class="n">consensus_blockchain</span><span class="o">.</span><span class="n">backlog_chain_list</span><span class="p">[</span><span class="n">backlog_chain_list_counter</span><span class="p">][</span><span class="s1">&#39;last&#39;</span><span class="p">]</span>
</span><span id="MasterState-90"><a href="#MasterState-90"><span class="linenos"> 90</span></a>                    <span class="k">break</span>
</span><span id="MasterState-91"><a href="#MasterState-91"><span class="linenos"> 91</span></a>            <span class="c1">#logging.info(f&quot;### NEW block_PoH:{block_PoH}&quot;)</span>
</span><span id="MasterState-92"><a href="#MasterState-92"><span class="linenos"> 92</span></a>
</span><span id="MasterState-93"><a href="#MasterState-93"><span class="linenos"> 93</span></a>        <span class="c1">#STEP 2 retrieval of the block with the block_PoH</span>
</span><span id="MasterState-94"><a href="#MasterState-94"><span class="linenos"> 94</span></a>        <span class="k">if</span> <span class="n">block_PoH</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">block_PoH</span><span class="o">==</span><span class="s2">&quot;TempBlockPoH&quot;</span> <span class="ow">and</span> <span class="n">block_PoH</span><span class="o">!=</span><span class="s2">&quot;add_in_blockchain&quot;</span><span class="p">:</span>
</span><span id="MasterState-95"><a href="#MasterState-95"><span class="linenos"> 95</span></a>            <span class="n">block_PoH</span><span class="o">=</span><span class="n">blockchain_memory</span><span class="o">.</span><span class="n">backlog_storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;last_block_pointer&quot;</span><span class="p">)</span>
</span><span id="MasterState-96"><a href="#MasterState-96"><span class="linenos"> 96</span></a>            <span class="k">if</span> <span class="n">block_PoH</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span><span class="n">block_PoH</span><span class="o">=</span><span class="n">blockchain_memory</span><span class="o">.</span><span class="n">storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;last_block_pointer&quot;</span><span class="p">)</span>
</span><span id="MasterState-97"><a href="#MasterState-97"><span class="linenos"> 97</span></a>        <span class="k">elif</span> <span class="n">block_PoH</span><span class="o">==</span><span class="s2">&quot;add_in_blockchain&quot;</span><span class="p">:</span>
</span><span id="MasterState-98"><a href="#MasterState-98"><span class="linenos"> 98</span></a>            <span class="c1">#specific process when adding a new block in the BlockChain</span>
</span><span id="MasterState-99"><a href="#MasterState-99"><span class="linenos"> 99</span></a>            <span class="n">block_PoH</span><span class="o">=</span><span class="n">blockchain_memory</span><span class="o">.</span><span class="n">storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;last_block_pointer&quot;</span><span class="p">)</span>
</span><span id="MasterState-100"><a href="#MasterState-100"><span class="linenos">100</span></a>        <span class="n">blockchain_block_PoH</span><span class="o">=</span><span class="n">blockchain_memory</span><span class="o">.</span><span class="n">storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;last_block_pointer&quot;</span><span class="p">)</span>
</span><span id="MasterState-101"><a href="#MasterState-101"><span class="linenos">101</span></a>        <span class="n">block_PoH_chain_list</span><span class="o">=</span><span class="p">[</span><span class="n">block_PoH</span><span class="p">]</span>
</span><span id="MasterState-102"><a href="#MasterState-102"><span class="linenos">102</span></a>
</span><span id="MasterState-103"><a href="#MasterState-103"><span class="linenos">103</span></a>        <span class="k">if</span> <span class="n">blockchain_block_PoH</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span><span class="n">blockchain_block_PoH</span><span class="o">=</span><span class="n">block_PoH</span>
</span><span id="MasterState-104"><a href="#MasterState-104"><span class="linenos">104</span></a>        <span class="c1">#else:block_PoH_chain_list.append(blockchain_block_PoH)</span>
</span><span id="MasterState-105"><a href="#MasterState-105"><span class="linenos">105</span></a>        
</span><span id="MasterState-106"><a href="#MasterState-106"><span class="linenos">106</span></a>
</span><span id="MasterState-107"><a href="#MasterState-107"><span class="linenos">107</span></a>        <span class="c1">#STEP 2 retrieval of all the block_PoH until blockchain_block_PoH</span>
</span><span id="MasterState-108"><a href="#MasterState-108"><span class="linenos">108</span></a>        <span class="c1">#logging.info(f&quot;### block_PoH:{block_PoH}&quot;)</span>
</span><span id="MasterState-109"><a href="#MasterState-109"><span class="linenos">109</span></a>        <span class="c1">#logging.info(f&quot;### previous_PoH_hash:{previous_PoH_hash}&quot;)</span>
</span><span id="MasterState-110"><a href="#MasterState-110"><span class="linenos">110</span></a>        <span class="c1">#logging.info(f&quot;### blockchain_block_PoH:{blockchain_block_PoH}&quot;)</span>
</span><span id="MasterState-111"><a href="#MasterState-111"><span class="linenos">111</span></a>        <span class="k">while</span> <span class="n">block_PoH</span><span class="o">!=</span><span class="n">blockchain_block_PoH</span><span class="p">:</span>
</span><span id="MasterState-112"><a href="#MasterState-112"><span class="linenos">112</span></a>            
</span><span id="MasterState-113"><a href="#MasterState-113"><span class="linenos">113</span></a>            <span class="k">if</span> <span class="n">previous_PoH_hash</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MasterState-114"><a href="#MasterState-114"><span class="linenos">114</span></a>                <span class="n">block_dict</span><span class="o">=</span><span class="n">blockchain_memory</span><span class="o">.</span><span class="n">backlog_storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">block_PoH</span><span class="p">)</span>
</span><span id="MasterState-115"><a href="#MasterState-115"><span class="linenos">115</span></a>                <span class="k">if</span> <span class="n">block_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span><span class="n">block_dict</span><span class="o">=</span><span class="n">blockchain_memory</span><span class="o">.</span><span class="n">storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">block_PoH</span><span class="p">)</span>
</span><span id="MasterState-116"><a href="#MasterState-116"><span class="linenos">116</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MasterState-117"><a href="#MasterState-117"><span class="linenos">117</span></a>                <span class="c1">#Specific process only for LeaderNode when saving the Temporay Block</span>
</span><span id="MasterState-118"><a href="#MasterState-118"><span class="linenos">118</span></a>                <span class="n">block_dict</span><span class="o">=</span><span class="n">blockchain_memory</span><span class="o">.</span><span class="n">backlog_storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">previous_PoH_hash</span><span class="p">)</span>
</span><span id="MasterState-119"><a href="#MasterState-119"><span class="linenos">119</span></a>                <span class="k">if</span> <span class="n">block_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span><span class="n">block_dict</span><span class="o">=</span><span class="n">blockchain_memory</span><span class="o">.</span><span class="n">storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">previous_PoH_hash</span><span class="p">)</span>
</span><span id="MasterState-120"><a href="#MasterState-120"><span class="linenos">120</span></a>                <span class="n">block_PoH_chain_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">previous_PoH_hash</span><span class="p">)</span>
</span><span id="MasterState-121"><a href="#MasterState-121"><span class="linenos">121</span></a>                <span class="n">previous_PoH_hash</span><span class="o">=</span><span class="kc">None</span>
</span><span id="MasterState-122"><a href="#MasterState-122"><span class="linenos">122</span></a>
</span><span id="MasterState-123"><a href="#MasterState-123"><span class="linenos">123</span></a>            <span class="k">if</span> <span class="n">block_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span><span class="k">break</span>
</span><span id="MasterState-124"><a href="#MasterState-124"><span class="linenos">124</span></a>            <span class="c1">#logging.info(f&quot;###=&gt; block_PoH_chain_list:{block_PoH_chain_list}&quot;)</span>
</span><span id="MasterState-125"><a href="#MasterState-125"><span class="linenos">125</span></a>            <span class="c1">#logging.info(f&quot;###=&gt; block_dict:{block_dict}&quot;)</span>
</span><span id="MasterState-126"><a href="#MasterState-126"><span class="linenos">126</span></a>            <span class="n">previous_block_PoH</span><span class="o">=</span><span class="n">block_dict</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;previous_PoH_hash&#39;</span><span class="p">]</span>
</span><span id="MasterState-127"><a href="#MasterState-127"><span class="linenos">127</span></a>            <span class="n">block_PoH_chain_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">previous_block_PoH</span><span class="p">)</span>
</span><span id="MasterState-128"><a href="#MasterState-128"><span class="linenos">128</span></a>            <span class="n">block_PoH</span><span class="o">=</span><span class="n">previous_block_PoH</span>
</span><span id="MasterState-129"><a href="#MasterState-129"><span class="linenos">129</span></a>            <span class="k">if</span> <span class="n">block_PoH</span><span class="o">==</span><span class="s1">&#39;111&#39;</span><span class="p">:</span><span class="k">break</span>
</span><span id="MasterState-130"><a href="#MasterState-130"><span class="linenos">130</span></a>
</span><span id="MasterState-131"><a href="#MasterState-131"><span class="linenos">131</span></a>
</span><span id="MasterState-132"><a href="#MasterState-132"><span class="linenos">132</span></a>        <span class="n">block_PoH_chain_list</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
</span><span id="MasterState-133"><a href="#MasterState-133"><span class="linenos">133</span></a>
</span><span id="MasterState-134"><a href="#MasterState-134"><span class="linenos">134</span></a>        <span class="c1">#if block_PoH==&quot;TempBlockPoH&quot;:block_PoH_chain_list.insert(0,&quot;TempBlockPoH&quot;)</span>
</span><span id="MasterState-135"><a href="#MasterState-135"><span class="linenos">135</span></a>
</span><span id="MasterState-136"><a href="#MasterState-136"><span class="linenos">136</span></a>        <span class="c1">#if block_PoH==&quot;TempBlockPoH&quot;:block_PoH_chain_list.append(&quot;TempBlockPoH&quot;)</span>
</span><span id="MasterState-137"><a href="#MasterState-137"><span class="linenos">137</span></a>        <span class="c1">#if leader_node_flag is True:block_PoH_chain_list.append(&quot;TempBlockPoH&quot;)</span>
</span><span id="MasterState-138"><a href="#MasterState-138"><span class="linenos">138</span></a>        <span class="k">if</span> <span class="n">NIGthreading_flag</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span><span class="n">block_PoH_chain_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;TempBlockPoH&quot;</span><span class="p">)</span>
</span><span id="MasterState-139"><a href="#MasterState-139"><span class="linenos">139</span></a>
</span><span id="MasterState-140"><a href="#MasterState-140"><span class="linenos">140</span></a>        <span class="c1">#logging.info(f&quot;### block_PoH_chain_list:{block_PoH_chain_list}&quot;)</span>
</span><span id="MasterState-141"><a href="#MasterState-141"><span class="linenos">141</span></a>
</span><span id="MasterState-142"><a href="#MasterState-142"><span class="linenos">142</span></a>        <span class="k">for</span> <span class="n">account</span> <span class="ow">in</span> <span class="n">account_list</span><span class="p">:</span>
</span><span id="MasterState-143"><a href="#MasterState-143"><span class="linenos">143</span></a>            <span class="c1">#read the file</span>
</span><span id="MasterState-144"><a href="#MasterState-144"><span class="linenos">144</span></a>            <span class="n">file_master_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
</span><span id="MasterState-145"><a href="#MasterState-145"><span class="linenos">145</span></a>            <span class="k">if</span> <span class="n">file_master_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MasterState-146"><a href="#MasterState-146"><span class="linenos">146</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState-147"><a href="#MasterState-147"><span class="linenos">147</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">file_master_state</span><span class="p">)</span>
</span><span id="MasterState-148"><a href="#MasterState-148"><span class="linenos">148</span></a>                <span class="c1">#logging.info(f&quot;########### current_master_state: {account} {self.current_master_state[account]}&quot;)</span>
</span><span id="MasterState-149"><a href="#MasterState-149"><span class="linenos">149</span></a>            
</span><span id="MasterState-150"><a href="#MasterState-150"><span class="linenos">150</span></a>            <span class="c1">#read the temporary file for LeaderNode</span>
</span><span id="MasterState-151"><a href="#MasterState-151"><span class="linenos">151</span></a>            <span class="c1">#if self.store_block_in_blockchain_in_memory_flag is False:</span>
</span><span id="MasterState-152"><a href="#MasterState-152"><span class="linenos">152</span></a>            <span class="n">temporary_file_master_state_raw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temporary_storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
</span><span id="MasterState-153"><a href="#MasterState-153"><span class="linenos">153</span></a>            <span class="k">if</span> <span class="n">temporary_file_master_state_raw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MasterState-154"><a href="#MasterState-154"><span class="linenos">154</span></a>                <span class="c1">#logging.info(f&quot;### check TempBlockPoH 0 block_PoH:{block_PoH}&quot;)</span>
</span><span id="MasterState-155"><a href="#MasterState-155"><span class="linenos">155</span></a>                <span class="c1">#Sanity check to ensure that old TempBlockPoH is well deleted</span>
</span><span id="MasterState-156"><a href="#MasterState-156"><span class="linenos">156</span></a>                <span class="n">block_PoH_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">temporary_file_master_state_raw</span><span class="p">)</span>
</span><span id="MasterState-157"><a href="#MasterState-157"><span class="linenos">157</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState-158"><a href="#MasterState-158"><span class="linenos">158</span></a>                    <span class="n">TempBlockPoH_index</span><span class="o">=</span><span class="n">block_PoH_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;TempBlockPoH&#39;</span><span class="p">)</span>
</span><span id="MasterState-159"><a href="#MasterState-159"><span class="linenos">159</span></a>                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;### check TempBlockPoH 2 </span><span class="si">{</span><span class="n">TempBlockPoH_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="MasterState-160"><a href="#MasterState-160"><span class="linenos">160</span></a>                    <span class="k">if</span> <span class="n">TempBlockPoH_index</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">block_PoH_list</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="MasterState-161"><a href="#MasterState-161"><span class="linenos">161</span></a>                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;### check TempBlockPoH 3&quot;</span><span class="p">)</span>
</span><span id="MasterState-162"><a href="#MasterState-162"><span class="linenos">162</span></a>                        <span class="c1">#a previousTempBlockPoH needs to be deleted</span>
</span><span id="MasterState-163"><a href="#MasterState-163"><span class="linenos">163</span></a>                        <span class="c1"># because a most recent BlockPoH is existing</span>
</span><span id="MasterState-164"><a href="#MasterState-164"><span class="linenos">164</span></a>                        <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState-165"><a href="#MasterState-165"><span class="linenos">165</span></a>                            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;### check TempBlockPoH 4&quot;</span><span class="p">)</span>
</span><span id="MasterState-166"><a href="#MasterState-166"><span class="linenos">166</span></a>                            <span class="n">temporary_file_master_state_raw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;TempBlockPoH&quot;</span><span class="p">)</span>
</span><span id="MasterState-167"><a href="#MasterState-167"><span class="linenos">167</span></a>                            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;****ERROR removal of old TempBlockPoH for account: </span><span class="si">{</span><span class="n">account</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="MasterState-168"><a href="#MasterState-168"><span class="linenos">168</span></a>                        <span class="k">except</span><span class="p">:</span><span class="k">pass</span>
</span><span id="MasterState-169"><a href="#MasterState-169"><span class="linenos">169</span></a>                <span class="k">except</span><span class="p">:</span><span class="k">pass</span>
</span><span id="MasterState-170"><a href="#MasterState-170"><span class="linenos">170</span></a>
</span><span id="MasterState-171"><a href="#MasterState-171"><span class="linenos">171</span></a>                <span class="k">for</span> <span class="n">block_PoH</span> <span class="ow">in</span> <span class="n">block_PoH_chain_list</span><span class="p">:</span>
</span><span id="MasterState-172"><a href="#MasterState-172"><span class="linenos">172</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">update_master_state_memory</span><span class="p">(</span><span class="n">account</span><span class="p">,</span><span class="n">temporary_file_master_state_raw</span><span class="p">,</span><span class="n">block_PoH</span><span class="p">)</span>
</span><span id="MasterState-173"><a href="#MasterState-173"><span class="linenos">173</span></a>
</span><span id="MasterState-174"><a href="#MasterState-174"><span class="linenos">174</span></a>    <span class="k">def</span> <span class="nf">update_master_state_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">account</span><span class="p">,</span><span class="n">file_master_state_raw</span><span class="p">,</span><span class="n">block_PoH</span><span class="p">):</span>
</span><span id="MasterState-175"><a href="#MasterState-175"><span class="linenos">175</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState-176"><a href="#MasterState-176"><span class="linenos">176</span></a>            <span class="n">file_master_state</span><span class="o">=</span><span class="n">file_master_state_raw</span><span class="p">[</span><span class="n">block_PoH</span><span class="p">]</span>
</span><span id="MasterState-177"><a href="#MasterState-177"><span class="linenos">177</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState-178"><a href="#MasterState-178"><span class="linenos">178</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">file_master_state</span><span class="p">)</span>
</span><span id="MasterState-179"><a href="#MasterState-179"><span class="linenos">179</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="MasterState-180"><a href="#MasterState-180"><span class="linenos">180</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span><span class="o">=</span><span class="n">file_master_state</span>
</span><span id="MasterState-181"><a href="#MasterState-181"><span class="linenos">181</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="MasterState-182"><a href="#MasterState-182"><span class="linenos">182</span></a>            <span class="k">pass</span>
</span><span id="MasterState-183"><a href="#MasterState-183"><span class="linenos">183</span></a>
</span><span id="MasterState-184"><a href="#MasterState-184"><span class="linenos">184</span></a>
</span><span id="MasterState-185"><a href="#MasterState-185"><span class="linenos">185</span></a>    <span class="k">def</span> <span class="nf">update_master_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span><span class="n">block_PoH</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="MasterState-186"><a href="#MasterState-186"><span class="linenos">186</span></a>        <span class="n">previous_PoH_hash</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;previous_PoH_hash&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
</span><span id="MasterState-187"><a href="#MasterState-187"><span class="linenos">187</span></a>        <span class="n">leader_node_flag</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;leader_node_flag&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
</span><span id="MasterState-188"><a href="#MasterState-188"><span class="linenos">188</span></a>        <span class="c1">#logging.info(f&quot;==&gt;block_PoH2:{block_PoH}&quot;)</span>
</span><span id="MasterState-189"><a href="#MasterState-189"><span class="linenos">189</span></a>        <span class="n">NIGthreading_flag</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;NIGthreading_flag&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MasterState-190"><a href="#MasterState-190"><span class="linenos">190</span></a>        <span class="c1">#previous_PoH_hash is used by leaderNode to reference the previous block which is stored in the memory</span>
</span><span id="MasterState-191"><a href="#MasterState-191"><span class="linenos">191</span></a>        <span class="c1">#as the new block is not yet saved in the memory</span>
</span><span id="MasterState-192"><a href="#MasterState-192"><span class="linenos">192</span></a>
</span><span id="MasterState-193"><a href="#MasterState-193"><span class="linenos">193</span></a>        <span class="c1">#logging.info(&quot;Update master state with transaction&quot;)</span>
</span><span id="MasterState-194"><a href="#MasterState-194"><span class="linenos">194</span></a>        
</span><span id="MasterState-195"><a href="#MasterState-195"><span class="linenos">195</span></a>        <span class="c1">#Step 1 uploading of previous master state for that transaction</span>
</span><span id="MasterState-196"><a href="#MasterState-196"><span class="linenos">196</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">get_master_state_from_memory_from_transaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span><span class="n">block_PoH</span><span class="o">=</span><span class="n">block_PoH</span><span class="p">,</span><span class="n">previous_PoH_hash</span><span class="o">=</span><span class="n">previous_PoH_hash</span><span class="p">,</span><span class="n">leader_node_flag</span><span class="o">=</span><span class="n">leader_node_flag</span><span class="p">,</span><span class="n">NIGthreading_flag</span><span class="o">=</span><span class="n">NIGthreading_flag</span><span class="p">)</span>
</span><span id="MasterState-197"><a href="#MasterState-197"><span class="linenos">197</span></a>
</span><span id="MasterState-198"><a href="#MasterState-198"><span class="linenos">198</span></a>        <span class="c1">#Step 2 in case of SmartContract, ensure that the consistency of the SmartContract:</span>
</span><span id="MasterState-199"><a href="#MasterState-199"><span class="linenos">199</span></a>        <span class="c1">#only 1 input, only 1 output except for marketplace</span>
</span><span id="MasterState-200"><a href="#MasterState-200"><span class="linenos">200</span></a>        <span class="c1">#transaction_hash of input of new transaxction = UTXO of SmartContrat</span>
</span><span id="MasterState-201"><a href="#MasterState-201"><span class="linenos">201</span></a>        <span class="n">smart_contract_flag</span><span class="p">,</span><span class="n">smart_contract_error_list</span><span class="o">=</span><span class="n">check_smart_contract_consistency</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>
</span><span id="MasterState-202"><a href="#MasterState-202"><span class="linenos">202</span></a>        <span class="k">if</span> <span class="n">smart_contract_flag</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="MasterState-203"><a href="#MasterState-203"><span class="linenos">203</span></a>            <span class="n">smart_contract_transaction_hash</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s2">&quot;transaction_hash&quot;</span><span class="p">]</span>
</span><span id="MasterState-204"><a href="#MasterState-204"><span class="linenos">204</span></a>            <span class="n">check_input_flag</span><span class="o">=</span><span class="kc">False</span>
</span><span id="MasterState-205"><a href="#MasterState-205"><span class="linenos">205</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">])):</span>
</span><span id="MasterState-206"><a href="#MasterState-206"><span class="linenos">206</span></a>                <span class="n">smart_contract_input_transaction_hash</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;transaction_hash&#39;</span><span class="p">]</span>
</span><span id="MasterState-207"><a href="#MasterState-207"><span class="linenos">207</span></a>                <span class="n">smart_contract_output_index</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;output_index&#39;</span><span class="p">]</span>
</span><span id="MasterState-208"><a href="#MasterState-208"><span class="linenos">208</span></a>                <span class="n">unlocking_public_key_hash</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;unlocking_public_key_hash&#39;</span><span class="p">]</span>
</span><span id="MasterState-209"><a href="#MasterState-209"><span class="linenos">209</span></a>                <span class="n">smart_contract_account</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_account_list_from_unlocking_public_key_hash</span><span class="p">(</span><span class="n">unlocking_public_key_hash</span><span class="p">)</span>
</span><span id="MasterState-210"><a href="#MasterState-210"><span class="linenos">210</span></a>                <span class="k">if</span> <span class="n">smart_contract_account</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
</span><span id="MasterState-211"><a href="#MasterState-211"><span class="linenos">211</span></a>                    <span class="c1">#smart_contract_account=&#39;&#39; when initializing BlockChain</span>
</span><span id="MasterState-212"><a href="#MasterState-212"><span class="linenos">212</span></a>                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;#smart_contract_account:</span><span class="si">{</span><span class="n">smart_contract_account</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="MasterState-213"><a href="#MasterState-213"><span class="linenos">213</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState-214"><a href="#MasterState-214"><span class="linenos">214</span></a>                        <span class="n">smart_contract_account_account_dic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">smart_contract_account</span><span class="p">]</span>
</span><span id="MasterState-215"><a href="#MasterState-215"><span class="linenos">215</span></a>                    <span class="k">except</span><span class="p">:</span>
</span><span id="MasterState-216"><a href="#MasterState-216"><span class="linenos">216</span></a>                        <span class="n">smart_contract_account_account_dic</span><span class="o">=</span><span class="kc">None</span>
</span><span id="MasterState-217"><a href="#MasterState-217"><span class="linenos">217</span></a>                    <span class="k">if</span> <span class="n">smart_contract_account_account_dic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MasterState-218"><a href="#MasterState-218"><span class="linenos">218</span></a>                        <span class="k">if</span> <span class="n">smart_contract_input_transaction_hash</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">smart_contract_output_index</span><span class="p">)</span> <span class="ow">in</span> <span class="n">smart_contract_account_account_dic</span><span class="p">[</span><span class="s1">&#39;utxos&#39;</span><span class="p">]:</span> <span class="n">check_input_flag</span><span class="o">=</span><span class="kc">True</span>
</span><span id="MasterState-219"><a href="#MasterState-219"><span class="linenos">219</span></a>                           
</span><span id="MasterState-220"><a href="#MasterState-220"><span class="linenos">220</span></a>            <span class="k">if</span> <span class="n">check_input_flag</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="MasterState-221"><a href="#MasterState-221"><span class="linenos">221</span></a>                <span class="c1">#any input_transaction_hash doesn&#39;t equal of the UTXO of the SmartContract which is not possible</span>
</span><span id="MasterState-222"><a href="#MasterState-222"><span class="linenos">222</span></a>                <span class="c1">#let&#39;s raise an issue</span>
</span><span id="MasterState-223"><a href="#MasterState-223"><span class="linenos">223</span></a>                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;#transaction:</span><span class="si">{</span><span class="n">transaction</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="MasterState-224"><a href="#MasterState-224"><span class="linenos">224</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;###ERROR UPDATE MASTER STATE of SmartContract with transaction_hash: </span><span class="si">{</span><span class="n">smart_contract_transaction_hash</span><span class="si">}</span><span class="s1"> INPUT of new transaction is not in current SmartContract UTXO&#39;</span><span class="p">)</span>
</span><span id="MasterState-225"><a href="#MasterState-225"><span class="linenos">225</span></a>
</span><span id="MasterState-226"><a href="#MasterState-226"><span class="linenos">226</span></a>
</span><span id="MasterState-227"><a href="#MasterState-227"><span class="linenos">227</span></a>        <span class="k">if</span> <span class="n">smart_contract_flag</span><span class="o">==</span><span class="s2">&quot;error&quot;</span><span class="p">:</span>
</span><span id="MasterState-228"><a href="#MasterState-228"><span class="linenos">228</span></a>            <span class="c1">#there is an issue with the SmartContrat</span>
</span><span id="MasterState-229"><a href="#MasterState-229"><span class="linenos">229</span></a>            <span class="n">smart_contract_transaction_hash</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s2">&quot;transaction_hash&quot;</span><span class="p">]</span>
</span><span id="MasterState-230"><a href="#MasterState-230"><span class="linenos">230</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;#transaction:</span><span class="si">{</span><span class="n">transaction</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="MasterState-231"><a href="#MasterState-231"><span class="linenos">231</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;###ERROR UPDATE MASTER STATE of SmartContract with transaction_hash: </span><span class="si">{</span><span class="n">smart_contract_transaction_hash</span><span class="si">}</span><span class="s1"> ERROR:</span><span class="si">{</span><span class="n">smart_contract_error_list</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="MasterState-232"><a href="#MasterState-232"><span class="linenos">232</span></a>        
</span><span id="MasterState-233"><a href="#MasterState-233"><span class="linenos">233</span></a>        
</span><span id="MasterState-234"><a href="#MasterState-234"><span class="linenos">234</span></a>        <span class="c1">#Step 3 deletion of older UTXO</span>
</span><span id="MasterState-235"><a href="#MasterState-235"><span class="linenos">235</span></a>        <span class="n">deleted_utxo</span><span class="o">=</span><span class="kc">None</span>
</span><span id="MasterState-236"><a href="#MasterState-236"><span class="linenos">236</span></a>        <span class="n">old_utxo_key</span><span class="o">=</span><span class="kc">None</span>
</span><span id="MasterState-237"><a href="#MasterState-237"><span class="linenos">237</span></a>        <span class="n">old_utxo_account</span><span class="o">=</span><span class="kc">None</span>
</span><span id="MasterState-238"><a href="#MasterState-238"><span class="linenos">238</span></a>
</span><span id="MasterState-239"><a href="#MasterState-239"><span class="linenos">239</span></a>        <span class="c1">#if check_marketplace_step1(transaction[&#39;outputs&#39;]) is False and &quot;BlockVote&quot; not in str(transaction[&#39;outputs&#39;]):</span>
</span><span id="MasterState-240"><a href="#MasterState-240"><span class="linenos">240</span></a>        <span class="c1">#if check_marketplace_step1(transaction[&#39;outputs&#39;]) is False and check_marketplace_step(98,transaction[&#39;outputs&#39;]) is False and check_marketplace_step(99,transaction[&#39;outputs&#39;]) is False:</span>
</span><span id="MasterState-241"><a href="#MasterState-241"><span class="linenos">241</span></a>        <span class="k">if</span> <span class="n">check_marketplace_step1</span><span class="p">(</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;outputs&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="MasterState-242"><a href="#MasterState-242"><span class="linenos">242</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState-243"><a href="#MasterState-243"><span class="linenos">243</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">])):</span>
</span><span id="MasterState-244"><a href="#MasterState-244"><span class="linenos">244</span></a>                    <span class="k">if</span> <span class="s2">&quot;_&quot;</span> <span class="ow">in</span> <span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;transaction_hash&#39;</span><span class="p">]:</span><span class="n">old_utxo_key</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;transaction_hash&#39;</span><span class="p">]</span>
</span><span id="MasterState-245"><a href="#MasterState-245"><span class="linenos">245</span></a>                    <span class="k">else</span><span class="p">:</span><span class="n">old_utxo_key</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;transaction_hash&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;output_index&#39;</span><span class="p">])</span>
</span><span id="MasterState-246"><a href="#MasterState-246"><span class="linenos">246</span></a>                    <span class="c1">#special process Smart Contract</span>
</span><span id="MasterState-247"><a href="#MasterState-247"><span class="linenos">247</span></a>                    <span class="c1">#when there is &quot;SC&quot; in unlocking_public_key_hash ex: &quot;31f2ac8088005412c7b031a6e342b17a65a48d01 SC f998212b2adc762f114c9ec2b0b2d9bd6c811688</span>
</span><span id="MasterState-248"><a href="#MasterState-248"><span class="linenos">248</span></a>                    <span class="n">old_utxo_account</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_account_list_from_unlocking_public_key_hash</span><span class="p">(</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;unlocking_public_key_hash&#39;</span><span class="p">])</span>
</span><span id="MasterState-249"><a href="#MasterState-249"><span class="linenos">249</span></a>
</span><span id="MasterState-250"><a href="#MasterState-250"><span class="linenos">250</span></a>                    <span class="c1">#extract of the data</span>
</span><span id="MasterState-251"><a href="#MasterState-251"><span class="linenos">251</span></a>                    <span class="k">if</span> <span class="n">old_utxo_account</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
</span><span id="MasterState-252"><a href="#MasterState-252"><span class="linenos">252</span></a>                        <span class="c1">#logging.info(f&quot;###### current_master_state:{self.current_master_state}&quot;)</span>
</span><span id="MasterState-253"><a href="#MasterState-253"><span class="linenos">253</span></a>                        <span class="n">account_dic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">old_utxo_account</span><span class="p">]</span>
</span><span id="MasterState-254"><a href="#MasterState-254"><span class="linenos">254</span></a>                        <span class="k">if</span> <span class="n">account_dic</span><span class="o">!=</span><span class="p">{}:</span>
</span><span id="MasterState-255"><a href="#MasterState-255"><span class="linenos">255</span></a>                            <span class="n">deleted_utxo</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos_data&#39;</span><span class="p">][</span><span class="n">old_utxo_key</span><span class="p">])</span>
</span><span id="MasterState-256"><a href="#MasterState-256"><span class="linenos">256</span></a>                            <span class="c1">#logging.info(f&quot;###### deleted_utxo[&#39;output&#39;]1:{deleted_utxo[&#39;output&#39;]}&quot;)</span>
</span><span id="MasterState-257"><a href="#MasterState-257"><span class="linenos">257</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span><span class="o">-=</span><span class="n">normal_round</span><span class="p">(</span><span class="n">deleted_utxo</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="s1">&#39;amount&#39;</span><span class="p">],</span><span class="n">ROUND_VALUE_DIGIT</span><span class="p">)</span>
</span><span id="MasterState-258"><a href="#MasterState-258"><span class="linenos">258</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span> <span class="o">!=</span> <span class="n">old_utxo_key</span><span class="p">,</span> <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos&#39;</span><span class="p">]))</span>
</span><span id="MasterState-259"><a href="#MasterState-259"><span class="linenos">259</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">old_utxo_key</span><span class="p">)</span>
</span><span id="MasterState-260"><a href="#MasterState-260"><span class="linenos">260</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">old_utxo_account</span><span class="p">]</span><span class="o">=</span><span class="n">account_dic</span>
</span><span id="MasterState-261"><a href="#MasterState-261"><span class="linenos">261</span></a>
</span><span id="MasterState-262"><a href="#MasterState-262"><span class="linenos">262</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="MasterState-263"><a href="#MasterState-263"><span class="linenos">263</span></a>                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**** Transaction5: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="MasterState-264"><a href="#MasterState-264"><span class="linenos">264</span></a>                <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="MasterState-265"><a href="#MasterState-265"><span class="linenos">265</span></a>
</span><span id="MasterState-266"><a href="#MasterState-266"><span class="linenos">266</span></a>        <span class="k">if</span> <span class="n">check_marketplace_step2</span><span class="p">(</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;outputs&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="MasterState-267"><a href="#MasterState-267"><span class="linenos">267</span></a>            <span class="c1">#check that there is not more than 2 utxos for marketplace_step2</span>
</span><span id="MasterState-268"><a href="#MasterState-268"><span class="linenos">268</span></a>            <span class="n">smart_contract_account</span><span class="o">=</span><span class="n">extract_marketplace_account</span><span class="p">(</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;outputs&#39;</span><span class="p">])</span>
</span><span id="MasterState-269"><a href="#MasterState-269"><span class="linenos">269</span></a>            <span class="k">if</span> <span class="n">smart_contract_account</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MasterState-270"><a href="#MasterState-270"><span class="linenos">270</span></a>                <span class="n">account_dic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">smart_contract_account</span><span class="p">]</span>
</span><span id="MasterState-271"><a href="#MasterState-271"><span class="linenos">271</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos&#39;</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
</span><span id="MasterState-272"><a href="#MasterState-272"><span class="linenos">272</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;###ERROR UPDATE MASTER STATE of SmartContract: </span><span class="si">{</span><span class="n">smart_contract_account</span><span class="si">}</span><span class="s1"> with transaction_hash: </span><span class="si">{</span><span class="n">smart_contract_transaction_hash</span><span class="si">}</span><span class="s1"> More than 2 UTXO for marketplace_step2&#39;</span><span class="p">)</span>
</span><span id="MasterState-273"><a href="#MasterState-273"><span class="linenos">273</span></a>            
</span><span id="MasterState-274"><a href="#MasterState-274"><span class="linenos">274</span></a>
</span><span id="MasterState-275"><a href="#MasterState-275"><span class="linenos">275</span></a>        <span class="c1">#Step 3 update of new UTXO</span>
</span><span id="MasterState-276"><a href="#MasterState-276"><span class="linenos">276</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState-277"><a href="#MasterState-277"><span class="linenos">277</span></a>            <span class="n">output_index</span><span class="o">=</span><span class="mi">0</span>
</span><span id="MasterState-278"><a href="#MasterState-278"><span class="linenos">278</span></a>            <span class="n">transaction_hash</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;transaction_hash&#39;</span><span class="p">]</span>
</span><span id="MasterState-279"><a href="#MasterState-279"><span class="linenos">279</span></a>            <span class="n">timestamp</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
</span><span id="MasterState-280"><a href="#MasterState-280"><span class="linenos">280</span></a>            <span class="n">new_utxo_value_input_list</span><span class="o">=</span><span class="p">[]</span>
</span><span id="MasterState-281"><a href="#MasterState-281"><span class="linenos">281</span></a>            <span class="n">account_credit_list</span><span class="o">=</span><span class="p">[]</span>
</span><span id="MasterState-282"><a href="#MasterState-282"><span class="linenos">282</span></a>            <span class="n">reputation_acount</span><span class="o">=</span><span class="kc">None</span>
</span><span id="MasterState-283"><a href="#MasterState-283"><span class="linenos">283</span></a>            <span class="k">for</span> <span class="n">utxo</span> <span class="ow">in</span> <span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">]:</span>
</span><span id="MasterState-284"><a href="#MasterState-284"><span class="linenos">284</span></a>                <span class="n">new_utxo_value_input</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState-285"><a href="#MasterState-285"><span class="linenos">285</span></a>                <span class="n">new_utxo_value_input</span><span class="p">[</span><span class="s1">&#39;unlocking_public_key_hash&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;unlocking_public_key_hash&#39;</span><span class="p">]</span>
</span><span id="MasterState-286"><a href="#MasterState-286"><span class="linenos">286</span></a>                <span class="c1">#special process Smart Contract</span>
</span><span id="MasterState-287"><a href="#MasterState-287"><span class="linenos">287</span></a>                <span class="c1">#when there is &quot;SC&quot; in unlocking_public_key_hash ex: &quot;31f2ac8088005412c7b031a6e342b17a65a48d01 SC f998212b2adc762f114c9ec2b0b2d9bd6c811688</span>
</span><span id="MasterState-288"><a href="#MasterState-288"><span class="linenos">288</span></a>                <span class="n">account_credit_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_account_list_from_unlocking_public_key_hash</span><span class="p">(</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;unlocking_public_key_hash&#39;</span><span class="p">]))</span>
</span><span id="MasterState-289"><a href="#MasterState-289"><span class="linenos">289</span></a>                <span class="n">new_utxo_value_input</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">]</span>
</span><span id="MasterState-290"><a href="#MasterState-290"><span class="linenos">290</span></a>                <span class="n">new_utxo_value_input</span><span class="p">[</span><span class="s1">&#39;transaction_hash&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;transaction_hash&#39;</span><span class="p">]</span>
</span><span id="MasterState-291"><a href="#MasterState-291"><span class="linenos">291</span></a>                <span class="n">new_utxo_value_input</span><span class="p">[</span><span class="s1">&#39;output_index&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;output_index&#39;</span><span class="p">]</span>
</span><span id="MasterState-292"><a href="#MasterState-292"><span class="linenos">292</span></a>                <span class="n">new_utxo_value_input_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_utxo_value_input</span><span class="p">)</span>
</span><span id="MasterState-293"><a href="#MasterState-293"><span class="linenos">293</span></a>
</span><span id="MasterState-294"><a href="#MasterState-294"><span class="linenos">294</span></a>
</span><span id="MasterState-295"><a href="#MasterState-295"><span class="linenos">295</span></a>            <span class="k">for</span> <span class="n">utxo</span> <span class="ow">in</span> <span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;outputs&#39;</span><span class="p">]:</span>
</span><span id="MasterState-296"><a href="#MasterState-296"><span class="linenos">296</span></a>                <span class="c1">#removal of amount in account</span>
</span><span id="MasterState-297"><a href="#MasterState-297"><span class="linenos">297</span></a>                <span class="n">new_utxo_key</span><span class="o">=</span><span class="n">transaction_hash</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">output_index</span><span class="p">)</span>
</span><span id="MasterState-298"><a href="#MasterState-298"><span class="linenos">298</span></a>                <span class="n">new_utxo_value_output</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState-299"><a href="#MasterState-299"><span class="linenos">299</span></a>                <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span>
</span><span id="MasterState-300"><a href="#MasterState-300"><span class="linenos">300</span></a>                <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;locking_script&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;locking_script&#39;</span><span class="p">]</span>
</span><span id="MasterState-301"><a href="#MasterState-301"><span class="linenos">301</span></a>                <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">]</span>
</span><span id="MasterState-302"><a href="#MasterState-302"><span class="linenos">302</span></a>                <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;transaction_hash&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">transaction_hash</span>
</span><span id="MasterState-303"><a href="#MasterState-303"><span class="linenos">303</span></a>                <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">timestamp</span>
</span><span id="MasterState-304"><a href="#MasterState-304"><span class="linenos">304</span></a>                <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;output_index&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">output_index</span>
</span><span id="MasterState-305"><a href="#MasterState-305"><span class="linenos">305</span></a>                <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;fee_interface&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;fee_interface&#39;</span><span class="p">]</span>
</span><span id="MasterState-306"><a href="#MasterState-306"><span class="linenos">306</span></a>                <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;fee_miner&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;fee_miner&#39;</span><span class="p">]</span>
</span><span id="MasterState-307"><a href="#MasterState-307"><span class="linenos">307</span></a>                <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;fee_node&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;fee_node&#39;</span><span class="p">]</span>
</span><span id="MasterState-308"><a href="#MasterState-308"><span class="linenos">308</span></a>                <span class="k">try</span><span class="p">:</span><span class="n">marketplace_transaction_flag</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;marketplace_transaction_flag&#39;</span><span class="p">]</span>
</span><span id="MasterState-309"><a href="#MasterState-309"><span class="linenos">309</span></a>                <span class="k">except</span><span class="p">:</span><span class="n">marketplace_transaction_flag</span><span class="o">=</span><span class="kc">False</span>
</span><span id="MasterState-310"><a href="#MasterState-310"><span class="linenos">310</span></a>                <span class="k">try</span><span class="p">:</span><span class="n">smart_contract_transaction_flag</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_transaction_flag&#39;</span><span class="p">]</span>
</span><span id="MasterState-311"><a href="#MasterState-311"><span class="linenos">311</span></a>                <span class="k">except</span><span class="p">:</span><span class="n">smart_contract_transaction_flag</span><span class="o">=</span><span class="kc">False</span>
</span><span id="MasterState-312"><a href="#MasterState-312"><span class="linenos">312</span></a>                <span class="n">account_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_account_list_from_locking_script</span><span class="p">(</span><span class="s2">&quot;OP_SC&quot;</span><span class="p">,</span><span class="n">utxo</span><span class="p">)</span>
</span><span id="MasterState-313"><a href="#MasterState-313"><span class="linenos">313</span></a>                <span class="c1">#logging.info(f&quot;====&gt;account_list:{account_list}&quot;)</span>
</span><span id="MasterState-314"><a href="#MasterState-314"><span class="linenos">314</span></a>                
</span><span id="MasterState-315"><a href="#MasterState-315"><span class="linenos">315</span></a>                <span class="c1">#reputation account management</span>
</span><span id="MasterState-316"><a href="#MasterState-316"><span class="linenos">316</span></a>                <span class="k">if</span> <span class="s2">&quot;OP_RE&quot;</span> <span class="ow">in</span> <span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;locking_script&#39;</span><span class="p">]:</span>
</span><span id="MasterState-317"><a href="#MasterState-317"><span class="linenos">317</span></a>                    <span class="n">reputation_acount</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_account_list_from_locking_script</span><span class="p">(</span><span class="s2">&quot;OP_SC&quot;</span><span class="p">,</span><span class="n">utxo</span><span class="p">)</span>
</span><span id="MasterState-318"><a href="#MasterState-318"><span class="linenos">318</span></a>                    <span class="c1">#logging.info(f&quot;====&gt;reputation_acount1:{reputation_acount}&quot;)</span>
</span><span id="MasterState-319"><a href="#MasterState-319"><span class="linenos">319</span></a>
</span><span id="MasterState-320"><a href="#MasterState-320"><span class="linenos">320</span></a>                <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;account_list&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">account_list</span>
</span><span id="MasterState-321"><a href="#MasterState-321"><span class="linenos">321</span></a>                <span class="n">marketplace_place_step4_flag</span><span class="o">=</span><span class="kc">False</span>
</span><span id="MasterState-322"><a href="#MasterState-322"><span class="linenos">322</span></a>                <span class="n">marketplace_place_step4_buyer</span><span class="o">=</span><span class="kc">None</span>
</span><span id="MasterState-323"><a href="#MasterState-323"><span class="linenos">323</span></a>                <span class="n">marketplace_place_step4_seller</span><span class="o">=</span><span class="kc">None</span>
</span><span id="MasterState-324"><a href="#MasterState-324"><span class="linenos">324</span></a>                <span class="n">marketplace_place_step4_requested_amount</span><span class="o">=</span><span class="kc">None</span>
</span><span id="MasterState-325"><a href="#MasterState-325"><span class="linenos">325</span></a>                <span class="n">marketplace_place_step4_requested_currency</span><span class="o">=</span><span class="kc">None</span>
</span><span id="MasterState-326"><a href="#MasterState-326"><span class="linenos">326</span></a>                <span class="n">marketplace_place_step4</span><span class="o">=</span><span class="mi">0</span>
</span><span id="MasterState-327"><a href="#MasterState-327"><span class="linenos">327</span></a>                <span class="n">marketplace_place_step4_requested_nig</span><span class="o">=</span><span class="mi">0</span>
</span><span id="MasterState-328"><a href="#MasterState-328"><span class="linenos">328</span></a>                <span class="n">marketplace_place_archiving_flag</span><span class="o">=</span><span class="kc">False</span>
</span><span id="MasterState-329"><a href="#MasterState-329"><span class="linenos">329</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState-330"><a href="#MasterState-330"><span class="linenos">330</span></a>                    <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_sender&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_sender&#39;</span><span class="p">]</span>
</span><span id="MasterState-331"><a href="#MasterState-331"><span class="linenos">331</span></a>                    <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_new&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_new&#39;</span><span class="p">]</span>
</span><span id="MasterState-332"><a href="#MasterState-332"><span class="linenos">332</span></a>                    <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_account&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_account&#39;</span><span class="p">]</span>
</span><span id="MasterState-333"><a href="#MasterState-333"><span class="linenos">333</span></a>                    <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_flag&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_flag&#39;</span><span class="p">]</span>
</span><span id="MasterState-334"><a href="#MasterState-334"><span class="linenos">334</span></a>                    <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_gas&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_gas&#39;</span><span class="p">]</span>
</span><span id="MasterState-335"><a href="#MasterState-335"><span class="linenos">335</span></a>                    <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_memory&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_memory&#39;</span><span class="p">]</span>
</span><span id="MasterState-336"><a href="#MasterState-336"><span class="linenos">336</span></a>                    <span class="c1">#check if the transaction is in step 4 or 45 (partial payment) or 66 (payment default) or 98 (expiration) or 99 (cancellation) to put in Marketplace_archive if needed</span>
</span><span id="MasterState-337"><a href="#MasterState-337"><span class="linenos">337</span></a>                    <span class="n">smart_contract_memory</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_memory&#39;</span><span class="p">]</span>
</span><span id="MasterState-338"><a href="#MasterState-338"><span class="linenos">338</span></a>                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">])):</span>
</span><span id="MasterState-339"><a href="#MasterState-339"><span class="linenos">339</span></a>                        <span class="k">if</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;step&#39;</span><span class="p">:</span>
</span><span id="MasterState-340"><a href="#MasterState-340"><span class="linenos">340</span></a>                            <span class="k">if</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">4</span> <span class="ow">or</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">45</span> <span class="ow">or</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">66</span> <span class="ow">or</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">98</span> <span class="ow">or</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">99</span><span class="p">:</span>
</span><span id="MasterState-341"><a href="#MasterState-341"><span class="linenos">341</span></a>                                <span class="n">marketplace_place_step4</span><span class="o">=</span><span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="MasterState-342"><a href="#MasterState-342"><span class="linenos">342</span></a>                                <span class="n">marketplace_place_step4_flag</span><span class="o">=</span><span class="kc">True</span>
</span><span id="MasterState-343"><a href="#MasterState-343"><span class="linenos">343</span></a>                                <span class="c1">#step = 99 is used to archive the cancelled marketplace request </span>
</span><span id="MasterState-344"><a href="#MasterState-344"><span class="linenos">344</span></a>                                <span class="k">if</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">99</span><span class="p">:</span><span class="n">marketplace_place_archiving_flag</span><span class="o">=</span><span class="kc">True</span>
</span><span id="MasterState-345"><a href="#MasterState-345"><span class="linenos">345</span></a>                                <span class="c1">#step = 98 is used to archive the expired marketplace request </span>
</span><span id="MasterState-346"><a href="#MasterState-346"><span class="linenos">346</span></a>                                <span class="k">if</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">98</span><span class="p">:</span><span class="n">marketplace_place_archiving_flag</span><span class="o">=</span><span class="kc">True</span>
</span><span id="MasterState-347"><a href="#MasterState-347"><span class="linenos">347</span></a>                                <span class="c1">#logging.info(f&quot;======&gt; MarketPlace {smart_contract_memory[0][3][j]}: {transaction_hash}&quot;)</span>
</span><span id="MasterState-348"><a href="#MasterState-348"><span class="linenos">348</span></a>                        <span class="k">if</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;requested_amount&#39;</span><span class="p">:</span><span class="n">marketplace_place_step4_requested_amount</span><span class="o">=</span><span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="MasterState-349"><a href="#MasterState-349"><span class="linenos">349</span></a>                        <span class="k">if</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;requested_currency&#39;</span><span class="p">:</span><span class="n">marketplace_place_step4_requested_currency</span><span class="o">=</span><span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="MasterState-350"><a href="#MasterState-350"><span class="linenos">350</span></a>                        <span class="k">if</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;buyer_public_key_hash&#39;</span><span class="p">:</span><span class="n">marketplace_place_step4_buyer</span><span class="o">=</span><span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="MasterState-351"><a href="#MasterState-351"><span class="linenos">351</span></a>                        <span class="k">if</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;seller_public_key_hash&#39;</span><span class="p">:</span><span class="n">marketplace_place_step4_seller</span><span class="o">=</span><span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="MasterState-352"><a href="#MasterState-352"><span class="linenos">352</span></a>                        <span class="k">if</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;requested_nig&#39;</span><span class="p">:</span><span class="n">marketplace_place_step4_requested_nig</span><span class="o">=</span><span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="MasterState-353"><a href="#MasterState-353"><span class="linenos">353</span></a>                        
</span><span id="MasterState-354"><a href="#MasterState-354"><span class="linenos">354</span></a>                        
</span><span id="MasterState-355"><a href="#MasterState-355"><span class="linenos">355</span></a>
</span><span id="MasterState-356"><a href="#MasterState-356"><span class="linenos">356</span></a>                    <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_memory_size&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_memory_size&#39;</span><span class="p">]</span>
</span><span id="MasterState-357"><a href="#MasterState-357"><span class="linenos">357</span></a>                    <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_type&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_type&#39;</span><span class="p">]</span>
</span><span id="MasterState-358"><a href="#MasterState-358"><span class="linenos">358</span></a>                    <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_payload&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_payload&#39;</span><span class="p">]</span>
</span><span id="MasterState-359"><a href="#MasterState-359"><span class="linenos">359</span></a>                    <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_result&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_result&#39;</span><span class="p">]</span>
</span><span id="MasterState-360"><a href="#MasterState-360"><span class="linenos">360</span></a>                    <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_transaction_hash&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">new_utxo_key</span>
</span><span id="MasterState-361"><a href="#MasterState-361"><span class="linenos">361</span></a>                    <span class="k">if</span> <span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_type&#39;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;source&quot;</span><span class="p">:</span>
</span><span id="MasterState-362"><a href="#MasterState-362"><span class="linenos">362</span></a>                        <span class="c1">#smart_contract_previous_transaction is only updated with source call</span>
</span><span id="MasterState-363"><a href="#MasterState-363"><span class="linenos">363</span></a>                        <span class="k">if</span> <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_new&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span><span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_previous_transaction&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span>
</span><span id="MasterState-364"><a href="#MasterState-364"><span class="linenos">364</span></a>                        <span class="k">else</span><span class="p">:</span><span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_previous_transaction&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_previous_transaction&#39;</span><span class="p">]</span>
</span><span id="MasterState-365"><a href="#MasterState-365"><span class="linenos">365</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="MasterState-366"><a href="#MasterState-366"><span class="linenos">366</span></a>                        <span class="c1">#smart_contract_previous_transaction is not updated with API call</span>
</span><span id="MasterState-367"><a href="#MasterState-367"><span class="linenos">367</span></a>                        <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_previous_transaction&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_previous_transaction&#39;</span><span class="p">]</span>
</span><span id="MasterState-368"><a href="#MasterState-368"><span class="linenos">368</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="MasterState-369"><a href="#MasterState-369"><span class="linenos">369</span></a>                    <span class="k">pass</span>
</span><span id="MasterState-370"><a href="#MasterState-370"><span class="linenos">370</span></a>
</span><span id="MasterState-371"><a href="#MasterState-371"><span class="linenos">371</span></a>
</span><span id="MasterState-372"><a href="#MasterState-372"><span class="linenos">372</span></a>                <span class="k">for</span> <span class="n">account</span> <span class="ow">in</span> <span class="n">account_list</span><span class="p">:</span>
</span><span id="MasterState-373"><a href="#MasterState-373"><span class="linenos">373</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState-374"><a href="#MasterState-374"><span class="linenos">374</span></a>                        <span class="c1">#there are values for this account, let&#39;s update them</span>
</span><span id="MasterState-375"><a href="#MasterState-375"><span class="linenos">375</span></a>                        <span class="n">account_dic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span>
</span><span id="MasterState-376"><a href="#MasterState-376"><span class="linenos">376</span></a>                        <span class="k">if</span> <span class="n">account_dic</span><span class="o">==</span><span class="p">{}:</span>
</span><span id="MasterState-377"><a href="#MasterState-377"><span class="linenos">377</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
</span><span id="MasterState-378"><a href="#MasterState-378"><span class="linenos">378</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
</span><span id="MasterState-379"><a href="#MasterState-379"><span class="linenos">379</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState-380"><a href="#MasterState-380"><span class="linenos">380</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos_data&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState-381"><a href="#MasterState-381"><span class="linenos">381</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;marketplace&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
</span><span id="MasterState-382"><a href="#MasterState-382"><span class="linenos">382</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;marketplace_archive&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
</span><span id="MasterState-383"><a href="#MasterState-383"><span class="linenos">383</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;reputation&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
</span><span id="MasterState-384"><a href="#MasterState-384"><span class="linenos">384</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;smart_contract&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
</span><span id="MasterState-385"><a href="#MasterState-385"><span class="linenos">385</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState-386"><a href="#MasterState-386"><span class="linenos">386</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState-387"><a href="#MasterState-387"><span class="linenos">387</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;debit&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState-388"><a href="#MasterState-388"><span class="linenos">388</span></a>
</span><span id="MasterState-389"><a href="#MasterState-389"><span class="linenos">389</span></a>                    <span class="k">except</span><span class="p">:</span>
</span><span id="MasterState-390"><a href="#MasterState-390"><span class="linenos">390</span></a>                        <span class="c1">#there is no value for this account, let&#39;s create them</span>
</span><span id="MasterState-391"><a href="#MasterState-391"><span class="linenos">391</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState-392"><a href="#MasterState-392"><span class="linenos">392</span></a>                        <span class="n">account_dic</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState-393"><a href="#MasterState-393"><span class="linenos">393</span></a>                        <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
</span><span id="MasterState-394"><a href="#MasterState-394"><span class="linenos">394</span></a>                        <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState-395"><a href="#MasterState-395"><span class="linenos">395</span></a>                        <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
</span><span id="MasterState-396"><a href="#MasterState-396"><span class="linenos">396</span></a>                        <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos_data&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState-397"><a href="#MasterState-397"><span class="linenos">397</span></a>                        <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;marketplace&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
</span><span id="MasterState-398"><a href="#MasterState-398"><span class="linenos">398</span></a>                        <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;marketplace_archive&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
</span><span id="MasterState-399"><a href="#MasterState-399"><span class="linenos">399</span></a>                        <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;reputation&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
</span><span id="MasterState-400"><a href="#MasterState-400"><span class="linenos">400</span></a>                        <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;smart_contract&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
</span><span id="MasterState-401"><a href="#MasterState-401"><span class="linenos">401</span></a>                        <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState-402"><a href="#MasterState-402"><span class="linenos">402</span></a>                        <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState-403"><a href="#MasterState-403"><span class="linenos">403</span></a>                        <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;debit&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState-404"><a href="#MasterState-404"><span class="linenos">404</span></a>                    
</span><span id="MasterState-405"><a href="#MasterState-405"><span class="linenos">405</span></a>                    <span class="k">if</span> <span class="n">marketplace_transaction_flag</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">smart_contract_transaction_flag</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">or</span> <span class="n">account</span><span class="o">==</span><span class="n">account_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="MasterState-406"><a href="#MasterState-406"><span class="linenos">406</span></a>                        <span class="c1">#account==account_list[0] means that it&#39;s the datas of the SmartContract so we need to update the data of the Smart Contract</span>
</span><span id="MasterState-407"><a href="#MasterState-407"><span class="linenos">407</span></a>                        <span class="k">if</span> <span class="n">account_dic</span><span class="o">!=</span><span class="p">{}:</span>
</span><span id="MasterState-408"><a href="#MasterState-408"><span class="linenos">408</span></a>                            <span class="k">if</span> <span class="n">new_utxo_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos&#39;</span><span class="p">]:</span>
</span><span id="MasterState-409"><a href="#MasterState-409"><span class="linenos">409</span></a>                                <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span><span class="o">+=</span><span class="n">normal_round</span><span class="p">(</span><span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">],</span><span class="n">ROUND_VALUE_DIGIT</span><span class="p">)</span>
</span><span id="MasterState-410"><a href="#MasterState-410"><span class="linenos">410</span></a>                                <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_utxo_key</span><span class="p">)</span>
</span><span id="MasterState-411"><a href="#MasterState-411"><span class="linenos">411</span></a>                                <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos_data&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState-412"><a href="#MasterState-412"><span class="linenos">412</span></a>                                <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos_data&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">new_utxo_value_output</span>
</span><span id="MasterState-413"><a href="#MasterState-413"><span class="linenos">413</span></a>                                <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos_data&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">][</span><span class="s1">&#39;input&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">new_utxo_value_input_list</span>
</span><span id="MasterState-414"><a href="#MasterState-414"><span class="linenos">414</span></a>                                <span class="c1">#update of balance</span>
</span><span id="MasterState-415"><a href="#MasterState-415"><span class="linenos">415</span></a>                                <span class="k">if</span> <span class="n">old_utxo_key</span><span class="o">==</span><span class="n">account</span><span class="p">:</span>
</span><span id="MasterState-416"><a href="#MasterState-416"><span class="linenos">416</span></a>                                    <span class="c1">#try:account_dic[&#39;balance&#39;][&#39;credit&#39;].pop(old_utxo_key)</span>
</span><span id="MasterState-417"><a href="#MasterState-417"><span class="linenos">417</span></a>                                    <span class="c1">#except:pass</span>
</span><span id="MasterState-418"><a href="#MasterState-418"><span class="linenos">418</span></a>                                    <span class="k">pass</span>
</span><span id="MasterState-419"><a href="#MasterState-419"><span class="linenos">419</span></a>                                <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;account_credit_list&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">account_credit_list</span>
</span><span id="MasterState-420"><a href="#MasterState-420"><span class="linenos">420</span></a>                                <span class="c1">#if old_utxo_account is not None and old_utxo_account!=account:account_dic[&#39;balance&#39;][&#39;credit&#39;][new_utxo_key]=new_utxo_value_output</span>
</span><span id="MasterState-421"><a href="#MasterState-421"><span class="linenos">421</span></a>                                <span class="c1">#if old_utxo_account is not None and old_utxo_account!=account:self.update_old_utxo_key(old_utxo_account,old_utxo_key,account,new_utxo_value_output)</span>
</span><span id="MasterState-422"><a href="#MasterState-422"><span class="linenos">422</span></a>                                <span class="c1">#if old_utxo_account!=account:account_dic[&#39;balance&#39;][&#39;credit&#39;][new_utxo_key]=new_utxo_value_output</span>
</span><span id="MasterState-423"><a href="#MasterState-423"><span class="linenos">423</span></a>
</span><span id="MasterState-424"><a href="#MasterState-424"><span class="linenos">424</span></a>                                <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState-425"><a href="#MasterState-425"><span class="linenos">425</span></a>                                    <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_flag&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_flag&#39;</span><span class="p">]</span>
</span><span id="MasterState-426"><a href="#MasterState-426"><span class="linenos">426</span></a>                                    <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">]</span><span class="o">=</span><span class="n">new_utxo_value_output</span>
</span><span id="MasterState-427"><a href="#MasterState-427"><span class="linenos">427</span></a>                                    <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">][</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span>
</span><span id="MasterState-428"><a href="#MasterState-428"><span class="linenos">428</span></a>                                <span class="k">except</span><span class="p">:</span>
</span><span id="MasterState-429"><a href="#MasterState-429"><span class="linenos">429</span></a>                                    <span class="k">if</span> <span class="n">old_utxo_account</span><span class="o">!=</span><span class="n">account</span><span class="p">:</span><span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">]</span><span class="o">=</span><span class="n">new_utxo_value_output</span>
</span><span id="MasterState-430"><a href="#MasterState-430"><span class="linenos">430</span></a>                        
</span><span id="MasterState-431"><a href="#MasterState-431"><span class="linenos">431</span></a>                                <span class="k">if</span> <span class="n">old_utxo_account</span><span class="o">!=</span><span class="n">account</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">update_old_utxo_key</span><span class="p">(</span><span class="n">old_utxo_account</span><span class="p">,</span><span class="n">old_utxo_key</span><span class="p">,</span><span class="n">new_utxo_key</span><span class="p">,</span><span class="n">new_utxo_value_output</span><span class="p">)</span>
</span><span id="MasterState-432"><a href="#MasterState-432"><span class="linenos">432</span></a>                            
</span><span id="MasterState-433"><a href="#MasterState-433"><span class="linenos">433</span></a>                                <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">]</span><span class="o">=</span><span class="n">new_utxo_value_output</span>
</span><span id="MasterState-434"><a href="#MasterState-434"><span class="linenos">434</span></a>                                <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">][</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span>
</span><span id="MasterState-435"><a href="#MasterState-435"><span class="linenos">435</span></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span><span class="o">=</span><span class="n">account_dic</span>
</span><span id="MasterState-436"><a href="#MasterState-436"><span class="linenos">436</span></a>
</span><span id="MasterState-437"><a href="#MasterState-437"><span class="linenos">437</span></a>                            <span class="k">if</span> <span class="n">marketplace_place_step4_flag</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="MasterState-438"><a href="#MasterState-438"><span class="linenos">438</span></a>                                <span class="c1">#this is transaction fully validated (step 4, 45, 66, 98 or 99)</span>
</span><span id="MasterState-439"><a href="#MasterState-439"><span class="linenos">439</span></a>                                <span class="c1">#let&#39;s archive it in the associated account to increase speed</span>
</span><span id="MasterState-440"><a href="#MasterState-440"><span class="linenos">440</span></a>                                <span class="k">if</span> <span class="n">marketplace_place_archiving_flag</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span><span class="n">associated_account_dic_step4_list</span><span class="o">=</span><span class="p">[</span><span class="n">marketplace_place_step4_buyer</span><span class="p">,</span><span class="n">marketplace_place_step4_seller</span><span class="p">]</span>
</span><span id="MasterState-441"><a href="#MasterState-441"><span class="linenos">441</span></a>                                <span class="k">else</span><span class="p">:</span>
</span><span id="MasterState-442"><a href="#MasterState-442"><span class="linenos">442</span></a>                                    <span class="c1">#this is an expired request which needs to be archived</span>
</span><span id="MasterState-443"><a href="#MasterState-443"><span class="linenos">443</span></a>                                    <span class="c1">#marketplace_place_step4_seller can be None in that case (ex:if step = 1)</span>
</span><span id="MasterState-444"><a href="#MasterState-444"><span class="linenos">444</span></a>                                    <span class="k">if</span> <span class="n">marketplace_place_step4_seller</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">marketplace_place_step4_seller</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span><span class="n">associated_account_dic_step4_list</span><span class="o">=</span><span class="p">[</span><span class="n">marketplace_place_step4_buyer</span><span class="p">]</span>
</span><span id="MasterState-445"><a href="#MasterState-445"><span class="linenos">445</span></a>                                    <span class="k">else</span><span class="p">:</span><span class="n">associated_account_dic_step4_list</span><span class="o">=</span><span class="p">[</span><span class="n">marketplace_place_step4_buyer</span><span class="p">,</span><span class="n">marketplace_place_step4_seller</span><span class="p">]</span>
</span><span id="MasterState-446"><a href="#MasterState-446"><span class="linenos">446</span></a>                                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;INFO ### associated_account_dic_step4_list:</span><span class="si">{</span><span class="n">associated_account_dic_step4_list</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="MasterState-447"><a href="#MasterState-447"><span class="linenos">447</span></a>                                <span class="n">step</span><span class="o">=</span><span class="mi">0</span>
</span><span id="MasterState-448"><a href="#MasterState-448"><span class="linenos">448</span></a>                                <span class="k">for</span> <span class="n">associated_account_dic_step4</span> <span class="ow">in</span> <span class="n">associated_account_dic_step4_list</span><span class="p">:</span>
</span><span id="MasterState-449"><a href="#MasterState-449"><span class="linenos">449</span></a>                                    <span class="n">step</span><span class="o">+=</span><span class="mi">1</span>
</span><span id="MasterState-450"><a href="#MasterState-450"><span class="linenos">450</span></a>                                    <span class="n">associated_account_dic_step4_to_update</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">associated_account_dic_step4</span><span class="p">]</span>
</span><span id="MasterState-451"><a href="#MasterState-451"><span class="linenos">451</span></a>                                    <span class="k">if</span> <span class="n">account_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_archive&#39;</span><span class="p">]:</span><span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_archive&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">account_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="MasterState-452"><a href="#MasterState-452"><span class="linenos">452</span></a>                                    <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState-453"><a href="#MasterState-453"><span class="linenos">453</span></a>                                        <span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">account_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="MasterState-454"><a href="#MasterState-454"><span class="linenos">454</span></a>                                        <span class="c1">#update of added value/gain</span>
</span><span id="MasterState-455"><a href="#MasterState-455"><span class="linenos">455</span></a>                                        <span class="k">if</span> <span class="n">marketplace_place_step4</span><span class="o">==</span><span class="mi">4</span> <span class="ow">or</span> <span class="n">marketplace_place_step4</span><span class="o">==</span><span class="mi">45</span><span class="p">:</span>
</span><span id="MasterState-456"><a href="#MasterState-456"><span class="linenos">456</span></a>                                            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;INFO ### marketplace_place added value&quot;</span><span class="p">)</span>
</span><span id="MasterState-457"><a href="#MasterState-457"><span class="linenos">457</span></a>                                            <span class="k">try</span><span class="p">:</span><span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">]</span>
</span><span id="MasterState-458"><a href="#MasterState-458"><span class="linenos">458</span></a>                                            <span class="k">except</span><span class="p">:</span><span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState-459"><a href="#MasterState-459"><span class="linenos">459</span></a>                                            <span class="k">try</span><span class="p">:</span><span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">][</span><span class="n">marketplace_place_step4_requested_currency</span><span class="p">]</span>
</span><span id="MasterState-460"><a href="#MasterState-460"><span class="linenos">460</span></a>                                            <span class="k">except</span><span class="p">:</span><span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">][</span><span class="n">marketplace_place_step4_requested_currency</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState-461"><a href="#MasterState-461"><span class="linenos">461</span></a>                                            <span class="k">if</span> <span class="n">step</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
</span><span id="MasterState-462"><a href="#MasterState-462"><span class="linenos">462</span></a>                                                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;INFO ### marketplace_place added value buyer&quot;</span><span class="p">)</span>
</span><span id="MasterState-463"><a href="#MasterState-463"><span class="linenos">463</span></a>                                                <span class="c1">#this is the buyer</span>
</span><span id="MasterState-464"><a href="#MasterState-464"><span class="linenos">464</span></a>                                                <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState-465"><a href="#MasterState-465"><span class="linenos">465</span></a>                                                    <span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">][</span><span class="n">marketplace_place_step4_requested_currency</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">]</span><span class="o">+=</span><span class="n">marketplace_place_step4_requested_amount</span>
</span><span id="MasterState-466"><a href="#MasterState-466"><span class="linenos">466</span></a>                                                    <span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">][</span><span class="n">marketplace_place_step4_requested_currency</span><span class="p">][</span><span class="s1">&#39;credit_nig&#39;</span><span class="p">]</span><span class="o">+=</span><span class="n">normal_round</span><span class="p">(</span><span class="n">marketplace_place_step4_requested_nig</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">DEFAULT_TRANSACTION_FEE_PERCENTAGE</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">),</span><span class="n">ROUND_VALUE_DIGIT</span><span class="p">)</span>
</span><span id="MasterState-467"><a href="#MasterState-467"><span class="linenos">467</span></a>                                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="MasterState-468"><a href="#MasterState-468"><span class="linenos">468</span></a>                                                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;####CHECK1###&quot;</span><span class="p">)</span>
</span><span id="MasterState-469"><a href="#MasterState-469"><span class="linenos">469</span></a>                                                    <span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">][</span><span class="n">marketplace_place_step4_requested_currency</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">marketplace_place_step4_requested_amount</span>
</span><span id="MasterState-470"><a href="#MasterState-470"><span class="linenos">470</span></a>                                                    <span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">][</span><span class="n">marketplace_place_step4_requested_currency</span><span class="p">][</span><span class="s1">&#39;credit_nig&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">normal_round</span><span class="p">(</span><span class="n">marketplace_place_step4_requested_nig</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">DEFAULT_TRANSACTION_FEE_PERCENTAGE</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">),</span><span class="n">ROUND_VALUE_DIGIT</span><span class="p">)</span>
</span><span id="MasterState-471"><a href="#MasterState-471"><span class="linenos">471</span></a>
</span><span id="MasterState-472"><a href="#MasterState-472"><span class="linenos">472</span></a>                                            <span class="k">if</span> <span class="n">step</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="MasterState-473"><a href="#MasterState-473"><span class="linenos">473</span></a>                                                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;INFO ### marketplace_place added value seller&quot;</span><span class="p">)</span>
</span><span id="MasterState-474"><a href="#MasterState-474"><span class="linenos">474</span></a>                                                <span class="c1">#this is the seller</span>
</span><span id="MasterState-475"><a href="#MasterState-475"><span class="linenos">475</span></a>                                                <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState-476"><a href="#MasterState-476"><span class="linenos">476</span></a>                                                    <span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">][</span><span class="n">marketplace_place_step4_requested_currency</span><span class="p">][</span><span class="s1">&#39;debit&#39;</span><span class="p">]</span><span class="o">+=</span><span class="n">marketplace_place_step4_requested_amount</span>
</span><span id="MasterState-477"><a href="#MasterState-477"><span class="linenos">477</span></a>                                                    <span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">][</span><span class="n">marketplace_place_step4_requested_currency</span><span class="p">][</span><span class="s1">&#39;debit_nig&#39;</span><span class="p">]</span><span class="o">+=</span><span class="n">marketplace_place_step4_requested_nig</span>
</span><span id="MasterState-478"><a href="#MasterState-478"><span class="linenos">478</span></a>                                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="MasterState-479"><a href="#MasterState-479"><span class="linenos">479</span></a>                                                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;####CHECK2###&quot;</span><span class="p">)</span>
</span><span id="MasterState-480"><a href="#MasterState-480"><span class="linenos">480</span></a>                                                    <span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">][</span><span class="n">marketplace_place_step4_requested_currency</span><span class="p">][</span><span class="s1">&#39;debit&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">marketplace_place_step4_requested_amount</span>
</span><span id="MasterState-481"><a href="#MasterState-481"><span class="linenos">481</span></a>                                                    <span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">][</span><span class="n">marketplace_place_step4_requested_currency</span><span class="p">][</span><span class="s1">&#39;debit_nig&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">marketplace_place_step4_requested_nig</span>
</span><span id="MasterState-482"><a href="#MasterState-482"><span class="linenos">482</span></a>
</span><span id="MasterState-483"><a href="#MasterState-483"><span class="linenos">483</span></a>                                            <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState-484"><a href="#MasterState-484"><span class="linenos">484</span></a>                                                <span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">account_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="MasterState-485"><a href="#MasterState-485"><span class="linenos">485</span></a>                                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="MasterState-486"><a href="#MasterState-486"><span class="linenos">486</span></a>                                                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;marketplace_place_step4 removal issue with account: </span><span class="si">{</span><span class="n">account_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="MasterState-487"><a href="#MasterState-487"><span class="linenos">487</span></a>                                                <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="MasterState-488"><a href="#MasterState-488"><span class="linenos">488</span></a>
</span><span id="MasterState-489"><a href="#MasterState-489"><span class="linenos">489</span></a>
</span><span id="MasterState-490"><a href="#MasterState-490"><span class="linenos">490</span></a>                                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="MasterState-491"><a href="#MasterState-491"><span class="linenos">491</span></a>                                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;marketplace_place_step4 removal issue with account: </span><span class="si">{</span><span class="n">account_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="MasterState-492"><a href="#MasterState-492"><span class="linenos">492</span></a>                                        <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="MasterState-493"><a href="#MasterState-493"><span class="linenos">493</span></a>                                    
</span><span id="MasterState-494"><a href="#MasterState-494"><span class="linenos">494</span></a>
</span><span id="MasterState-495"><a href="#MasterState-495"><span class="linenos">495</span></a>                                    <span class="n">data1</span><span class="o">=</span><span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace&#39;</span><span class="p">]</span>
</span><span id="MasterState-496"><a href="#MasterState-496"><span class="linenos">496</span></a>                                    <span class="n">data2</span><span class="o">=</span><span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_archive&#39;</span><span class="p">]</span>
</span><span id="MasterState-497"><a href="#MasterState-497"><span class="linenos">497</span></a>                                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;======&gt; associated_account_dic_step4: </span><span class="si">{</span><span class="n">associated_account_dic_step4</span><span class="si">}</span><span class="s2"> account_dic[&#39;marketplace&#39;]: </span><span class="si">{</span><span class="n">data1</span><span class="si">}</span><span class="s2"> account_dic[&#39;marketplace_archive&#39;] :</span><span class="si">{</span><span class="n">data2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="MasterState-498"><a href="#MasterState-498"><span class="linenos">498</span></a>                                    <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">associated_account_dic_step4</span><span class="p">]</span><span class="o">=</span><span class="n">associated_account_dic_step4_to_update</span>
</span><span id="MasterState-499"><a href="#MasterState-499"><span class="linenos">499</span></a>                                    
</span><span id="MasterState-500"><a href="#MasterState-500"><span class="linenos">500</span></a>                                    
</span><span id="MasterState-501"><a href="#MasterState-501"><span class="linenos">501</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="MasterState-502"><a href="#MasterState-502"><span class="linenos">502</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span><span class="o">+=</span><span class="n">normal_round</span><span class="p">(</span><span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">],</span><span class="n">ROUND_VALUE_DIGIT</span><span class="p">)</span>
</span><span id="MasterState-503"><a href="#MasterState-503"><span class="linenos">503</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_utxo_key</span><span class="p">)</span>
</span><span id="MasterState-504"><a href="#MasterState-504"><span class="linenos">504</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos_data&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState-505"><a href="#MasterState-505"><span class="linenos">505</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos_data&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">new_utxo_value_output</span>
</span><span id="MasterState-506"><a href="#MasterState-506"><span class="linenos">506</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos_data&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">][</span><span class="s1">&#39;input&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">new_utxo_value_input_list</span>
</span><span id="MasterState-507"><a href="#MasterState-507"><span class="linenos">507</span></a>                            <span class="c1">#update of balance</span>
</span><span id="MasterState-508"><a href="#MasterState-508"><span class="linenos">508</span></a>                            <span class="k">if</span> <span class="n">old_utxo_key</span><span class="o">==</span><span class="n">account</span><span class="p">:</span>
</span><span id="MasterState-509"><a href="#MasterState-509"><span class="linenos">509</span></a>                                <span class="c1">#try:account_dic[&#39;balance&#39;][&#39;credit&#39;].pop(old_utxo_key)</span>
</span><span id="MasterState-510"><a href="#MasterState-510"><span class="linenos">510</span></a>                                <span class="c1">#except:pass</span>
</span><span id="MasterState-511"><a href="#MasterState-511"><span class="linenos">511</span></a>                                <span class="k">pass</span>
</span><span id="MasterState-512"><a href="#MasterState-512"><span class="linenos">512</span></a>                            <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;account_credit_list&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">account_credit_list</span>
</span><span id="MasterState-513"><a href="#MasterState-513"><span class="linenos">513</span></a>                            <span class="c1">#if old_utxo_account is not None and old_utxo_account!=account:account_dic[&#39;balance&#39;][&#39;credit&#39;][new_utxo_key]=new_utxo_value_output</span>
</span><span id="MasterState-514"><a href="#MasterState-514"><span class="linenos">514</span></a>                            <span class="c1">#if old_utxo_account is not None and old_utxo_account!=account:self.update_old_utxo_key(old_utxo_account,old_utxo_key,new_utxo_key,new_utxo_value_output)</span>
</span><span id="MasterState-515"><a href="#MasterState-515"><span class="linenos">515</span></a>                            <span class="c1">#if old_utxo_account!=account:account_dic[&#39;balance&#39;][&#39;credit&#39;][new_utxo_key]=new_utxo_value_output</span>
</span><span id="MasterState-516"><a href="#MasterState-516"><span class="linenos">516</span></a>                        
</span><span id="MasterState-517"><a href="#MasterState-517"><span class="linenos">517</span></a>                            <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState-518"><a href="#MasterState-518"><span class="linenos">518</span></a>                                <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_flag&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_flag&#39;</span><span class="p">]</span>
</span><span id="MasterState-519"><a href="#MasterState-519"><span class="linenos">519</span></a>                                <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">]</span><span class="o">=</span><span class="n">new_utxo_value_output</span>
</span><span id="MasterState-520"><a href="#MasterState-520"><span class="linenos">520</span></a>                                <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">][</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span>
</span><span id="MasterState-521"><a href="#MasterState-521"><span class="linenos">521</span></a>                            <span class="k">except</span><span class="p">:</span>
</span><span id="MasterState-522"><a href="#MasterState-522"><span class="linenos">522</span></a>                                <span class="k">if</span> <span class="n">old_utxo_account</span><span class="o">!=</span><span class="n">account</span><span class="p">:</span><span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">]</span><span class="o">=</span><span class="n">new_utxo_value_output</span>
</span><span id="MasterState-523"><a href="#MasterState-523"><span class="linenos">523</span></a>                        
</span><span id="MasterState-524"><a href="#MasterState-524"><span class="linenos">524</span></a>                            <span class="k">if</span> <span class="n">old_utxo_account</span><span class="o">!=</span><span class="n">account</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">update_old_utxo_key</span><span class="p">(</span><span class="n">old_utxo_account</span><span class="p">,</span><span class="n">old_utxo_key</span><span class="p">,</span><span class="n">new_utxo_key</span><span class="p">,</span><span class="n">new_utxo_value_output</span><span class="p">)</span>
</span><span id="MasterState-525"><a href="#MasterState-525"><span class="linenos">525</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">]</span><span class="o">=</span><span class="n">new_utxo_value_output</span>
</span><span id="MasterState-526"><a href="#MasterState-526"><span class="linenos">526</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">][</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span>
</span><span id="MasterState-527"><a href="#MasterState-527"><span class="linenos">527</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span><span class="o">=</span><span class="n">account_dic</span>
</span><span id="MasterState-528"><a href="#MasterState-528"><span class="linenos">528</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="MasterState-529"><a href="#MasterState-529"><span class="linenos">529</span></a>                        <span class="c1">#account_list[0] is the Smart Contract account</span>
</span><span id="MasterState-530"><a href="#MasterState-530"><span class="linenos">530</span></a>                        <span class="c1">#account_list[1 and + ] are the other account associated to that Smart Contrat</span>
</span><span id="MasterState-531"><a href="#MasterState-531"><span class="linenos">531</span></a>                        <span class="k">if</span> <span class="n">marketplace_transaction_flag</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">marketplace_place_step4_flag</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="MasterState-532"><a href="#MasterState-532"><span class="linenos">532</span></a>                            <span class="c1">#this is a marketplace transaction</span>
</span><span id="MasterState-533"><a href="#MasterState-533"><span class="linenos">533</span></a>                            <span class="k">if</span> <span class="n">account_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;marketplace&#39;</span><span class="p">]:</span><span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;marketplace&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">account_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="MasterState-534"><a href="#MasterState-534"><span class="linenos">534</span></a>                        <span class="k">elif</span> <span class="n">smart_contract_transaction_flag</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="MasterState-535"><a href="#MasterState-535"><span class="linenos">535</span></a>                            <span class="c1">#this is a smart contract transaction</span>
</span><span id="MasterState-536"><a href="#MasterState-536"><span class="linenos">536</span></a>                            <span class="k">if</span> <span class="n">account_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;smart_contract&#39;</span><span class="p">]:</span><span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;smart_contract&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">account_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="MasterState-537"><a href="#MasterState-537"><span class="linenos">537</span></a>                        <span class="c1">#reputation_acount management</span>
</span><span id="MasterState-538"><a href="#MasterState-538"><span class="linenos">538</span></a>                        <span class="c1">#logging.info(f&quot;====&gt;reputation_acount2:{reputation_acount}&quot;)</span>
</span><span id="MasterState-539"><a href="#MasterState-539"><span class="linenos">539</span></a>                        <span class="k">if</span> <span class="n">reputation_acount</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MasterState-540"><a href="#MasterState-540"><span class="linenos">540</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;reputation&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">reputation_acount</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MasterState-541"><a href="#MasterState-541"><span class="linenos">541</span></a>                            <span class="k">try</span><span class="p">:</span><span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;smart_contract&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">reputation_acount</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="MasterState-542"><a href="#MasterState-542"><span class="linenos">542</span></a>                            <span class="k">except</span><span class="p">:</span><span class="k">pass</span>
</span><span id="MasterState-543"><a href="#MasterState-543"><span class="linenos">543</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span><span class="o">=</span><span class="n">account_dic</span>
</span><span id="MasterState-544"><a href="#MasterState-544"><span class="linenos">544</span></a>
</span><span id="MasterState-545"><a href="#MasterState-545"><span class="linenos">545</span></a>                <span class="c1">#Removal of association between some account and this SmartContract</span>
</span><span id="MasterState-546"><a href="#MasterState-546"><span class="linenos">546</span></a>                <span class="n">account_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_account_list_from_locking_script</span><span class="p">(</span><span class="s2">&quot;OP_DEL_SC&quot;</span><span class="p">,</span><span class="n">utxo</span><span class="p">)</span>
</span><span id="MasterState-547"><a href="#MasterState-547"><span class="linenos">547</span></a>                <span class="k">for</span> <span class="n">account</span> <span class="ow">in</span> <span class="n">account_list</span><span class="p">:</span>
</span><span id="MasterState-548"><a href="#MasterState-548"><span class="linenos">548</span></a>                    <span class="n">smart_contract_account</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s2">&quot;smart_contract_account&quot;</span><span class="p">]</span>
</span><span id="MasterState-549"><a href="#MasterState-549"><span class="linenos">549</span></a>                    <span class="n">account_2_remove_dic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span>
</span><span id="MasterState-550"><a href="#MasterState-550"><span class="linenos">550</span></a>                    <span class="k">if</span> <span class="n">smart_contract_account</span> <span class="ow">in</span> <span class="n">account_2_remove_dic</span><span class="p">[</span><span class="s1">&#39;marketplace&#39;</span><span class="p">]:</span>
</span><span id="MasterState-551"><a href="#MasterState-551"><span class="linenos">551</span></a>                        <span class="n">account_2_remove_dic</span><span class="p">[</span><span class="s1">&#39;marketplace&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">smart_contract_account</span><span class="p">)</span>
</span><span id="MasterState-552"><a href="#MasterState-552"><span class="linenos">552</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span><span class="o">=</span><span class="n">account_2_remove_dic</span>
</span><span id="MasterState-553"><a href="#MasterState-553"><span class="linenos">553</span></a>                    <span class="c1">#FYI, transaction are never removed from marketplace_archive to keep tracked</span>
</span><span id="MasterState-554"><a href="#MasterState-554"><span class="linenos">554</span></a>                    
</span><span id="MasterState-555"><a href="#MasterState-555"><span class="linenos">555</span></a>                <span class="n">output_index</span><span class="o">+=</span><span class="mi">1</span>
</span><span id="MasterState-556"><a href="#MasterState-556"><span class="linenos">556</span></a>            
</span><span id="MasterState-557"><a href="#MasterState-557"><span class="linenos">557</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="MasterState-558"><a href="#MasterState-558"><span class="linenos">558</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**** Transaction6: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="MasterState-559"><a href="#MasterState-559"><span class="linenos">559</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="MasterState-560"><a href="#MasterState-560"><span class="linenos">560</span></a>
</span><span id="MasterState-561"><a href="#MasterState-561"><span class="linenos">561</span></a>        <span class="c1">#Step 4 update of balance</span>
</span><span id="MasterState-562"><a href="#MasterState-562"><span class="linenos">562</span></a>
</span><span id="MasterState-563"><a href="#MasterState-563"><span class="linenos">563</span></a>    <span class="k">def</span> <span class="nf">update_old_utxo_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">old_utxo_account</span><span class="p">,</span><span class="n">old_utxo_key</span><span class="p">,</span><span class="n">new_utxo_key</span><span class="p">,</span><span class="n">new_utxo_value_output</span><span class="p">):</span>
</span><span id="MasterState-564"><a href="#MasterState-564"><span class="linenos">564</span></a>        <span class="k">if</span> <span class="n">old_utxo_account</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">old_utxo_account</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
</span><span id="MasterState-565"><a href="#MasterState-565"><span class="linenos">565</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState-566"><a href="#MasterState-566"><span class="linenos">566</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">old_utxo_account</span><span class="p">][</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;debit&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">]</span><span class="o">=</span><span class="n">new_utxo_value_output</span>
</span><span id="MasterState-567"><a href="#MasterState-567"><span class="linenos">567</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="MasterState-568"><a href="#MasterState-568"><span class="linenos">568</span></a>                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**** Transaction7: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="MasterState-569"><a href="#MasterState-569"><span class="linenos">569</span></a>                <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="MasterState-570"><a href="#MasterState-570"><span class="linenos">570</span></a>
</span><span id="MasterState-571"><a href="#MasterState-571"><span class="linenos">571</span></a>    
</span><span id="MasterState-572"><a href="#MasterState-572"><span class="linenos">572</span></a>
</span><span id="MasterState-573"><a href="#MasterState-573"><span class="linenos">573</span></a>    <span class="k">def</span> <span class="nf">store_master_state_in_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">BlockPoH</span><span class="p">):</span>
</span><span id="MasterState-574"><a href="#MasterState-574"><span class="linenos">574</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;to store the transaction in a file =&gt;store_master_state_in_memory</span>
</span><span id="MasterState-575"><a href="#MasterState-575"><span class="linenos">575</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="MasterState-576"><a href="#MasterState-576"><span class="linenos">576</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState-577"><a href="#MasterState-577"><span class="linenos">577</span></a>            <span class="c1">#logging.info(f&quot;**** self.current_master_state.keys(): {self.current_master_state.keys():}&quot;)</span>
</span><span id="MasterState-578"><a href="#MasterState-578"><span class="linenos">578</span></a>            <span class="k">for</span> <span class="n">account</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="MasterState-579"><a href="#MasterState-579"><span class="linenos">579</span></a>                <span class="n">new_master_state</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState-580"><a href="#MasterState-580"><span class="linenos">580</span></a>                <span class="n">current_master_state</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="MasterState-581"><a href="#MasterState-581"><span class="linenos">581</span></a>                <span class="n">new_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span>
</span><span id="MasterState-582"><a href="#MasterState-582"><span class="linenos">582</span></a>                <span class="c1">#saving the file</span>
</span><span id="MasterState-583"><a href="#MasterState-583"><span class="linenos">583</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporary_save_flag</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="MasterState-584"><a href="#MasterState-584"><span class="linenos">584</span></a>                    <span class="c1">#on a temporary file for LeaderNode</span>
</span><span id="MasterState-585"><a href="#MasterState-585"><span class="linenos">585</span></a>                    <span class="n">temporary_file_master_state_raw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temporary_storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
</span><span id="MasterState-586"><a href="#MasterState-586"><span class="linenos">586</span></a>                    <span class="k">if</span> <span class="n">temporary_file_master_state_raw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MasterState-587"><a href="#MasterState-587"><span class="linenos">587</span></a>                        <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState-588"><a href="#MasterState-588"><span class="linenos">588</span></a>                            <span class="n">temporary_file_master_state_raw</span><span class="p">[</span><span class="n">BlockPoH</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span>
</span><span id="MasterState-589"><a href="#MasterState-589"><span class="linenos">589</span></a>                        <span class="k">except</span><span class="p">:</span>
</span><span id="MasterState-590"><a href="#MasterState-590"><span class="linenos">590</span></a>                            <span class="n">temporary_file_master_state_raw</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState-591"><a href="#MasterState-591"><span class="linenos">591</span></a>                            <span class="n">temporary_file_master_state_raw</span><span class="p">[</span><span class="n">BlockPoH</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span>
</span><span id="MasterState-592"><a href="#MasterState-592"><span class="linenos">592</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="MasterState-593"><a href="#MasterState-593"><span class="linenos">593</span></a>                        <span class="n">temporary_file_master_state_raw</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState-594"><a href="#MasterState-594"><span class="linenos">594</span></a>                        <span class="n">temporary_file_master_state_raw</span><span class="p">[</span><span class="n">BlockPoH</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span>
</span><span id="MasterState-595"><a href="#MasterState-595"><span class="linenos">595</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">temporary_storage_sharding</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">account</span><span class="p">,</span><span class="n">temporary_file_master_state_raw</span><span class="p">)</span>
</span><span id="MasterState-596"><a href="#MasterState-596"><span class="linenos">596</span></a>                    <span class="c1">#logging.info(f&quot;**** account: {account} ==&gt; new_master_state:{new_master_state[account]}&quot;)</span>
</span><span id="MasterState-597"><a href="#MasterState-597"><span class="linenos">597</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MasterState-598"><a href="#MasterState-598"><span class="linenos">598</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">storage_sharding</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">account</span><span class="p">,</span><span class="n">new_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">])</span>
</span><span id="MasterState-599"><a href="#MasterState-599"><span class="linenos">599</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="MasterState-600"><a href="#MasterState-600"><span class="linenos">600</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**** Transaction8: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="MasterState-601"><a href="#MasterState-601"><span class="linenos">601</span></a>
</span><span id="MasterState-602"><a href="#MasterState-602"><span class="linenos">602</span></a>
</span><span id="MasterState-603"><a href="#MasterState-603"><span class="linenos">603</span></a>    <span class="k">def</span> <span class="nf">delete_TempBlockPoH</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">transaction</span><span class="p">):</span>
</span><span id="MasterState-604"><a href="#MasterState-604"><span class="linenos">604</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;to delete TempBlockPoH associated to the Transaction </span>
</span><span id="MasterState-605"><a href="#MasterState-605"><span class="linenos">605</span></a><span class="sd">        at the end of the block creation</span>
</span><span id="MasterState-606"><a href="#MasterState-606"><span class="linenos">606</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="MasterState-607"><a href="#MasterState-607"><span class="linenos">607</span></a>        <span class="n">account_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_account_list_transaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>
</span><span id="MasterState-608"><a href="#MasterState-608"><span class="linenos">608</span></a>        <span class="c1">#logging.info(f&quot;**** account_list: {account_list}&quot;)</span>
</span><span id="MasterState-609"><a href="#MasterState-609"><span class="linenos">609</span></a>        <span class="k">for</span> <span class="n">account</span> <span class="ow">in</span> <span class="n">account_list</span><span class="p">:</span>
</span><span id="MasterState-610"><a href="#MasterState-610"><span class="linenos">610</span></a>            <span class="n">temporary_file_master_state_raw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temporary_storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
</span><span id="MasterState-611"><a href="#MasterState-611"><span class="linenos">611</span></a>            <span class="k">if</span> <span class="n">temporary_file_master_state_raw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MasterState-612"><a href="#MasterState-612"><span class="linenos">612</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState-613"><a href="#MasterState-613"><span class="linenos">613</span></a>                    <span class="c1">#logging.info(f&quot;**** temporary_file_master_state_raw: {type(temporary_file_master_state_raw)} {temporary_file_master_state_raw}&quot;)</span>
</span><span id="MasterState-614"><a href="#MasterState-614"><span class="linenos">614</span></a>                    <span class="n">temporary_file_master_state_raw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;TempBlockPoH&quot;</span><span class="p">)</span>
</span><span id="MasterState-615"><a href="#MasterState-615"><span class="linenos">615</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">temporary_storage_sharding</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">account</span><span class="p">,</span><span class="n">temporary_file_master_state_raw</span><span class="p">)</span>
</span><span id="MasterState-616"><a href="#MasterState-616"><span class="linenos">616</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="MasterState-617"><a href="#MasterState-617"><span class="linenos">617</span></a>                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**** Transaction9: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="MasterState-618"><a href="#MasterState-618"><span class="linenos">618</span></a>                    <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="MasterState-619"><a href="#MasterState-619"><span class="linenos">619</span></a>
</span><span id="MasterState-620"><a href="#MasterState-620"><span class="linenos">620</span></a>    <span class="k">def</span> <span class="nf">clean_temporary_file_master_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">transaction</span><span class="p">,</span><span class="n">BlockPoH</span><span class="p">,</span><span class="n">master_state_readiness</span><span class="p">):</span>
</span><span id="MasterState-621"><a href="#MasterState-621"><span class="linenos">621</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;to delete the transaction in the temporary_file_master</span>
</span><span id="MasterState-622"><a href="#MasterState-622"><span class="linenos">622</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="MasterState-623"><a href="#MasterState-623"><span class="linenos">623</span></a>        <span class="n">account_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_account_list_transaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>
</span><span id="MasterState-624"><a href="#MasterState-624"><span class="linenos">624</span></a>        <span class="k">for</span> <span class="n">account</span> <span class="ow">in</span> <span class="n">account_list</span><span class="p">:</span>
</span><span id="MasterState-625"><a href="#MasterState-625"><span class="linenos">625</span></a>            <span class="n">temporary_file_master_state_raw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temporary_storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
</span><span id="MasterState-626"><a href="#MasterState-626"><span class="linenos">626</span></a>            <span class="k">if</span> <span class="n">temporary_file_master_state_raw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MasterState-627"><a href="#MasterState-627"><span class="linenos">627</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState-628"><a href="#MasterState-628"><span class="linenos">628</span></a>                    <span class="n">temporary_file_master_state_raw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">BlockPoH</span><span class="p">)</span>
</span><span id="MasterState-629"><a href="#MasterState-629"><span class="linenos">629</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="MasterState-630"><a href="#MasterState-630"><span class="linenos">630</span></a>                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**** Transaction10: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="MasterState-631"><a href="#MasterState-631"><span class="linenos">631</span></a>                    <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="MasterState-632"><a href="#MasterState-632"><span class="linenos">632</span></a>                <span class="k">if</span> <span class="n">temporary_file_master_state_raw</span><span class="o">==</span><span class="p">{}:</span>
</span><span id="MasterState-633"><a href="#MasterState-633"><span class="linenos">633</span></a>                    <span class="c1">#the file is empty, let&#39;s delete it</span>
</span><span id="MasterState-634"><a href="#MasterState-634"><span class="linenos">634</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">temporary_storage_sharding</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">account</span><span class="p">,</span><span class="n">master_state_readiness</span><span class="p">)</span>
</span><span id="MasterState-635"><a href="#MasterState-635"><span class="linenos">635</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MasterState-636"><a href="#MasterState-636"><span class="linenos">636</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">temporary_storage_sharding</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">account</span><span class="p">,</span><span class="n">temporary_file_master_state_raw</span><span class="p">)</span>
</span><span id="MasterState-637"><a href="#MasterState-637"><span class="linenos">637</span></a>
</span><span id="MasterState-638"><a href="#MasterState-638"><span class="linenos">638</span></a>    <span class="k">def</span> <span class="nf">extract_account_list_from_locking_script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">op_elem</span><span class="p">,</span><span class="n">utxo</span><span class="p">):</span>
</span><span id="MasterState-639"><a href="#MasterState-639"><span class="linenos">639</span></a>        <span class="n">account_list</span><span class="o">=</span><span class="p">[]</span>
</span><span id="MasterState-640"><a href="#MasterState-640"><span class="linenos">640</span></a>        <span class="n">op_elem_account_list</span><span class="o">=</span><span class="p">[]</span>
</span><span id="MasterState-641"><a href="#MasterState-641"><span class="linenos">641</span></a>        <span class="n">locking_script</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;locking_script&#39;</span><span class="p">]</span>
</span><span id="MasterState-642"><a href="#MasterState-642"><span class="linenos">642</span></a>        <span class="n">locking_script_list</span> <span class="o">=</span> <span class="n">locking_script</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="MasterState-643"><a href="#MasterState-643"><span class="linenos">643</span></a>        <span class="c1">#list of op_elem</span>
</span><span id="MasterState-644"><a href="#MasterState-644"><span class="linenos">644</span></a>        <span class="c1"># =&gt;OP_SC is used to associate an account to a SmartContract</span>
</span><span id="MasterState-645"><a href="#MasterState-645"><span class="linenos">645</span></a>        <span class="c1"># =&gt;OP_DEL_SC is used to deassociate an account from a SmartContract</span>
</span><span id="MasterState-646"><a href="#MasterState-646"><span class="linenos">646</span></a>        <span class="c1">#ex: OP_DUP OP_HASH160 31f2ac8088005412c7b031a6e342b17a65a48d01 OP_EQUAL_VERIFY OP_CHECKSIG OP_SC 47866ef83717f16c24cb246deeef1f75f798b8e5 </span>
</span><span id="MasterState-647"><a href="#MasterState-647"><span class="linenos">647</span></a>        <span class="c1">##OP_SC 531c2e528bd177866f7213b192833846018686e5 OP_DEL_SC 3243223324GFDG</span>
</span><span id="MasterState-648"><a href="#MasterState-648"><span class="linenos">648</span></a>        <span class="n">flag_for_adding</span><span class="o">=</span><span class="kc">False</span>
</span><span id="MasterState-649"><a href="#MasterState-649"><span class="linenos">649</span></a>        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">locking_script_list</span><span class="p">:</span>
</span><span id="MasterState-650"><a href="#MasterState-650"><span class="linenos">650</span></a>            <span class="c1">#Step 1 list of account when there is no specific OP like OP_SC, OP_DEL_SC</span>
</span><span id="MasterState-651"><a href="#MasterState-651"><span class="linenos">651</span></a>            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;OP&quot;</span><span class="p">):</span>
</span><span id="MasterState-652"><a href="#MasterState-652"><span class="linenos">652</span></a>                <span class="k">pass</span>
</span><span id="MasterState-653"><a href="#MasterState-653"><span class="linenos">653</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MasterState-654"><a href="#MasterState-654"><span class="linenos">654</span></a>                <span class="k">if</span> <span class="n">element</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">account_list</span><span class="p">:</span><span class="n">account_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
</span><span id="MasterState-655"><a href="#MasterState-655"><span class="linenos">655</span></a>            <span class="c1">#Step 2 list for specific OP like OP_SC, OP_DEL_SC</span>
</span><span id="MasterState-656"><a href="#MasterState-656"><span class="linenos">656</span></a>            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">op_elem</span><span class="p">):</span><span class="n">flag_for_adding</span><span class="o">=</span><span class="kc">True</span>
</span><span id="MasterState-657"><a href="#MasterState-657"><span class="linenos">657</span></a>            <span class="k">elif</span> <span class="n">flag_for_adding</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="MasterState-658"><a href="#MasterState-658"><span class="linenos">658</span></a>                <span class="k">if</span> <span class="n">element</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">op_elem_account_list</span><span class="p">:</span><span class="n">op_elem_account_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
</span><span id="MasterState-659"><a href="#MasterState-659"><span class="linenos">659</span></a>                <span class="n">flag_for_adding</span><span class="o">=</span><span class="kc">False</span>
</span><span id="MasterState-660"><a href="#MasterState-660"><span class="linenos">660</span></a>        
</span><span id="MasterState-661"><a href="#MasterState-661"><span class="linenos">661</span></a>        <span class="k">if</span> <span class="n">op_elem_account_list</span><span class="o">!=</span><span class="p">[]:</span><span class="k">return</span> <span class="n">op_elem_account_list</span>
</span><span id="MasterState-662"><a href="#MasterState-662"><span class="linenos">662</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MasterState-663"><a href="#MasterState-663"><span class="linenos">663</span></a>            <span class="k">if</span> <span class="n">op_elem</span><span class="o">==</span><span class="s2">&quot;OP_DEL_SC&quot;</span><span class="p">:</span><span class="k">return</span> <span class="p">[]</span>
</span><span id="MasterState-664"><a href="#MasterState-664"><span class="linenos">664</span></a>            <span class="k">else</span><span class="p">:</span><span class="k">return</span> <span class="n">account_list</span>
</span><span id="MasterState-665"><a href="#MasterState-665"><span class="linenos">665</span></a>
</span><span id="MasterState-666"><a href="#MasterState-666"><span class="linenos">666</span></a>    <span class="k">def</span> <span class="nf">extract_account_list_from_unlocking_public_key_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">utxo_account</span><span class="p">):</span>
</span><span id="MasterState-667"><a href="#MasterState-667"><span class="linenos">667</span></a>        <span class="c1">#special process Smart Contract</span>
</span><span id="MasterState-668"><a href="#MasterState-668"><span class="linenos">668</span></a>        <span class="c1">#when there is &quot;SC&quot; in unlocking_public_key_hash ex: &quot;31f2ac8088005412c7b031a6e342b17a65a48d01 SC f998212b2adc762f114c9ec2b0b2d9bd6c811688</span>
</span><span id="MasterState-669"><a href="#MasterState-669"><span class="linenos">669</span></a>        <span class="n">new_utxo_account</span><span class="o">=</span><span class="n">utxo_account</span>
</span><span id="MasterState-670"><a href="#MasterState-670"><span class="linenos">670</span></a>        <span class="k">if</span> <span class="n">utxo_account</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;SC &quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="MasterState-671"><a href="#MasterState-671"><span class="linenos">671</span></a>            <span class="n">new_utxo_account</span><span class="o">=</span><span class="n">utxo_account</span><span class="p">[</span><span class="n">utxo_account</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;SC &quot;</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">utxo_account</span><span class="p">)]</span>
</span><span id="MasterState-672"><a href="#MasterState-672"><span class="linenos">672</span></a>        <span class="k">return</span> <span class="n">new_utxo_account</span>
</span></pre></div>


            <div class="docstring"><p>Class to manage the state of each NIG account including SmartContract. 
Each state of account is stored in an unique file.
It's faster than reading all the transactions associated to an account in the blockchain.</p>
</div>


                            <div id="MasterState.__init__" class="classattr">
                                        <input id="MasterState.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">MasterState</span><span class="signature pdoc-code condensed">(<span class="param"><span class="o">*</span><span class="n">args</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="MasterState.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MasterState.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MasterState.__init__-20"><a href="#MasterState.__init__-20"><span class="linenos">20</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="MasterState.__init__-21"><a href="#MasterState.__init__-21"><span class="linenos">21</span></a>        <span class="kn">from</span> <span class="nn">common.values</span> <span class="kn">import</span> <span class="n">MASTER_STATE_DIR</span><span class="p">,</span><span class="n">MASTER_STATE_DEEPTH</span><span class="p">,</span><span class="n">MASTER_STATE_DIR_TEMP</span>
</span><span id="MasterState.__init__-22"><a href="#MasterState.__init__-22"><span class="linenos">22</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState.__init__-23"><a href="#MasterState.__init__-23"><span class="linenos">23</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">temporary_save_flag</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;temporary_save_flag&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MasterState.__init__-24"><a href="#MasterState.__init__-24"><span class="linenos">24</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">advance_save_flag</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;advance_save_flag&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MasterState.__init__-25"><a href="#MasterState.__init__-25"><span class="linenos">25</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">store_block_in_blockchain_in_memory_flag</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;store_block_in_blockchain_in_memory_flag&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MasterState.__init__-26"><a href="#MasterState.__init__-26"><span class="linenos">26</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">storage_sharding</span><span class="o">=</span><span class="n">StorageSharding</span><span class="p">(</span><span class="n">MASTER_STATE_DIR</span><span class="p">,</span><span class="n">deepth</span><span class="o">=</span><span class="n">MASTER_STATE_DEEPTH</span><span class="p">)</span>
</span><span id="MasterState.__init__-27"><a href="#MasterState.__init__-27"><span class="linenos">27</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">temporary_storage_sharding</span><span class="o">=</span><span class="n">StorageSharding</span><span class="p">(</span><span class="n">MASTER_STATE_DIR_TEMP</span><span class="p">,</span><span class="n">deepth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="MasterState.current_master_state" class="classattr">
                                <div class="attr variable">
            <span class="name">current_master_state</span>

        
    </div>
    <a class="headerlink" href="#MasterState.current_master_state"></a>
    
    

                            </div>
                            <div id="MasterState.temporary_save_flag" class="classattr">
                                <div class="attr variable">
            <span class="name">temporary_save_flag</span>

        
    </div>
    <a class="headerlink" href="#MasterState.temporary_save_flag"></a>
    
    

                            </div>
                            <div id="MasterState.advance_save_flag" class="classattr">
                                <div class="attr variable">
            <span class="name">advance_save_flag</span>

        
    </div>
    <a class="headerlink" href="#MasterState.advance_save_flag"></a>
    
    

                            </div>
                            <div id="MasterState.store_block_in_blockchain_in_memory_flag" class="classattr">
                                <div class="attr variable">
            <span class="name">store_block_in_blockchain_in_memory_flag</span>

        
    </div>
    <a class="headerlink" href="#MasterState.store_block_in_blockchain_in_memory_flag"></a>
    
    

                            </div>
                            <div id="MasterState.storage_sharding" class="classattr">
                                <div class="attr variable">
            <span class="name">storage_sharding</span>

        
    </div>
    <a class="headerlink" href="#MasterState.storage_sharding"></a>
    
    

                            </div>
                            <div id="MasterState.temporary_storage_sharding" class="classattr">
                                <div class="attr variable">
            <span class="name">temporary_storage_sharding</span>

        
    </div>
    <a class="headerlink" href="#MasterState.temporary_storage_sharding"></a>
    
    

                            </div>
                            <div id="MasterState.get_master_state_from_memory_from_transaction" class="classattr">
                                        <input id="MasterState.get_master_state_from_memory_from_transaction-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_master_state_from_memory_from_transaction</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">transactions</span>, </span><span class="param"><span class="o">*</span><span class="n">args</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">) -> <span class="nb">list</span>:</span></span>

                <label class="view-source-button" for="MasterState.get_master_state_from_memory_from_transaction-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MasterState.get_master_state_from_memory_from_transaction"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MasterState.get_master_state_from_memory_from_transaction-29"><a href="#MasterState.get_master_state_from_memory_from_transaction-29"><span class="linenos">29</span></a>    <span class="k">def</span> <span class="nf">get_master_state_from_memory_from_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">transactions</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="MasterState.get_master_state_from_memory_from_transaction-30"><a href="#MasterState.get_master_state_from_memory_from_transaction-30"><span class="linenos">30</span></a>        <span class="n">block_PoH</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;block_PoH&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
</span><span id="MasterState.get_master_state_from_memory_from_transaction-31"><a href="#MasterState.get_master_state_from_memory_from_transaction-31"><span class="linenos">31</span></a>        <span class="n">leader_node_flag</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;leader_node_flag&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MasterState.get_master_state_from_memory_from_transaction-32"><a href="#MasterState.get_master_state_from_memory_from_transaction-32"><span class="linenos">32</span></a>        <span class="c1">#logging.info(f&quot;==&gt;block_PoH1:{block_PoH}&quot;)</span>
</span><span id="MasterState.get_master_state_from_memory_from_transaction-33"><a href="#MasterState.get_master_state_from_memory_from_transaction-33"><span class="linenos">33</span></a>        <span class="n">previous_PoH_hash</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;previous_PoH_hash&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
</span><span id="MasterState.get_master_state_from_memory_from_transaction-34"><a href="#MasterState.get_master_state_from_memory_from_transaction-34"><span class="linenos">34</span></a>        <span class="n">NIGthreading_flag</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;NIGthreading_flag&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MasterState.get_master_state_from_memory_from_transaction-35"><a href="#MasterState.get_master_state_from_memory_from_transaction-35"><span class="linenos">35</span></a>        <span class="c1">#logging.info(&quot;Getting master state from memory for a transaction&quot;)</span>
</span><span id="MasterState.get_master_state_from_memory_from_transaction-36"><a href="#MasterState.get_master_state_from_memory_from_transaction-36"><span class="linenos">36</span></a>        <span class="n">account_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_account_list_transaction</span><span class="p">(</span><span class="n">transactions</span><span class="p">)</span>
</span><span id="MasterState.get_master_state_from_memory_from_transaction-37"><a href="#MasterState.get_master_state_from_memory_from_transaction-37"><span class="linenos">37</span></a>        <span class="c1">#logging.info(f&quot;==&gt;account_list:{account_list}&quot;)</span>
</span><span id="MasterState.get_master_state_from_memory_from_transaction-38"><a href="#MasterState.get_master_state_from_memory_from_transaction-38"><span class="linenos">38</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;==&gt;transactions:</span><span class="si">{</span><span class="n">transactions</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="MasterState.get_master_state_from_memory_from_transaction-39"><a href="#MasterState.get_master_state_from_memory_from_transaction-39"><span class="linenos">39</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">get_master_state_from_memory_from_account_list</span><span class="p">(</span><span class="n">account_list</span><span class="p">,</span><span class="n">block_PoH</span><span class="o">=</span><span class="n">block_PoH</span><span class="p">,</span><span class="n">previous_PoH_hash</span><span class="o">=</span><span class="n">previous_PoH_hash</span><span class="p">,</span><span class="n">leader_node_flag</span><span class="o">=</span><span class="n">leader_node_flag</span><span class="p">,</span><span class="n">NIGthreading_flag</span><span class="o">=</span><span class="n">NIGthreading_flag</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="MasterState.get_account_list_transaction" class="classattr">
                                        <input id="MasterState.get_account_list_transaction-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_account_list_transaction</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">transactions</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MasterState.get_account_list_transaction-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MasterState.get_account_list_transaction"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MasterState.get_account_list_transaction-41"><a href="#MasterState.get_account_list_transaction-41"><span class="linenos">41</span></a>    <span class="k">def</span> <span class="nf">get_account_list_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">transactions</span><span class="p">):</span>
</span><span id="MasterState.get_account_list_transaction-42"><a href="#MasterState.get_account_list_transaction-42"><span class="linenos">42</span></a>        <span class="n">account_list</span><span class="o">=</span><span class="p">[]</span>
</span><span id="MasterState.get_account_list_transaction-43"><a href="#MasterState.get_account_list_transaction-43"><span class="linenos">43</span></a>        <span class="c1">#logging.info(f&quot;####transactions55:{transactions}&quot;)</span>
</span><span id="MasterState.get_account_list_transaction-44"><a href="#MasterState.get_account_list_transaction-44"><span class="linenos">44</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState.get_account_list_transaction-45"><a href="#MasterState.get_account_list_transaction-45"><span class="linenos">45</span></a>            <span class="c1">#account_list.append(transactions[&#39;inputs&#39;][0][&#39;transaction_hash&#39;]+&#39;_&#39;+str(transactions[&#39;inputs&#39;][0][&#39;output_index&#39;]))</span>
</span><span id="MasterState.get_account_list_transaction-46"><a href="#MasterState.get_account_list_transaction-46"><span class="linenos">46</span></a>            <span class="k">for</span> <span class="n">utxo</span> <span class="ow">in</span> <span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;outputs&#39;</span><span class="p">]:</span>
</span><span id="MasterState.get_account_list_transaction-47"><a href="#MasterState.get_account_list_transaction-47"><span class="linenos">47</span></a>                <span class="n">test1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_account_list_from_locking_script</span><span class="p">(</span><span class="s2">&quot;OP_SC&quot;</span><span class="p">,</span><span class="n">utxo</span><span class="p">)</span>
</span><span id="MasterState.get_account_list_transaction-48"><a href="#MasterState.get_account_list_transaction-48"><span class="linenos">48</span></a>                <span class="n">test2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_account_list_from_locking_script</span><span class="p">(</span><span class="s2">&quot;OP_DEL_SC&quot;</span><span class="p">,</span><span class="n">utxo</span><span class="p">)</span>
</span><span id="MasterState.get_account_list_transaction-49"><a href="#MasterState.get_account_list_transaction-49"><span class="linenos">49</span></a>                <span class="c1">#logging.info(f&quot;####OP_SC:{test1}&quot;)</span>
</span><span id="MasterState.get_account_list_transaction-50"><a href="#MasterState.get_account_list_transaction-50"><span class="linenos">50</span></a>                <span class="c1">#logging.info(f&quot;####OP_DEL_SC:{test2}&quot;)</span>
</span><span id="MasterState.get_account_list_transaction-51"><a href="#MasterState.get_account_list_transaction-51"><span class="linenos">51</span></a>                <span class="n">account_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_account_list_from_locking_script</span><span class="p">(</span><span class="s2">&quot;OP_SC&quot;</span><span class="p">,</span><span class="n">utxo</span><span class="p">))</span>
</span><span id="MasterState.get_account_list_transaction-52"><a href="#MasterState.get_account_list_transaction-52"><span class="linenos">52</span></a>                <span class="n">account_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_account_list_from_locking_script</span><span class="p">(</span><span class="s2">&quot;OP_DEL_SC&quot;</span><span class="p">,</span><span class="n">utxo</span><span class="p">))</span>
</span><span id="MasterState.get_account_list_transaction-53"><a href="#MasterState.get_account_list_transaction-53"><span class="linenos">53</span></a>            <span class="k">for</span> <span class="n">inputs</span> <span class="ow">in</span> <span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">]:</span>
</span><span id="MasterState.get_account_list_transaction-54"><a href="#MasterState.get_account_list_transaction-54"><span class="linenos">54</span></a>                <span class="n">new_account</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_account_list_from_unlocking_public_key_hash</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;unlocking_public_key_hash&#39;</span><span class="p">])</span>
</span><span id="MasterState.get_account_list_transaction-55"><a href="#MasterState.get_account_list_transaction-55"><span class="linenos">55</span></a>                <span class="k">if</span> <span class="n">new_account</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">account_list</span><span class="p">:</span><span class="n">account_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_account</span><span class="p">)</span>
</span><span id="MasterState.get_account_list_transaction-56"><a href="#MasterState.get_account_list_transaction-56"><span class="linenos">56</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="MasterState.get_account_list_transaction-57"><a href="#MasterState.get_account_list_transaction-57"><span class="linenos">57</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**** Transaction2: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="MasterState.get_account_list_transaction-58"><a href="#MasterState.get_account_list_transaction-58"><span class="linenos">58</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="MasterState.get_account_list_transaction-59"><a href="#MasterState.get_account_list_transaction-59"><span class="linenos">59</span></a>        <span class="k">return</span> <span class="n">account_list</span>
</span></pre></div>


    

                            </div>
                            <div id="MasterState.get_master_state_from_memory_from_user" class="classattr">
                                        <input id="MasterState.get_master_state_from_memory_from_user-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_master_state_from_memory_from_user</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">user</span>, </span><span class="param"><span class="o">*</span><span class="n">args</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">) -> <span class="nb">list</span>:</span></span>

                <label class="view-source-button" for="MasterState.get_master_state_from_memory_from_user-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MasterState.get_master_state_from_memory_from_user"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MasterState.get_master_state_from_memory_from_user-61"><a href="#MasterState.get_master_state_from_memory_from_user-61"><span class="linenos">61</span></a>    <span class="k">def</span> <span class="nf">get_master_state_from_memory_from_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">user</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="MasterState.get_master_state_from_memory_from_user-62"><a href="#MasterState.get_master_state_from_memory_from_user-62"><span class="linenos">62</span></a>        <span class="n">block_PoH</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;block_PoH&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
</span><span id="MasterState.get_master_state_from_memory_from_user-63"><a href="#MasterState.get_master_state_from_memory_from_user-63"><span class="linenos">63</span></a>        <span class="n">leader_node_flag</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;leader_node_flag&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MasterState.get_master_state_from_memory_from_user-64"><a href="#MasterState.get_master_state_from_memory_from_user-64"><span class="linenos">64</span></a>        <span class="n">NIGthreading_flag</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;NIGthreading_flag&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MasterState.get_master_state_from_memory_from_user-65"><a href="#MasterState.get_master_state_from_memory_from_user-65"><span class="linenos">65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">get_master_state_from_memory_from_account_list</span><span class="p">([</span><span class="n">user</span><span class="p">],</span><span class="n">block_PoH</span><span class="o">=</span><span class="n">block_PoH</span><span class="p">,</span><span class="n">leader_node_flag</span><span class="o">=</span><span class="n">leader_node_flag</span><span class="p">,</span><span class="n">NIGthreading_flag</span><span class="o">=</span><span class="n">NIGthreading_flag</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="MasterState.get_master_state_from_memory_from_account_list" class="classattr">
                                        <input id="MasterState.get_master_state_from_memory_from_account_list-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_master_state_from_memory_from_account_list</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">account_list</span>, </span><span class="param"><span class="o">*</span><span class="n">args</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">) -> <span class="nb">list</span>:</span></span>

                <label class="view-source-button" for="MasterState.get_master_state_from_memory_from_account_list-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MasterState.get_master_state_from_memory_from_account_list"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MasterState.get_master_state_from_memory_from_account_list-67"><a href="#MasterState.get_master_state_from_memory_from_account_list-67"><span class="linenos"> 67</span></a>    <span class="k">def</span> <span class="nf">get_master_state_from_memory_from_account_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">account_list</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-68"><a href="#MasterState.get_master_state_from_memory_from_account_list-68"><span class="linenos"> 68</span></a>        <span class="n">block_PoH</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;block_PoH&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-69"><a href="#MasterState.get_master_state_from_memory_from_account_list-69"><span class="linenos"> 69</span></a>        <span class="n">leader_node_flag</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;leader_node_flag&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-70"><a href="#MasterState.get_master_state_from_memory_from_account_list-70"><span class="linenos"> 70</span></a>        <span class="n">NIGthreading_flag</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;NIGthreading_flag&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-71"><a href="#MasterState.get_master_state_from_memory_from_account_list-71"><span class="linenos"> 71</span></a>        <span class="n">previous_PoH_hash</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;previous_PoH_hash&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-72"><a href="#MasterState.get_master_state_from_memory_from_account_list-72"><span class="linenos"> 72</span></a>        <span class="c1">#previous_PoH_hash is used by leaderNode to reference the previous block which is stored in the memory</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-73"><a href="#MasterState.get_master_state_from_memory_from_account_list-73"><span class="linenos"> 73</span></a>        <span class="c1">#as the new block is not yet saved in the memory</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-74"><a href="#MasterState.get_master_state_from_memory_from_account_list-74"><span class="linenos"> 74</span></a>        
</span><span id="MasterState.get_master_state_from_memory_from_account_list-75"><a href="#MasterState.get_master_state_from_memory_from_account_list-75"><span class="linenos"> 75</span></a>        <span class="c1">#logging.info(f&quot;==&gt;account_list:{account_list}&quot;)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-76"><a href="#MasterState.get_master_state_from_memory_from_account_list-76"><span class="linenos"> 76</span></a>        <span class="c1">#STEP 1 retrieval of the last_block_pointer block_PoH</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-77"><a href="#MasterState.get_master_state_from_memory_from_account_list-77"><span class="linenos"> 77</span></a>        <span class="kn">from</span> <span class="nn">common.io_blockchain</span> <span class="kn">import</span> <span class="n">BlockchainMemory</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-78"><a href="#MasterState.get_master_state_from_memory_from_account_list-78"><span class="linenos"> 78</span></a>        <span class="n">blockchain_memory</span> <span class="o">=</span> <span class="n">BlockchainMemory</span><span class="p">()</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-79"><a href="#MasterState.get_master_state_from_memory_from_account_list-79"><span class="linenos"> 79</span></a>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-80"><a href="#MasterState.get_master_state_from_memory_from_account_list-80"><span class="linenos"> 80</span></a>        <span class="c1">#STEP 2 Retrievel of the last block_PoH in consensus_blockchain ONLY for temporary_storage_sharding</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-81"><a href="#MasterState.get_master_state_from_memory_from_account_list-81"><span class="linenos"> 81</span></a>        <span class="k">if</span> <span class="n">block_PoH</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">block_PoH</span><span class="o">!=</span><span class="s2">&quot;TempBlockPoH&quot;</span> <span class="ow">and</span> <span class="n">block_PoH</span><span class="o">!=</span><span class="s2">&quot;add_in_blockchain&quot;</span><span class="p">:</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-82"><a href="#MasterState.get_master_state_from_memory_from_account_list-82"><span class="linenos"> 82</span></a>            <span class="c1">#let&#39;s retrieve the last received block of the blockchain belonging to that block_PoH</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-83"><a href="#MasterState.get_master_state_from_memory_from_account_list-83"><span class="linenos"> 83</span></a>            <span class="c1">#to ensure that the MasterState is up to date</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-84"><a href="#MasterState.get_master_state_from_memory_from_account_list-84"><span class="linenos"> 84</span></a>            <span class="c1">#ONLY for temporary_storage_sharding (self.temporary_save_flag=True)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-85"><a href="#MasterState.get_master_state_from_memory_from_account_list-85"><span class="linenos"> 85</span></a>            <span class="kn">from</span> <span class="nn">common.consensus_blockchain</span> <span class="kn">import</span> <span class="n">consensus_blockchain</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-86"><a href="#MasterState.get_master_state_from_memory_from_account_list-86"><span class="linenos"> 86</span></a>            <span class="c1">#logging.info(f&quot;### CHANGE OF block_PoH:w{block_PoH}&quot;)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-87"><a href="#MasterState.get_master_state_from_memory_from_account_list-87"><span class="linenos"> 87</span></a>            <span class="k">for</span> <span class="n">backlog_chain_list_counter</span> <span class="ow">in</span> <span class="n">consensus_blockchain</span><span class="o">.</span><span class="n">backlog_chain_list</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-88"><a href="#MasterState.get_master_state_from_memory_from_account_list-88"><span class="linenos"> 88</span></a>                <span class="k">if</span> <span class="n">block_PoH</span> <span class="ow">in</span> <span class="n">consensus_blockchain</span><span class="o">.</span><span class="n">backlog_chain_list</span><span class="p">[</span><span class="n">backlog_chain_list_counter</span><span class="p">][</span><span class="s1">&#39;list&#39;</span><span class="p">]:</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-89"><a href="#MasterState.get_master_state_from_memory_from_account_list-89"><span class="linenos"> 89</span></a>                    <span class="n">block_PoH</span><span class="o">=</span><span class="n">consensus_blockchain</span><span class="o">.</span><span class="n">backlog_chain_list</span><span class="p">[</span><span class="n">backlog_chain_list_counter</span><span class="p">][</span><span class="s1">&#39;last&#39;</span><span class="p">]</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-90"><a href="#MasterState.get_master_state_from_memory_from_account_list-90"><span class="linenos"> 90</span></a>                    <span class="k">break</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-91"><a href="#MasterState.get_master_state_from_memory_from_account_list-91"><span class="linenos"> 91</span></a>            <span class="c1">#logging.info(f&quot;### NEW block_PoH:{block_PoH}&quot;)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-92"><a href="#MasterState.get_master_state_from_memory_from_account_list-92"><span class="linenos"> 92</span></a>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-93"><a href="#MasterState.get_master_state_from_memory_from_account_list-93"><span class="linenos"> 93</span></a>        <span class="c1">#STEP 2 retrieval of the block with the block_PoH</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-94"><a href="#MasterState.get_master_state_from_memory_from_account_list-94"><span class="linenos"> 94</span></a>        <span class="k">if</span> <span class="n">block_PoH</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">block_PoH</span><span class="o">==</span><span class="s2">&quot;TempBlockPoH&quot;</span> <span class="ow">and</span> <span class="n">block_PoH</span><span class="o">!=</span><span class="s2">&quot;add_in_blockchain&quot;</span><span class="p">:</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-95"><a href="#MasterState.get_master_state_from_memory_from_account_list-95"><span class="linenos"> 95</span></a>            <span class="n">block_PoH</span><span class="o">=</span><span class="n">blockchain_memory</span><span class="o">.</span><span class="n">backlog_storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;last_block_pointer&quot;</span><span class="p">)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-96"><a href="#MasterState.get_master_state_from_memory_from_account_list-96"><span class="linenos"> 96</span></a>            <span class="k">if</span> <span class="n">block_PoH</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span><span class="n">block_PoH</span><span class="o">=</span><span class="n">blockchain_memory</span><span class="o">.</span><span class="n">storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;last_block_pointer&quot;</span><span class="p">)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-97"><a href="#MasterState.get_master_state_from_memory_from_account_list-97"><span class="linenos"> 97</span></a>        <span class="k">elif</span> <span class="n">block_PoH</span><span class="o">==</span><span class="s2">&quot;add_in_blockchain&quot;</span><span class="p">:</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-98"><a href="#MasterState.get_master_state_from_memory_from_account_list-98"><span class="linenos"> 98</span></a>            <span class="c1">#specific process when adding a new block in the BlockChain</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-99"><a href="#MasterState.get_master_state_from_memory_from_account_list-99"><span class="linenos"> 99</span></a>            <span class="n">block_PoH</span><span class="o">=</span><span class="n">blockchain_memory</span><span class="o">.</span><span class="n">storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;last_block_pointer&quot;</span><span class="p">)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-100"><a href="#MasterState.get_master_state_from_memory_from_account_list-100"><span class="linenos">100</span></a>        <span class="n">blockchain_block_PoH</span><span class="o">=</span><span class="n">blockchain_memory</span><span class="o">.</span><span class="n">storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;last_block_pointer&quot;</span><span class="p">)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-101"><a href="#MasterState.get_master_state_from_memory_from_account_list-101"><span class="linenos">101</span></a>        <span class="n">block_PoH_chain_list</span><span class="o">=</span><span class="p">[</span><span class="n">block_PoH</span><span class="p">]</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-102"><a href="#MasterState.get_master_state_from_memory_from_account_list-102"><span class="linenos">102</span></a>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-103"><a href="#MasterState.get_master_state_from_memory_from_account_list-103"><span class="linenos">103</span></a>        <span class="k">if</span> <span class="n">blockchain_block_PoH</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span><span class="n">blockchain_block_PoH</span><span class="o">=</span><span class="n">block_PoH</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-104"><a href="#MasterState.get_master_state_from_memory_from_account_list-104"><span class="linenos">104</span></a>        <span class="c1">#else:block_PoH_chain_list.append(blockchain_block_PoH)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-105"><a href="#MasterState.get_master_state_from_memory_from_account_list-105"><span class="linenos">105</span></a>        
</span><span id="MasterState.get_master_state_from_memory_from_account_list-106"><a href="#MasterState.get_master_state_from_memory_from_account_list-106"><span class="linenos">106</span></a>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-107"><a href="#MasterState.get_master_state_from_memory_from_account_list-107"><span class="linenos">107</span></a>        <span class="c1">#STEP 2 retrieval of all the block_PoH until blockchain_block_PoH</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-108"><a href="#MasterState.get_master_state_from_memory_from_account_list-108"><span class="linenos">108</span></a>        <span class="c1">#logging.info(f&quot;### block_PoH:{block_PoH}&quot;)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-109"><a href="#MasterState.get_master_state_from_memory_from_account_list-109"><span class="linenos">109</span></a>        <span class="c1">#logging.info(f&quot;### previous_PoH_hash:{previous_PoH_hash}&quot;)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-110"><a href="#MasterState.get_master_state_from_memory_from_account_list-110"><span class="linenos">110</span></a>        <span class="c1">#logging.info(f&quot;### blockchain_block_PoH:{blockchain_block_PoH}&quot;)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-111"><a href="#MasterState.get_master_state_from_memory_from_account_list-111"><span class="linenos">111</span></a>        <span class="k">while</span> <span class="n">block_PoH</span><span class="o">!=</span><span class="n">blockchain_block_PoH</span><span class="p">:</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-112"><a href="#MasterState.get_master_state_from_memory_from_account_list-112"><span class="linenos">112</span></a>            
</span><span id="MasterState.get_master_state_from_memory_from_account_list-113"><a href="#MasterState.get_master_state_from_memory_from_account_list-113"><span class="linenos">113</span></a>            <span class="k">if</span> <span class="n">previous_PoH_hash</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-114"><a href="#MasterState.get_master_state_from_memory_from_account_list-114"><span class="linenos">114</span></a>                <span class="n">block_dict</span><span class="o">=</span><span class="n">blockchain_memory</span><span class="o">.</span><span class="n">backlog_storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">block_PoH</span><span class="p">)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-115"><a href="#MasterState.get_master_state_from_memory_from_account_list-115"><span class="linenos">115</span></a>                <span class="k">if</span> <span class="n">block_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span><span class="n">block_dict</span><span class="o">=</span><span class="n">blockchain_memory</span><span class="o">.</span><span class="n">storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">block_PoH</span><span class="p">)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-116"><a href="#MasterState.get_master_state_from_memory_from_account_list-116"><span class="linenos">116</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-117"><a href="#MasterState.get_master_state_from_memory_from_account_list-117"><span class="linenos">117</span></a>                <span class="c1">#Specific process only for LeaderNode when saving the Temporay Block</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-118"><a href="#MasterState.get_master_state_from_memory_from_account_list-118"><span class="linenos">118</span></a>                <span class="n">block_dict</span><span class="o">=</span><span class="n">blockchain_memory</span><span class="o">.</span><span class="n">backlog_storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">previous_PoH_hash</span><span class="p">)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-119"><a href="#MasterState.get_master_state_from_memory_from_account_list-119"><span class="linenos">119</span></a>                <span class="k">if</span> <span class="n">block_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span><span class="n">block_dict</span><span class="o">=</span><span class="n">blockchain_memory</span><span class="o">.</span><span class="n">storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">previous_PoH_hash</span><span class="p">)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-120"><a href="#MasterState.get_master_state_from_memory_from_account_list-120"><span class="linenos">120</span></a>                <span class="n">block_PoH_chain_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">previous_PoH_hash</span><span class="p">)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-121"><a href="#MasterState.get_master_state_from_memory_from_account_list-121"><span class="linenos">121</span></a>                <span class="n">previous_PoH_hash</span><span class="o">=</span><span class="kc">None</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-122"><a href="#MasterState.get_master_state_from_memory_from_account_list-122"><span class="linenos">122</span></a>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-123"><a href="#MasterState.get_master_state_from_memory_from_account_list-123"><span class="linenos">123</span></a>            <span class="k">if</span> <span class="n">block_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span><span class="k">break</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-124"><a href="#MasterState.get_master_state_from_memory_from_account_list-124"><span class="linenos">124</span></a>            <span class="c1">#logging.info(f&quot;###=&gt; block_PoH_chain_list:{block_PoH_chain_list}&quot;)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-125"><a href="#MasterState.get_master_state_from_memory_from_account_list-125"><span class="linenos">125</span></a>            <span class="c1">#logging.info(f&quot;###=&gt; block_dict:{block_dict}&quot;)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-126"><a href="#MasterState.get_master_state_from_memory_from_account_list-126"><span class="linenos">126</span></a>            <span class="n">previous_block_PoH</span><span class="o">=</span><span class="n">block_dict</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;previous_PoH_hash&#39;</span><span class="p">]</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-127"><a href="#MasterState.get_master_state_from_memory_from_account_list-127"><span class="linenos">127</span></a>            <span class="n">block_PoH_chain_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">previous_block_PoH</span><span class="p">)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-128"><a href="#MasterState.get_master_state_from_memory_from_account_list-128"><span class="linenos">128</span></a>            <span class="n">block_PoH</span><span class="o">=</span><span class="n">previous_block_PoH</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-129"><a href="#MasterState.get_master_state_from_memory_from_account_list-129"><span class="linenos">129</span></a>            <span class="k">if</span> <span class="n">block_PoH</span><span class="o">==</span><span class="s1">&#39;111&#39;</span><span class="p">:</span><span class="k">break</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-130"><a href="#MasterState.get_master_state_from_memory_from_account_list-130"><span class="linenos">130</span></a>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-131"><a href="#MasterState.get_master_state_from_memory_from_account_list-131"><span class="linenos">131</span></a>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-132"><a href="#MasterState.get_master_state_from_memory_from_account_list-132"><span class="linenos">132</span></a>        <span class="n">block_PoH_chain_list</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-133"><a href="#MasterState.get_master_state_from_memory_from_account_list-133"><span class="linenos">133</span></a>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-134"><a href="#MasterState.get_master_state_from_memory_from_account_list-134"><span class="linenos">134</span></a>        <span class="c1">#if block_PoH==&quot;TempBlockPoH&quot;:block_PoH_chain_list.insert(0,&quot;TempBlockPoH&quot;)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-135"><a href="#MasterState.get_master_state_from_memory_from_account_list-135"><span class="linenos">135</span></a>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-136"><a href="#MasterState.get_master_state_from_memory_from_account_list-136"><span class="linenos">136</span></a>        <span class="c1">#if block_PoH==&quot;TempBlockPoH&quot;:block_PoH_chain_list.append(&quot;TempBlockPoH&quot;)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-137"><a href="#MasterState.get_master_state_from_memory_from_account_list-137"><span class="linenos">137</span></a>        <span class="c1">#if leader_node_flag is True:block_PoH_chain_list.append(&quot;TempBlockPoH&quot;)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-138"><a href="#MasterState.get_master_state_from_memory_from_account_list-138"><span class="linenos">138</span></a>        <span class="k">if</span> <span class="n">NIGthreading_flag</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span><span class="n">block_PoH_chain_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;TempBlockPoH&quot;</span><span class="p">)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-139"><a href="#MasterState.get_master_state_from_memory_from_account_list-139"><span class="linenos">139</span></a>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-140"><a href="#MasterState.get_master_state_from_memory_from_account_list-140"><span class="linenos">140</span></a>        <span class="c1">#logging.info(f&quot;### block_PoH_chain_list:{block_PoH_chain_list}&quot;)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-141"><a href="#MasterState.get_master_state_from_memory_from_account_list-141"><span class="linenos">141</span></a>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-142"><a href="#MasterState.get_master_state_from_memory_from_account_list-142"><span class="linenos">142</span></a>        <span class="k">for</span> <span class="n">account</span> <span class="ow">in</span> <span class="n">account_list</span><span class="p">:</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-143"><a href="#MasterState.get_master_state_from_memory_from_account_list-143"><span class="linenos">143</span></a>            <span class="c1">#read the file</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-144"><a href="#MasterState.get_master_state_from_memory_from_account_list-144"><span class="linenos">144</span></a>            <span class="n">file_master_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-145"><a href="#MasterState.get_master_state_from_memory_from_account_list-145"><span class="linenos">145</span></a>            <span class="k">if</span> <span class="n">file_master_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-146"><a href="#MasterState.get_master_state_from_memory_from_account_list-146"><span class="linenos">146</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-147"><a href="#MasterState.get_master_state_from_memory_from_account_list-147"><span class="linenos">147</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">file_master_state</span><span class="p">)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-148"><a href="#MasterState.get_master_state_from_memory_from_account_list-148"><span class="linenos">148</span></a>                <span class="c1">#logging.info(f&quot;########### current_master_state: {account} {self.current_master_state[account]}&quot;)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-149"><a href="#MasterState.get_master_state_from_memory_from_account_list-149"><span class="linenos">149</span></a>            
</span><span id="MasterState.get_master_state_from_memory_from_account_list-150"><a href="#MasterState.get_master_state_from_memory_from_account_list-150"><span class="linenos">150</span></a>            <span class="c1">#read the temporary file for LeaderNode</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-151"><a href="#MasterState.get_master_state_from_memory_from_account_list-151"><span class="linenos">151</span></a>            <span class="c1">#if self.store_block_in_blockchain_in_memory_flag is False:</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-152"><a href="#MasterState.get_master_state_from_memory_from_account_list-152"><span class="linenos">152</span></a>            <span class="n">temporary_file_master_state_raw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temporary_storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-153"><a href="#MasterState.get_master_state_from_memory_from_account_list-153"><span class="linenos">153</span></a>            <span class="k">if</span> <span class="n">temporary_file_master_state_raw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-154"><a href="#MasterState.get_master_state_from_memory_from_account_list-154"><span class="linenos">154</span></a>                <span class="c1">#logging.info(f&quot;### check TempBlockPoH 0 block_PoH:{block_PoH}&quot;)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-155"><a href="#MasterState.get_master_state_from_memory_from_account_list-155"><span class="linenos">155</span></a>                <span class="c1">#Sanity check to ensure that old TempBlockPoH is well deleted</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-156"><a href="#MasterState.get_master_state_from_memory_from_account_list-156"><span class="linenos">156</span></a>                <span class="n">block_PoH_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">temporary_file_master_state_raw</span><span class="p">)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-157"><a href="#MasterState.get_master_state_from_memory_from_account_list-157"><span class="linenos">157</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-158"><a href="#MasterState.get_master_state_from_memory_from_account_list-158"><span class="linenos">158</span></a>                    <span class="n">TempBlockPoH_index</span><span class="o">=</span><span class="n">block_PoH_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;TempBlockPoH&#39;</span><span class="p">)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-159"><a href="#MasterState.get_master_state_from_memory_from_account_list-159"><span class="linenos">159</span></a>                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;### check TempBlockPoH 2 </span><span class="si">{</span><span class="n">TempBlockPoH_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-160"><a href="#MasterState.get_master_state_from_memory_from_account_list-160"><span class="linenos">160</span></a>                    <span class="k">if</span> <span class="n">TempBlockPoH_index</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">block_PoH_list</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-161"><a href="#MasterState.get_master_state_from_memory_from_account_list-161"><span class="linenos">161</span></a>                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;### check TempBlockPoH 3&quot;</span><span class="p">)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-162"><a href="#MasterState.get_master_state_from_memory_from_account_list-162"><span class="linenos">162</span></a>                        <span class="c1">#a previousTempBlockPoH needs to be deleted</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-163"><a href="#MasterState.get_master_state_from_memory_from_account_list-163"><span class="linenos">163</span></a>                        <span class="c1"># because a most recent BlockPoH is existing</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-164"><a href="#MasterState.get_master_state_from_memory_from_account_list-164"><span class="linenos">164</span></a>                        <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-165"><a href="#MasterState.get_master_state_from_memory_from_account_list-165"><span class="linenos">165</span></a>                            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;### check TempBlockPoH 4&quot;</span><span class="p">)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-166"><a href="#MasterState.get_master_state_from_memory_from_account_list-166"><span class="linenos">166</span></a>                            <span class="n">temporary_file_master_state_raw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;TempBlockPoH&quot;</span><span class="p">)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-167"><a href="#MasterState.get_master_state_from_memory_from_account_list-167"><span class="linenos">167</span></a>                            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;****ERROR removal of old TempBlockPoH for account: </span><span class="si">{</span><span class="n">account</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-168"><a href="#MasterState.get_master_state_from_memory_from_account_list-168"><span class="linenos">168</span></a>                        <span class="k">except</span><span class="p">:</span><span class="k">pass</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-169"><a href="#MasterState.get_master_state_from_memory_from_account_list-169"><span class="linenos">169</span></a>                <span class="k">except</span><span class="p">:</span><span class="k">pass</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-170"><a href="#MasterState.get_master_state_from_memory_from_account_list-170"><span class="linenos">170</span></a>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-171"><a href="#MasterState.get_master_state_from_memory_from_account_list-171"><span class="linenos">171</span></a>                <span class="k">for</span> <span class="n">block_PoH</span> <span class="ow">in</span> <span class="n">block_PoH_chain_list</span><span class="p">:</span>
</span><span id="MasterState.get_master_state_from_memory_from_account_list-172"><a href="#MasterState.get_master_state_from_memory_from_account_list-172"><span class="linenos">172</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">update_master_state_memory</span><span class="p">(</span><span class="n">account</span><span class="p">,</span><span class="n">temporary_file_master_state_raw</span><span class="p">,</span><span class="n">block_PoH</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="MasterState.update_master_state_memory" class="classattr">
                                        <input id="MasterState.update_master_state_memory-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_master_state_memory</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">account</span>, </span><span class="param"><span class="n">file_master_state_raw</span>, </span><span class="param"><span class="n">block_PoH</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MasterState.update_master_state_memory-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MasterState.update_master_state_memory"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MasterState.update_master_state_memory-174"><a href="#MasterState.update_master_state_memory-174"><span class="linenos">174</span></a>    <span class="k">def</span> <span class="nf">update_master_state_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">account</span><span class="p">,</span><span class="n">file_master_state_raw</span><span class="p">,</span><span class="n">block_PoH</span><span class="p">):</span>
</span><span id="MasterState.update_master_state_memory-175"><a href="#MasterState.update_master_state_memory-175"><span class="linenos">175</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState.update_master_state_memory-176"><a href="#MasterState.update_master_state_memory-176"><span class="linenos">176</span></a>            <span class="n">file_master_state</span><span class="o">=</span><span class="n">file_master_state_raw</span><span class="p">[</span><span class="n">block_PoH</span><span class="p">]</span>
</span><span id="MasterState.update_master_state_memory-177"><a href="#MasterState.update_master_state_memory-177"><span class="linenos">177</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState.update_master_state_memory-178"><a href="#MasterState.update_master_state_memory-178"><span class="linenos">178</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">file_master_state</span><span class="p">)</span>
</span><span id="MasterState.update_master_state_memory-179"><a href="#MasterState.update_master_state_memory-179"><span class="linenos">179</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="MasterState.update_master_state_memory-180"><a href="#MasterState.update_master_state_memory-180"><span class="linenos">180</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span><span class="o">=</span><span class="n">file_master_state</span>
</span><span id="MasterState.update_master_state_memory-181"><a href="#MasterState.update_master_state_memory-181"><span class="linenos">181</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="MasterState.update_master_state_memory-182"><a href="#MasterState.update_master_state_memory-182"><span class="linenos">182</span></a>            <span class="k">pass</span>
</span></pre></div>


    

                            </div>
                            <div id="MasterState.update_master_state" class="classattr">
                                        <input id="MasterState.update_master_state-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_master_state</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">transaction</span><span class="p">:</span> <span class="nb">list</span>, </span><span class="param"><span class="n">block_PoH</span>, </span><span class="param"><span class="o">*</span><span class="n">args</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MasterState.update_master_state-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MasterState.update_master_state"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MasterState.update_master_state-185"><a href="#MasterState.update_master_state-185"><span class="linenos">185</span></a>    <span class="k">def</span> <span class="nf">update_master_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span><span class="n">block_PoH</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="MasterState.update_master_state-186"><a href="#MasterState.update_master_state-186"><span class="linenos">186</span></a>        <span class="n">previous_PoH_hash</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;previous_PoH_hash&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-187"><a href="#MasterState.update_master_state-187"><span class="linenos">187</span></a>        <span class="n">leader_node_flag</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;leader_node_flag&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-188"><a href="#MasterState.update_master_state-188"><span class="linenos">188</span></a>        <span class="c1">#logging.info(f&quot;==&gt;block_PoH2:{block_PoH}&quot;)</span>
</span><span id="MasterState.update_master_state-189"><a href="#MasterState.update_master_state-189"><span class="linenos">189</span></a>        <span class="n">NIGthreading_flag</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;NIGthreading_flag&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-190"><a href="#MasterState.update_master_state-190"><span class="linenos">190</span></a>        <span class="c1">#previous_PoH_hash is used by leaderNode to reference the previous block which is stored in the memory</span>
</span><span id="MasterState.update_master_state-191"><a href="#MasterState.update_master_state-191"><span class="linenos">191</span></a>        <span class="c1">#as the new block is not yet saved in the memory</span>
</span><span id="MasterState.update_master_state-192"><a href="#MasterState.update_master_state-192"><span class="linenos">192</span></a>
</span><span id="MasterState.update_master_state-193"><a href="#MasterState.update_master_state-193"><span class="linenos">193</span></a>        <span class="c1">#logging.info(&quot;Update master state with transaction&quot;)</span>
</span><span id="MasterState.update_master_state-194"><a href="#MasterState.update_master_state-194"><span class="linenos">194</span></a>        
</span><span id="MasterState.update_master_state-195"><a href="#MasterState.update_master_state-195"><span class="linenos">195</span></a>        <span class="c1">#Step 1 uploading of previous master state for that transaction</span>
</span><span id="MasterState.update_master_state-196"><a href="#MasterState.update_master_state-196"><span class="linenos">196</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">get_master_state_from_memory_from_transaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span><span class="n">block_PoH</span><span class="o">=</span><span class="n">block_PoH</span><span class="p">,</span><span class="n">previous_PoH_hash</span><span class="o">=</span><span class="n">previous_PoH_hash</span><span class="p">,</span><span class="n">leader_node_flag</span><span class="o">=</span><span class="n">leader_node_flag</span><span class="p">,</span><span class="n">NIGthreading_flag</span><span class="o">=</span><span class="n">NIGthreading_flag</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-197"><a href="#MasterState.update_master_state-197"><span class="linenos">197</span></a>
</span><span id="MasterState.update_master_state-198"><a href="#MasterState.update_master_state-198"><span class="linenos">198</span></a>        <span class="c1">#Step 2 in case of SmartContract, ensure that the consistency of the SmartContract:</span>
</span><span id="MasterState.update_master_state-199"><a href="#MasterState.update_master_state-199"><span class="linenos">199</span></a>        <span class="c1">#only 1 input, only 1 output except for marketplace</span>
</span><span id="MasterState.update_master_state-200"><a href="#MasterState.update_master_state-200"><span class="linenos">200</span></a>        <span class="c1">#transaction_hash of input of new transaxction = UTXO of SmartContrat</span>
</span><span id="MasterState.update_master_state-201"><a href="#MasterState.update_master_state-201"><span class="linenos">201</span></a>        <span class="n">smart_contract_flag</span><span class="p">,</span><span class="n">smart_contract_error_list</span><span class="o">=</span><span class="n">check_smart_contract_consistency</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-202"><a href="#MasterState.update_master_state-202"><span class="linenos">202</span></a>        <span class="k">if</span> <span class="n">smart_contract_flag</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-203"><a href="#MasterState.update_master_state-203"><span class="linenos">203</span></a>            <span class="n">smart_contract_transaction_hash</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s2">&quot;transaction_hash&quot;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-204"><a href="#MasterState.update_master_state-204"><span class="linenos">204</span></a>            <span class="n">check_input_flag</span><span class="o">=</span><span class="kc">False</span>
</span><span id="MasterState.update_master_state-205"><a href="#MasterState.update_master_state-205"><span class="linenos">205</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">])):</span>
</span><span id="MasterState.update_master_state-206"><a href="#MasterState.update_master_state-206"><span class="linenos">206</span></a>                <span class="n">smart_contract_input_transaction_hash</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;transaction_hash&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-207"><a href="#MasterState.update_master_state-207"><span class="linenos">207</span></a>                <span class="n">smart_contract_output_index</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;output_index&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-208"><a href="#MasterState.update_master_state-208"><span class="linenos">208</span></a>                <span class="n">unlocking_public_key_hash</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;unlocking_public_key_hash&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-209"><a href="#MasterState.update_master_state-209"><span class="linenos">209</span></a>                <span class="n">smart_contract_account</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_account_list_from_unlocking_public_key_hash</span><span class="p">(</span><span class="n">unlocking_public_key_hash</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-210"><a href="#MasterState.update_master_state-210"><span class="linenos">210</span></a>                <span class="k">if</span> <span class="n">smart_contract_account</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-211"><a href="#MasterState.update_master_state-211"><span class="linenos">211</span></a>                    <span class="c1">#smart_contract_account=&#39;&#39; when initializing BlockChain</span>
</span><span id="MasterState.update_master_state-212"><a href="#MasterState.update_master_state-212"><span class="linenos">212</span></a>                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;#smart_contract_account:</span><span class="si">{</span><span class="n">smart_contract_account</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-213"><a href="#MasterState.update_master_state-213"><span class="linenos">213</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-214"><a href="#MasterState.update_master_state-214"><span class="linenos">214</span></a>                        <span class="n">smart_contract_account_account_dic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">smart_contract_account</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-215"><a href="#MasterState.update_master_state-215"><span class="linenos">215</span></a>                    <span class="k">except</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-216"><a href="#MasterState.update_master_state-216"><span class="linenos">216</span></a>                        <span class="n">smart_contract_account_account_dic</span><span class="o">=</span><span class="kc">None</span>
</span><span id="MasterState.update_master_state-217"><a href="#MasterState.update_master_state-217"><span class="linenos">217</span></a>                    <span class="k">if</span> <span class="n">smart_contract_account_account_dic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-218"><a href="#MasterState.update_master_state-218"><span class="linenos">218</span></a>                        <span class="k">if</span> <span class="n">smart_contract_input_transaction_hash</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">smart_contract_output_index</span><span class="p">)</span> <span class="ow">in</span> <span class="n">smart_contract_account_account_dic</span><span class="p">[</span><span class="s1">&#39;utxos&#39;</span><span class="p">]:</span> <span class="n">check_input_flag</span><span class="o">=</span><span class="kc">True</span>
</span><span id="MasterState.update_master_state-219"><a href="#MasterState.update_master_state-219"><span class="linenos">219</span></a>                           
</span><span id="MasterState.update_master_state-220"><a href="#MasterState.update_master_state-220"><span class="linenos">220</span></a>            <span class="k">if</span> <span class="n">check_input_flag</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-221"><a href="#MasterState.update_master_state-221"><span class="linenos">221</span></a>                <span class="c1">#any input_transaction_hash doesn&#39;t equal of the UTXO of the SmartContract which is not possible</span>
</span><span id="MasterState.update_master_state-222"><a href="#MasterState.update_master_state-222"><span class="linenos">222</span></a>                <span class="c1">#let&#39;s raise an issue</span>
</span><span id="MasterState.update_master_state-223"><a href="#MasterState.update_master_state-223"><span class="linenos">223</span></a>                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;#transaction:</span><span class="si">{</span><span class="n">transaction</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-224"><a href="#MasterState.update_master_state-224"><span class="linenos">224</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;###ERROR UPDATE MASTER STATE of SmartContract with transaction_hash: </span><span class="si">{</span><span class="n">smart_contract_transaction_hash</span><span class="si">}</span><span class="s1"> INPUT of new transaction is not in current SmartContract UTXO&#39;</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-225"><a href="#MasterState.update_master_state-225"><span class="linenos">225</span></a>
</span><span id="MasterState.update_master_state-226"><a href="#MasterState.update_master_state-226"><span class="linenos">226</span></a>
</span><span id="MasterState.update_master_state-227"><a href="#MasterState.update_master_state-227"><span class="linenos">227</span></a>        <span class="k">if</span> <span class="n">smart_contract_flag</span><span class="o">==</span><span class="s2">&quot;error&quot;</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-228"><a href="#MasterState.update_master_state-228"><span class="linenos">228</span></a>            <span class="c1">#there is an issue with the SmartContrat</span>
</span><span id="MasterState.update_master_state-229"><a href="#MasterState.update_master_state-229"><span class="linenos">229</span></a>            <span class="n">smart_contract_transaction_hash</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s2">&quot;transaction_hash&quot;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-230"><a href="#MasterState.update_master_state-230"><span class="linenos">230</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;#transaction:</span><span class="si">{</span><span class="n">transaction</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-231"><a href="#MasterState.update_master_state-231"><span class="linenos">231</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;###ERROR UPDATE MASTER STATE of SmartContract with transaction_hash: </span><span class="si">{</span><span class="n">smart_contract_transaction_hash</span><span class="si">}</span><span class="s1"> ERROR:</span><span class="si">{</span><span class="n">smart_contract_error_list</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-232"><a href="#MasterState.update_master_state-232"><span class="linenos">232</span></a>        
</span><span id="MasterState.update_master_state-233"><a href="#MasterState.update_master_state-233"><span class="linenos">233</span></a>        
</span><span id="MasterState.update_master_state-234"><a href="#MasterState.update_master_state-234"><span class="linenos">234</span></a>        <span class="c1">#Step 3 deletion of older UTXO</span>
</span><span id="MasterState.update_master_state-235"><a href="#MasterState.update_master_state-235"><span class="linenos">235</span></a>        <span class="n">deleted_utxo</span><span class="o">=</span><span class="kc">None</span>
</span><span id="MasterState.update_master_state-236"><a href="#MasterState.update_master_state-236"><span class="linenos">236</span></a>        <span class="n">old_utxo_key</span><span class="o">=</span><span class="kc">None</span>
</span><span id="MasterState.update_master_state-237"><a href="#MasterState.update_master_state-237"><span class="linenos">237</span></a>        <span class="n">old_utxo_account</span><span class="o">=</span><span class="kc">None</span>
</span><span id="MasterState.update_master_state-238"><a href="#MasterState.update_master_state-238"><span class="linenos">238</span></a>
</span><span id="MasterState.update_master_state-239"><a href="#MasterState.update_master_state-239"><span class="linenos">239</span></a>        <span class="c1">#if check_marketplace_step1(transaction[&#39;outputs&#39;]) is False and &quot;BlockVote&quot; not in str(transaction[&#39;outputs&#39;]):</span>
</span><span id="MasterState.update_master_state-240"><a href="#MasterState.update_master_state-240"><span class="linenos">240</span></a>        <span class="c1">#if check_marketplace_step1(transaction[&#39;outputs&#39;]) is False and check_marketplace_step(98,transaction[&#39;outputs&#39;]) is False and check_marketplace_step(99,transaction[&#39;outputs&#39;]) is False:</span>
</span><span id="MasterState.update_master_state-241"><a href="#MasterState.update_master_state-241"><span class="linenos">241</span></a>        <span class="k">if</span> <span class="n">check_marketplace_step1</span><span class="p">(</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;outputs&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-242"><a href="#MasterState.update_master_state-242"><span class="linenos">242</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-243"><a href="#MasterState.update_master_state-243"><span class="linenos">243</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">])):</span>
</span><span id="MasterState.update_master_state-244"><a href="#MasterState.update_master_state-244"><span class="linenos">244</span></a>                    <span class="k">if</span> <span class="s2">&quot;_&quot;</span> <span class="ow">in</span> <span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;transaction_hash&#39;</span><span class="p">]:</span><span class="n">old_utxo_key</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;transaction_hash&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-245"><a href="#MasterState.update_master_state-245"><span class="linenos">245</span></a>                    <span class="k">else</span><span class="p">:</span><span class="n">old_utxo_key</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;transaction_hash&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;output_index&#39;</span><span class="p">])</span>
</span><span id="MasterState.update_master_state-246"><a href="#MasterState.update_master_state-246"><span class="linenos">246</span></a>                    <span class="c1">#special process Smart Contract</span>
</span><span id="MasterState.update_master_state-247"><a href="#MasterState.update_master_state-247"><span class="linenos">247</span></a>                    <span class="c1">#when there is &quot;SC&quot; in unlocking_public_key_hash ex: &quot;31f2ac8088005412c7b031a6e342b17a65a48d01 SC f998212b2adc762f114c9ec2b0b2d9bd6c811688</span>
</span><span id="MasterState.update_master_state-248"><a href="#MasterState.update_master_state-248"><span class="linenos">248</span></a>                    <span class="n">old_utxo_account</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_account_list_from_unlocking_public_key_hash</span><span class="p">(</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;unlocking_public_key_hash&#39;</span><span class="p">])</span>
</span><span id="MasterState.update_master_state-249"><a href="#MasterState.update_master_state-249"><span class="linenos">249</span></a>
</span><span id="MasterState.update_master_state-250"><a href="#MasterState.update_master_state-250"><span class="linenos">250</span></a>                    <span class="c1">#extract of the data</span>
</span><span id="MasterState.update_master_state-251"><a href="#MasterState.update_master_state-251"><span class="linenos">251</span></a>                    <span class="k">if</span> <span class="n">old_utxo_account</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-252"><a href="#MasterState.update_master_state-252"><span class="linenos">252</span></a>                        <span class="c1">#logging.info(f&quot;###### current_master_state:{self.current_master_state}&quot;)</span>
</span><span id="MasterState.update_master_state-253"><a href="#MasterState.update_master_state-253"><span class="linenos">253</span></a>                        <span class="n">account_dic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">old_utxo_account</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-254"><a href="#MasterState.update_master_state-254"><span class="linenos">254</span></a>                        <span class="k">if</span> <span class="n">account_dic</span><span class="o">!=</span><span class="p">{}:</span>
</span><span id="MasterState.update_master_state-255"><a href="#MasterState.update_master_state-255"><span class="linenos">255</span></a>                            <span class="n">deleted_utxo</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos_data&#39;</span><span class="p">][</span><span class="n">old_utxo_key</span><span class="p">])</span>
</span><span id="MasterState.update_master_state-256"><a href="#MasterState.update_master_state-256"><span class="linenos">256</span></a>                            <span class="c1">#logging.info(f&quot;###### deleted_utxo[&#39;output&#39;]1:{deleted_utxo[&#39;output&#39;]}&quot;)</span>
</span><span id="MasterState.update_master_state-257"><a href="#MasterState.update_master_state-257"><span class="linenos">257</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span><span class="o">-=</span><span class="n">normal_round</span><span class="p">(</span><span class="n">deleted_utxo</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="s1">&#39;amount&#39;</span><span class="p">],</span><span class="n">ROUND_VALUE_DIGIT</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-258"><a href="#MasterState.update_master_state-258"><span class="linenos">258</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span> <span class="o">!=</span> <span class="n">old_utxo_key</span><span class="p">,</span> <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos&#39;</span><span class="p">]))</span>
</span><span id="MasterState.update_master_state-259"><a href="#MasterState.update_master_state-259"><span class="linenos">259</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">old_utxo_key</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-260"><a href="#MasterState.update_master_state-260"><span class="linenos">260</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">old_utxo_account</span><span class="p">]</span><span class="o">=</span><span class="n">account_dic</span>
</span><span id="MasterState.update_master_state-261"><a href="#MasterState.update_master_state-261"><span class="linenos">261</span></a>
</span><span id="MasterState.update_master_state-262"><a href="#MasterState.update_master_state-262"><span class="linenos">262</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-263"><a href="#MasterState.update_master_state-263"><span class="linenos">263</span></a>                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**** Transaction5: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-264"><a href="#MasterState.update_master_state-264"><span class="linenos">264</span></a>                <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-265"><a href="#MasterState.update_master_state-265"><span class="linenos">265</span></a>
</span><span id="MasterState.update_master_state-266"><a href="#MasterState.update_master_state-266"><span class="linenos">266</span></a>        <span class="k">if</span> <span class="n">check_marketplace_step2</span><span class="p">(</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;outputs&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-267"><a href="#MasterState.update_master_state-267"><span class="linenos">267</span></a>            <span class="c1">#check that there is not more than 2 utxos for marketplace_step2</span>
</span><span id="MasterState.update_master_state-268"><a href="#MasterState.update_master_state-268"><span class="linenos">268</span></a>            <span class="n">smart_contract_account</span><span class="o">=</span><span class="n">extract_marketplace_account</span><span class="p">(</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;outputs&#39;</span><span class="p">])</span>
</span><span id="MasterState.update_master_state-269"><a href="#MasterState.update_master_state-269"><span class="linenos">269</span></a>            <span class="k">if</span> <span class="n">smart_contract_account</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-270"><a href="#MasterState.update_master_state-270"><span class="linenos">270</span></a>                <span class="n">account_dic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">smart_contract_account</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-271"><a href="#MasterState.update_master_state-271"><span class="linenos">271</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos&#39;</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-272"><a href="#MasterState.update_master_state-272"><span class="linenos">272</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;###ERROR UPDATE MASTER STATE of SmartContract: </span><span class="si">{</span><span class="n">smart_contract_account</span><span class="si">}</span><span class="s1"> with transaction_hash: </span><span class="si">{</span><span class="n">smart_contract_transaction_hash</span><span class="si">}</span><span class="s1"> More than 2 UTXO for marketplace_step2&#39;</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-273"><a href="#MasterState.update_master_state-273"><span class="linenos">273</span></a>            
</span><span id="MasterState.update_master_state-274"><a href="#MasterState.update_master_state-274"><span class="linenos">274</span></a>
</span><span id="MasterState.update_master_state-275"><a href="#MasterState.update_master_state-275"><span class="linenos">275</span></a>        <span class="c1">#Step 3 update of new UTXO</span>
</span><span id="MasterState.update_master_state-276"><a href="#MasterState.update_master_state-276"><span class="linenos">276</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-277"><a href="#MasterState.update_master_state-277"><span class="linenos">277</span></a>            <span class="n">output_index</span><span class="o">=</span><span class="mi">0</span>
</span><span id="MasterState.update_master_state-278"><a href="#MasterState.update_master_state-278"><span class="linenos">278</span></a>            <span class="n">transaction_hash</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;transaction_hash&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-279"><a href="#MasterState.update_master_state-279"><span class="linenos">279</span></a>            <span class="n">timestamp</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-280"><a href="#MasterState.update_master_state-280"><span class="linenos">280</span></a>            <span class="n">new_utxo_value_input_list</span><span class="o">=</span><span class="p">[]</span>
</span><span id="MasterState.update_master_state-281"><a href="#MasterState.update_master_state-281"><span class="linenos">281</span></a>            <span class="n">account_credit_list</span><span class="o">=</span><span class="p">[]</span>
</span><span id="MasterState.update_master_state-282"><a href="#MasterState.update_master_state-282"><span class="linenos">282</span></a>            <span class="n">reputation_acount</span><span class="o">=</span><span class="kc">None</span>
</span><span id="MasterState.update_master_state-283"><a href="#MasterState.update_master_state-283"><span class="linenos">283</span></a>            <span class="k">for</span> <span class="n">utxo</span> <span class="ow">in</span> <span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">]:</span>
</span><span id="MasterState.update_master_state-284"><a href="#MasterState.update_master_state-284"><span class="linenos">284</span></a>                <span class="n">new_utxo_value_input</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState.update_master_state-285"><a href="#MasterState.update_master_state-285"><span class="linenos">285</span></a>                <span class="n">new_utxo_value_input</span><span class="p">[</span><span class="s1">&#39;unlocking_public_key_hash&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;unlocking_public_key_hash&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-286"><a href="#MasterState.update_master_state-286"><span class="linenos">286</span></a>                <span class="c1">#special process Smart Contract</span>
</span><span id="MasterState.update_master_state-287"><a href="#MasterState.update_master_state-287"><span class="linenos">287</span></a>                <span class="c1">#when there is &quot;SC&quot; in unlocking_public_key_hash ex: &quot;31f2ac8088005412c7b031a6e342b17a65a48d01 SC f998212b2adc762f114c9ec2b0b2d9bd6c811688</span>
</span><span id="MasterState.update_master_state-288"><a href="#MasterState.update_master_state-288"><span class="linenos">288</span></a>                <span class="n">account_credit_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_account_list_from_unlocking_public_key_hash</span><span class="p">(</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;unlocking_public_key_hash&#39;</span><span class="p">]))</span>
</span><span id="MasterState.update_master_state-289"><a href="#MasterState.update_master_state-289"><span class="linenos">289</span></a>                <span class="n">new_utxo_value_input</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-290"><a href="#MasterState.update_master_state-290"><span class="linenos">290</span></a>                <span class="n">new_utxo_value_input</span><span class="p">[</span><span class="s1">&#39;transaction_hash&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;transaction_hash&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-291"><a href="#MasterState.update_master_state-291"><span class="linenos">291</span></a>                <span class="n">new_utxo_value_input</span><span class="p">[</span><span class="s1">&#39;output_index&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;output_index&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-292"><a href="#MasterState.update_master_state-292"><span class="linenos">292</span></a>                <span class="n">new_utxo_value_input_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_utxo_value_input</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-293"><a href="#MasterState.update_master_state-293"><span class="linenos">293</span></a>
</span><span id="MasterState.update_master_state-294"><a href="#MasterState.update_master_state-294"><span class="linenos">294</span></a>
</span><span id="MasterState.update_master_state-295"><a href="#MasterState.update_master_state-295"><span class="linenos">295</span></a>            <span class="k">for</span> <span class="n">utxo</span> <span class="ow">in</span> <span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;outputs&#39;</span><span class="p">]:</span>
</span><span id="MasterState.update_master_state-296"><a href="#MasterState.update_master_state-296"><span class="linenos">296</span></a>                <span class="c1">#removal of amount in account</span>
</span><span id="MasterState.update_master_state-297"><a href="#MasterState.update_master_state-297"><span class="linenos">297</span></a>                <span class="n">new_utxo_key</span><span class="o">=</span><span class="n">transaction_hash</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">output_index</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-298"><a href="#MasterState.update_master_state-298"><span class="linenos">298</span></a>                <span class="n">new_utxo_value_output</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState.update_master_state-299"><a href="#MasterState.update_master_state-299"><span class="linenos">299</span></a>                <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-300"><a href="#MasterState.update_master_state-300"><span class="linenos">300</span></a>                <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;locking_script&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;locking_script&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-301"><a href="#MasterState.update_master_state-301"><span class="linenos">301</span></a>                <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-302"><a href="#MasterState.update_master_state-302"><span class="linenos">302</span></a>                <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;transaction_hash&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">transaction_hash</span>
</span><span id="MasterState.update_master_state-303"><a href="#MasterState.update_master_state-303"><span class="linenos">303</span></a>                <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">timestamp</span>
</span><span id="MasterState.update_master_state-304"><a href="#MasterState.update_master_state-304"><span class="linenos">304</span></a>                <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;output_index&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">output_index</span>
</span><span id="MasterState.update_master_state-305"><a href="#MasterState.update_master_state-305"><span class="linenos">305</span></a>                <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;fee_interface&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;fee_interface&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-306"><a href="#MasterState.update_master_state-306"><span class="linenos">306</span></a>                <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;fee_miner&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;fee_miner&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-307"><a href="#MasterState.update_master_state-307"><span class="linenos">307</span></a>                <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;fee_node&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;fee_node&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-308"><a href="#MasterState.update_master_state-308"><span class="linenos">308</span></a>                <span class="k">try</span><span class="p">:</span><span class="n">marketplace_transaction_flag</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;marketplace_transaction_flag&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-309"><a href="#MasterState.update_master_state-309"><span class="linenos">309</span></a>                <span class="k">except</span><span class="p">:</span><span class="n">marketplace_transaction_flag</span><span class="o">=</span><span class="kc">False</span>
</span><span id="MasterState.update_master_state-310"><a href="#MasterState.update_master_state-310"><span class="linenos">310</span></a>                <span class="k">try</span><span class="p">:</span><span class="n">smart_contract_transaction_flag</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_transaction_flag&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-311"><a href="#MasterState.update_master_state-311"><span class="linenos">311</span></a>                <span class="k">except</span><span class="p">:</span><span class="n">smart_contract_transaction_flag</span><span class="o">=</span><span class="kc">False</span>
</span><span id="MasterState.update_master_state-312"><a href="#MasterState.update_master_state-312"><span class="linenos">312</span></a>                <span class="n">account_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_account_list_from_locking_script</span><span class="p">(</span><span class="s2">&quot;OP_SC&quot;</span><span class="p">,</span><span class="n">utxo</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-313"><a href="#MasterState.update_master_state-313"><span class="linenos">313</span></a>                <span class="c1">#logging.info(f&quot;====&gt;account_list:{account_list}&quot;)</span>
</span><span id="MasterState.update_master_state-314"><a href="#MasterState.update_master_state-314"><span class="linenos">314</span></a>                
</span><span id="MasterState.update_master_state-315"><a href="#MasterState.update_master_state-315"><span class="linenos">315</span></a>                <span class="c1">#reputation account management</span>
</span><span id="MasterState.update_master_state-316"><a href="#MasterState.update_master_state-316"><span class="linenos">316</span></a>                <span class="k">if</span> <span class="s2">&quot;OP_RE&quot;</span> <span class="ow">in</span> <span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;locking_script&#39;</span><span class="p">]:</span>
</span><span id="MasterState.update_master_state-317"><a href="#MasterState.update_master_state-317"><span class="linenos">317</span></a>                    <span class="n">reputation_acount</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_account_list_from_locking_script</span><span class="p">(</span><span class="s2">&quot;OP_SC&quot;</span><span class="p">,</span><span class="n">utxo</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-318"><a href="#MasterState.update_master_state-318"><span class="linenos">318</span></a>                    <span class="c1">#logging.info(f&quot;====&gt;reputation_acount1:{reputation_acount}&quot;)</span>
</span><span id="MasterState.update_master_state-319"><a href="#MasterState.update_master_state-319"><span class="linenos">319</span></a>
</span><span id="MasterState.update_master_state-320"><a href="#MasterState.update_master_state-320"><span class="linenos">320</span></a>                <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;account_list&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">account_list</span>
</span><span id="MasterState.update_master_state-321"><a href="#MasterState.update_master_state-321"><span class="linenos">321</span></a>                <span class="n">marketplace_place_step4_flag</span><span class="o">=</span><span class="kc">False</span>
</span><span id="MasterState.update_master_state-322"><a href="#MasterState.update_master_state-322"><span class="linenos">322</span></a>                <span class="n">marketplace_place_step4_buyer</span><span class="o">=</span><span class="kc">None</span>
</span><span id="MasterState.update_master_state-323"><a href="#MasterState.update_master_state-323"><span class="linenos">323</span></a>                <span class="n">marketplace_place_step4_seller</span><span class="o">=</span><span class="kc">None</span>
</span><span id="MasterState.update_master_state-324"><a href="#MasterState.update_master_state-324"><span class="linenos">324</span></a>                <span class="n">marketplace_place_step4_requested_amount</span><span class="o">=</span><span class="kc">None</span>
</span><span id="MasterState.update_master_state-325"><a href="#MasterState.update_master_state-325"><span class="linenos">325</span></a>                <span class="n">marketplace_place_step4_requested_currency</span><span class="o">=</span><span class="kc">None</span>
</span><span id="MasterState.update_master_state-326"><a href="#MasterState.update_master_state-326"><span class="linenos">326</span></a>                <span class="n">marketplace_place_step4</span><span class="o">=</span><span class="mi">0</span>
</span><span id="MasterState.update_master_state-327"><a href="#MasterState.update_master_state-327"><span class="linenos">327</span></a>                <span class="n">marketplace_place_step4_requested_nig</span><span class="o">=</span><span class="mi">0</span>
</span><span id="MasterState.update_master_state-328"><a href="#MasterState.update_master_state-328"><span class="linenos">328</span></a>                <span class="n">marketplace_place_archiving_flag</span><span class="o">=</span><span class="kc">False</span>
</span><span id="MasterState.update_master_state-329"><a href="#MasterState.update_master_state-329"><span class="linenos">329</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-330"><a href="#MasterState.update_master_state-330"><span class="linenos">330</span></a>                    <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_sender&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_sender&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-331"><a href="#MasterState.update_master_state-331"><span class="linenos">331</span></a>                    <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_new&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_new&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-332"><a href="#MasterState.update_master_state-332"><span class="linenos">332</span></a>                    <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_account&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_account&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-333"><a href="#MasterState.update_master_state-333"><span class="linenos">333</span></a>                    <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_flag&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_flag&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-334"><a href="#MasterState.update_master_state-334"><span class="linenos">334</span></a>                    <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_gas&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_gas&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-335"><a href="#MasterState.update_master_state-335"><span class="linenos">335</span></a>                    <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_memory&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_memory&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-336"><a href="#MasterState.update_master_state-336"><span class="linenos">336</span></a>                    <span class="c1">#check if the transaction is in step 4 or 45 (partial payment) or 66 (payment default) or 98 (expiration) or 99 (cancellation) to put in Marketplace_archive if needed</span>
</span><span id="MasterState.update_master_state-337"><a href="#MasterState.update_master_state-337"><span class="linenos">337</span></a>                    <span class="n">smart_contract_memory</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_memory&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-338"><a href="#MasterState.update_master_state-338"><span class="linenos">338</span></a>                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">])):</span>
</span><span id="MasterState.update_master_state-339"><a href="#MasterState.update_master_state-339"><span class="linenos">339</span></a>                        <span class="k">if</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;step&#39;</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-340"><a href="#MasterState.update_master_state-340"><span class="linenos">340</span></a>                            <span class="k">if</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">4</span> <span class="ow">or</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">45</span> <span class="ow">or</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">66</span> <span class="ow">or</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">98</span> <span class="ow">or</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">99</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-341"><a href="#MasterState.update_master_state-341"><span class="linenos">341</span></a>                                <span class="n">marketplace_place_step4</span><span class="o">=</span><span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-342"><a href="#MasterState.update_master_state-342"><span class="linenos">342</span></a>                                <span class="n">marketplace_place_step4_flag</span><span class="o">=</span><span class="kc">True</span>
</span><span id="MasterState.update_master_state-343"><a href="#MasterState.update_master_state-343"><span class="linenos">343</span></a>                                <span class="c1">#step = 99 is used to archive the cancelled marketplace request </span>
</span><span id="MasterState.update_master_state-344"><a href="#MasterState.update_master_state-344"><span class="linenos">344</span></a>                                <span class="k">if</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">99</span><span class="p">:</span><span class="n">marketplace_place_archiving_flag</span><span class="o">=</span><span class="kc">True</span>
</span><span id="MasterState.update_master_state-345"><a href="#MasterState.update_master_state-345"><span class="linenos">345</span></a>                                <span class="c1">#step = 98 is used to archive the expired marketplace request </span>
</span><span id="MasterState.update_master_state-346"><a href="#MasterState.update_master_state-346"><span class="linenos">346</span></a>                                <span class="k">if</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">98</span><span class="p">:</span><span class="n">marketplace_place_archiving_flag</span><span class="o">=</span><span class="kc">True</span>
</span><span id="MasterState.update_master_state-347"><a href="#MasterState.update_master_state-347"><span class="linenos">347</span></a>                                <span class="c1">#logging.info(f&quot;======&gt; MarketPlace {smart_contract_memory[0][3][j]}: {transaction_hash}&quot;)</span>
</span><span id="MasterState.update_master_state-348"><a href="#MasterState.update_master_state-348"><span class="linenos">348</span></a>                        <span class="k">if</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;requested_amount&#39;</span><span class="p">:</span><span class="n">marketplace_place_step4_requested_amount</span><span class="o">=</span><span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-349"><a href="#MasterState.update_master_state-349"><span class="linenos">349</span></a>                        <span class="k">if</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;requested_currency&#39;</span><span class="p">:</span><span class="n">marketplace_place_step4_requested_currency</span><span class="o">=</span><span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-350"><a href="#MasterState.update_master_state-350"><span class="linenos">350</span></a>                        <span class="k">if</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;buyer_public_key_hash&#39;</span><span class="p">:</span><span class="n">marketplace_place_step4_buyer</span><span class="o">=</span><span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-351"><a href="#MasterState.update_master_state-351"><span class="linenos">351</span></a>                        <span class="k">if</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;seller_public_key_hash&#39;</span><span class="p">:</span><span class="n">marketplace_place_step4_seller</span><span class="o">=</span><span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-352"><a href="#MasterState.update_master_state-352"><span class="linenos">352</span></a>                        <span class="k">if</span> <span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;requested_nig&#39;</span><span class="p">:</span><span class="n">marketplace_place_step4_requested_nig</span><span class="o">=</span><span class="n">smart_contract_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-353"><a href="#MasterState.update_master_state-353"><span class="linenos">353</span></a>                        
</span><span id="MasterState.update_master_state-354"><a href="#MasterState.update_master_state-354"><span class="linenos">354</span></a>                        
</span><span id="MasterState.update_master_state-355"><a href="#MasterState.update_master_state-355"><span class="linenos">355</span></a>
</span><span id="MasterState.update_master_state-356"><a href="#MasterState.update_master_state-356"><span class="linenos">356</span></a>                    <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_memory_size&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_memory_size&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-357"><a href="#MasterState.update_master_state-357"><span class="linenos">357</span></a>                    <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_type&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_type&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-358"><a href="#MasterState.update_master_state-358"><span class="linenos">358</span></a>                    <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_payload&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_payload&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-359"><a href="#MasterState.update_master_state-359"><span class="linenos">359</span></a>                    <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_result&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_result&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-360"><a href="#MasterState.update_master_state-360"><span class="linenos">360</span></a>                    <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_transaction_hash&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">new_utxo_key</span>
</span><span id="MasterState.update_master_state-361"><a href="#MasterState.update_master_state-361"><span class="linenos">361</span></a>                    <span class="k">if</span> <span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_type&#39;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;source&quot;</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-362"><a href="#MasterState.update_master_state-362"><span class="linenos">362</span></a>                        <span class="c1">#smart_contract_previous_transaction is only updated with source call</span>
</span><span id="MasterState.update_master_state-363"><a href="#MasterState.update_master_state-363"><span class="linenos">363</span></a>                        <span class="k">if</span> <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_new&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span><span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_previous_transaction&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span>
</span><span id="MasterState.update_master_state-364"><a href="#MasterState.update_master_state-364"><span class="linenos">364</span></a>                        <span class="k">else</span><span class="p">:</span><span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_previous_transaction&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_previous_transaction&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-365"><a href="#MasterState.update_master_state-365"><span class="linenos">365</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-366"><a href="#MasterState.update_master_state-366"><span class="linenos">366</span></a>                        <span class="c1">#smart_contract_previous_transaction is not updated with API call</span>
</span><span id="MasterState.update_master_state-367"><a href="#MasterState.update_master_state-367"><span class="linenos">367</span></a>                        <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_previous_transaction&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_previous_transaction&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-368"><a href="#MasterState.update_master_state-368"><span class="linenos">368</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-369"><a href="#MasterState.update_master_state-369"><span class="linenos">369</span></a>                    <span class="k">pass</span>
</span><span id="MasterState.update_master_state-370"><a href="#MasterState.update_master_state-370"><span class="linenos">370</span></a>
</span><span id="MasterState.update_master_state-371"><a href="#MasterState.update_master_state-371"><span class="linenos">371</span></a>
</span><span id="MasterState.update_master_state-372"><a href="#MasterState.update_master_state-372"><span class="linenos">372</span></a>                <span class="k">for</span> <span class="n">account</span> <span class="ow">in</span> <span class="n">account_list</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-373"><a href="#MasterState.update_master_state-373"><span class="linenos">373</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-374"><a href="#MasterState.update_master_state-374"><span class="linenos">374</span></a>                        <span class="c1">#there are values for this account, let&#39;s update them</span>
</span><span id="MasterState.update_master_state-375"><a href="#MasterState.update_master_state-375"><span class="linenos">375</span></a>                        <span class="n">account_dic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-376"><a href="#MasterState.update_master_state-376"><span class="linenos">376</span></a>                        <span class="k">if</span> <span class="n">account_dic</span><span class="o">==</span><span class="p">{}:</span>
</span><span id="MasterState.update_master_state-377"><a href="#MasterState.update_master_state-377"><span class="linenos">377</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
</span><span id="MasterState.update_master_state-378"><a href="#MasterState.update_master_state-378"><span class="linenos">378</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
</span><span id="MasterState.update_master_state-379"><a href="#MasterState.update_master_state-379"><span class="linenos">379</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState.update_master_state-380"><a href="#MasterState.update_master_state-380"><span class="linenos">380</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos_data&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState.update_master_state-381"><a href="#MasterState.update_master_state-381"><span class="linenos">381</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;marketplace&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
</span><span id="MasterState.update_master_state-382"><a href="#MasterState.update_master_state-382"><span class="linenos">382</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;marketplace_archive&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
</span><span id="MasterState.update_master_state-383"><a href="#MasterState.update_master_state-383"><span class="linenos">383</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;reputation&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
</span><span id="MasterState.update_master_state-384"><a href="#MasterState.update_master_state-384"><span class="linenos">384</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;smart_contract&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
</span><span id="MasterState.update_master_state-385"><a href="#MasterState.update_master_state-385"><span class="linenos">385</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState.update_master_state-386"><a href="#MasterState.update_master_state-386"><span class="linenos">386</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState.update_master_state-387"><a href="#MasterState.update_master_state-387"><span class="linenos">387</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;debit&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState.update_master_state-388"><a href="#MasterState.update_master_state-388"><span class="linenos">388</span></a>
</span><span id="MasterState.update_master_state-389"><a href="#MasterState.update_master_state-389"><span class="linenos">389</span></a>                    <span class="k">except</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-390"><a href="#MasterState.update_master_state-390"><span class="linenos">390</span></a>                        <span class="c1">#there is no value for this account, let&#39;s create them</span>
</span><span id="MasterState.update_master_state-391"><a href="#MasterState.update_master_state-391"><span class="linenos">391</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState.update_master_state-392"><a href="#MasterState.update_master_state-392"><span class="linenos">392</span></a>                        <span class="n">account_dic</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState.update_master_state-393"><a href="#MasterState.update_master_state-393"><span class="linenos">393</span></a>                        <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
</span><span id="MasterState.update_master_state-394"><a href="#MasterState.update_master_state-394"><span class="linenos">394</span></a>                        <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState.update_master_state-395"><a href="#MasterState.update_master_state-395"><span class="linenos">395</span></a>                        <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
</span><span id="MasterState.update_master_state-396"><a href="#MasterState.update_master_state-396"><span class="linenos">396</span></a>                        <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos_data&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState.update_master_state-397"><a href="#MasterState.update_master_state-397"><span class="linenos">397</span></a>                        <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;marketplace&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
</span><span id="MasterState.update_master_state-398"><a href="#MasterState.update_master_state-398"><span class="linenos">398</span></a>                        <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;marketplace_archive&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
</span><span id="MasterState.update_master_state-399"><a href="#MasterState.update_master_state-399"><span class="linenos">399</span></a>                        <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;reputation&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
</span><span id="MasterState.update_master_state-400"><a href="#MasterState.update_master_state-400"><span class="linenos">400</span></a>                        <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;smart_contract&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
</span><span id="MasterState.update_master_state-401"><a href="#MasterState.update_master_state-401"><span class="linenos">401</span></a>                        <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState.update_master_state-402"><a href="#MasterState.update_master_state-402"><span class="linenos">402</span></a>                        <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState.update_master_state-403"><a href="#MasterState.update_master_state-403"><span class="linenos">403</span></a>                        <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;debit&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState.update_master_state-404"><a href="#MasterState.update_master_state-404"><span class="linenos">404</span></a>                    
</span><span id="MasterState.update_master_state-405"><a href="#MasterState.update_master_state-405"><span class="linenos">405</span></a>                    <span class="k">if</span> <span class="n">marketplace_transaction_flag</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">smart_contract_transaction_flag</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">or</span> <span class="n">account</span><span class="o">==</span><span class="n">account_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="MasterState.update_master_state-406"><a href="#MasterState.update_master_state-406"><span class="linenos">406</span></a>                        <span class="c1">#account==account_list[0] means that it&#39;s the datas of the SmartContract so we need to update the data of the Smart Contract</span>
</span><span id="MasterState.update_master_state-407"><a href="#MasterState.update_master_state-407"><span class="linenos">407</span></a>                        <span class="k">if</span> <span class="n">account_dic</span><span class="o">!=</span><span class="p">{}:</span>
</span><span id="MasterState.update_master_state-408"><a href="#MasterState.update_master_state-408"><span class="linenos">408</span></a>                            <span class="k">if</span> <span class="n">new_utxo_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos&#39;</span><span class="p">]:</span>
</span><span id="MasterState.update_master_state-409"><a href="#MasterState.update_master_state-409"><span class="linenos">409</span></a>                                <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span><span class="o">+=</span><span class="n">normal_round</span><span class="p">(</span><span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">],</span><span class="n">ROUND_VALUE_DIGIT</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-410"><a href="#MasterState.update_master_state-410"><span class="linenos">410</span></a>                                <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_utxo_key</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-411"><a href="#MasterState.update_master_state-411"><span class="linenos">411</span></a>                                <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos_data&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState.update_master_state-412"><a href="#MasterState.update_master_state-412"><span class="linenos">412</span></a>                                <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos_data&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">new_utxo_value_output</span>
</span><span id="MasterState.update_master_state-413"><a href="#MasterState.update_master_state-413"><span class="linenos">413</span></a>                                <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos_data&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">][</span><span class="s1">&#39;input&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">new_utxo_value_input_list</span>
</span><span id="MasterState.update_master_state-414"><a href="#MasterState.update_master_state-414"><span class="linenos">414</span></a>                                <span class="c1">#update of balance</span>
</span><span id="MasterState.update_master_state-415"><a href="#MasterState.update_master_state-415"><span class="linenos">415</span></a>                                <span class="k">if</span> <span class="n">old_utxo_key</span><span class="o">==</span><span class="n">account</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-416"><a href="#MasterState.update_master_state-416"><span class="linenos">416</span></a>                                    <span class="c1">#try:account_dic[&#39;balance&#39;][&#39;credit&#39;].pop(old_utxo_key)</span>
</span><span id="MasterState.update_master_state-417"><a href="#MasterState.update_master_state-417"><span class="linenos">417</span></a>                                    <span class="c1">#except:pass</span>
</span><span id="MasterState.update_master_state-418"><a href="#MasterState.update_master_state-418"><span class="linenos">418</span></a>                                    <span class="k">pass</span>
</span><span id="MasterState.update_master_state-419"><a href="#MasterState.update_master_state-419"><span class="linenos">419</span></a>                                <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;account_credit_list&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">account_credit_list</span>
</span><span id="MasterState.update_master_state-420"><a href="#MasterState.update_master_state-420"><span class="linenos">420</span></a>                                <span class="c1">#if old_utxo_account is not None and old_utxo_account!=account:account_dic[&#39;balance&#39;][&#39;credit&#39;][new_utxo_key]=new_utxo_value_output</span>
</span><span id="MasterState.update_master_state-421"><a href="#MasterState.update_master_state-421"><span class="linenos">421</span></a>                                <span class="c1">#if old_utxo_account is not None and old_utxo_account!=account:self.update_old_utxo_key(old_utxo_account,old_utxo_key,account,new_utxo_value_output)</span>
</span><span id="MasterState.update_master_state-422"><a href="#MasterState.update_master_state-422"><span class="linenos">422</span></a>                                <span class="c1">#if old_utxo_account!=account:account_dic[&#39;balance&#39;][&#39;credit&#39;][new_utxo_key]=new_utxo_value_output</span>
</span><span id="MasterState.update_master_state-423"><a href="#MasterState.update_master_state-423"><span class="linenos">423</span></a>
</span><span id="MasterState.update_master_state-424"><a href="#MasterState.update_master_state-424"><span class="linenos">424</span></a>                                <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-425"><a href="#MasterState.update_master_state-425"><span class="linenos">425</span></a>                                    <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_flag&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_flag&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-426"><a href="#MasterState.update_master_state-426"><span class="linenos">426</span></a>                                    <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">]</span><span class="o">=</span><span class="n">new_utxo_value_output</span>
</span><span id="MasterState.update_master_state-427"><a href="#MasterState.update_master_state-427"><span class="linenos">427</span></a>                                    <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">][</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-428"><a href="#MasterState.update_master_state-428"><span class="linenos">428</span></a>                                <span class="k">except</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-429"><a href="#MasterState.update_master_state-429"><span class="linenos">429</span></a>                                    <span class="k">if</span> <span class="n">old_utxo_account</span><span class="o">!=</span><span class="n">account</span><span class="p">:</span><span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">]</span><span class="o">=</span><span class="n">new_utxo_value_output</span>
</span><span id="MasterState.update_master_state-430"><a href="#MasterState.update_master_state-430"><span class="linenos">430</span></a>                        
</span><span id="MasterState.update_master_state-431"><a href="#MasterState.update_master_state-431"><span class="linenos">431</span></a>                                <span class="k">if</span> <span class="n">old_utxo_account</span><span class="o">!=</span><span class="n">account</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">update_old_utxo_key</span><span class="p">(</span><span class="n">old_utxo_account</span><span class="p">,</span><span class="n">old_utxo_key</span><span class="p">,</span><span class="n">new_utxo_key</span><span class="p">,</span><span class="n">new_utxo_value_output</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-432"><a href="#MasterState.update_master_state-432"><span class="linenos">432</span></a>                            
</span><span id="MasterState.update_master_state-433"><a href="#MasterState.update_master_state-433"><span class="linenos">433</span></a>                                <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">]</span><span class="o">=</span><span class="n">new_utxo_value_output</span>
</span><span id="MasterState.update_master_state-434"><a href="#MasterState.update_master_state-434"><span class="linenos">434</span></a>                                <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">][</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-435"><a href="#MasterState.update_master_state-435"><span class="linenos">435</span></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span><span class="o">=</span><span class="n">account_dic</span>
</span><span id="MasterState.update_master_state-436"><a href="#MasterState.update_master_state-436"><span class="linenos">436</span></a>
</span><span id="MasterState.update_master_state-437"><a href="#MasterState.update_master_state-437"><span class="linenos">437</span></a>                            <span class="k">if</span> <span class="n">marketplace_place_step4_flag</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-438"><a href="#MasterState.update_master_state-438"><span class="linenos">438</span></a>                                <span class="c1">#this is transaction fully validated (step 4, 45, 66, 98 or 99)</span>
</span><span id="MasterState.update_master_state-439"><a href="#MasterState.update_master_state-439"><span class="linenos">439</span></a>                                <span class="c1">#let&#39;s archive it in the associated account to increase speed</span>
</span><span id="MasterState.update_master_state-440"><a href="#MasterState.update_master_state-440"><span class="linenos">440</span></a>                                <span class="k">if</span> <span class="n">marketplace_place_archiving_flag</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span><span class="n">associated_account_dic_step4_list</span><span class="o">=</span><span class="p">[</span><span class="n">marketplace_place_step4_buyer</span><span class="p">,</span><span class="n">marketplace_place_step4_seller</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-441"><a href="#MasterState.update_master_state-441"><span class="linenos">441</span></a>                                <span class="k">else</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-442"><a href="#MasterState.update_master_state-442"><span class="linenos">442</span></a>                                    <span class="c1">#this is an expired request which needs to be archived</span>
</span><span id="MasterState.update_master_state-443"><a href="#MasterState.update_master_state-443"><span class="linenos">443</span></a>                                    <span class="c1">#marketplace_place_step4_seller can be None in that case (ex:if step = 1)</span>
</span><span id="MasterState.update_master_state-444"><a href="#MasterState.update_master_state-444"><span class="linenos">444</span></a>                                    <span class="k">if</span> <span class="n">marketplace_place_step4_seller</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">marketplace_place_step4_seller</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span><span class="n">associated_account_dic_step4_list</span><span class="o">=</span><span class="p">[</span><span class="n">marketplace_place_step4_buyer</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-445"><a href="#MasterState.update_master_state-445"><span class="linenos">445</span></a>                                    <span class="k">else</span><span class="p">:</span><span class="n">associated_account_dic_step4_list</span><span class="o">=</span><span class="p">[</span><span class="n">marketplace_place_step4_buyer</span><span class="p">,</span><span class="n">marketplace_place_step4_seller</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-446"><a href="#MasterState.update_master_state-446"><span class="linenos">446</span></a>                                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;INFO ### associated_account_dic_step4_list:</span><span class="si">{</span><span class="n">associated_account_dic_step4_list</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-447"><a href="#MasterState.update_master_state-447"><span class="linenos">447</span></a>                                <span class="n">step</span><span class="o">=</span><span class="mi">0</span>
</span><span id="MasterState.update_master_state-448"><a href="#MasterState.update_master_state-448"><span class="linenos">448</span></a>                                <span class="k">for</span> <span class="n">associated_account_dic_step4</span> <span class="ow">in</span> <span class="n">associated_account_dic_step4_list</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-449"><a href="#MasterState.update_master_state-449"><span class="linenos">449</span></a>                                    <span class="n">step</span><span class="o">+=</span><span class="mi">1</span>
</span><span id="MasterState.update_master_state-450"><a href="#MasterState.update_master_state-450"><span class="linenos">450</span></a>                                    <span class="n">associated_account_dic_step4_to_update</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">associated_account_dic_step4</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-451"><a href="#MasterState.update_master_state-451"><span class="linenos">451</span></a>                                    <span class="k">if</span> <span class="n">account_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_archive&#39;</span><span class="p">]:</span><span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_archive&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">account_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="MasterState.update_master_state-452"><a href="#MasterState.update_master_state-452"><span class="linenos">452</span></a>                                    <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-453"><a href="#MasterState.update_master_state-453"><span class="linenos">453</span></a>                                        <span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">account_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="MasterState.update_master_state-454"><a href="#MasterState.update_master_state-454"><span class="linenos">454</span></a>                                        <span class="c1">#update of added value/gain</span>
</span><span id="MasterState.update_master_state-455"><a href="#MasterState.update_master_state-455"><span class="linenos">455</span></a>                                        <span class="k">if</span> <span class="n">marketplace_place_step4</span><span class="o">==</span><span class="mi">4</span> <span class="ow">or</span> <span class="n">marketplace_place_step4</span><span class="o">==</span><span class="mi">45</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-456"><a href="#MasterState.update_master_state-456"><span class="linenos">456</span></a>                                            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;INFO ### marketplace_place added value&quot;</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-457"><a href="#MasterState.update_master_state-457"><span class="linenos">457</span></a>                                            <span class="k">try</span><span class="p">:</span><span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-458"><a href="#MasterState.update_master_state-458"><span class="linenos">458</span></a>                                            <span class="k">except</span><span class="p">:</span><span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState.update_master_state-459"><a href="#MasterState.update_master_state-459"><span class="linenos">459</span></a>                                            <span class="k">try</span><span class="p">:</span><span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">][</span><span class="n">marketplace_place_step4_requested_currency</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-460"><a href="#MasterState.update_master_state-460"><span class="linenos">460</span></a>                                            <span class="k">except</span><span class="p">:</span><span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">][</span><span class="n">marketplace_place_step4_requested_currency</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState.update_master_state-461"><a href="#MasterState.update_master_state-461"><span class="linenos">461</span></a>                                            <span class="k">if</span> <span class="n">step</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-462"><a href="#MasterState.update_master_state-462"><span class="linenos">462</span></a>                                                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;INFO ### marketplace_place added value buyer&quot;</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-463"><a href="#MasterState.update_master_state-463"><span class="linenos">463</span></a>                                                <span class="c1">#this is the buyer</span>
</span><span id="MasterState.update_master_state-464"><a href="#MasterState.update_master_state-464"><span class="linenos">464</span></a>                                                <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-465"><a href="#MasterState.update_master_state-465"><span class="linenos">465</span></a>                                                    <span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">][</span><span class="n">marketplace_place_step4_requested_currency</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">]</span><span class="o">+=</span><span class="n">marketplace_place_step4_requested_amount</span>
</span><span id="MasterState.update_master_state-466"><a href="#MasterState.update_master_state-466"><span class="linenos">466</span></a>                                                    <span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">][</span><span class="n">marketplace_place_step4_requested_currency</span><span class="p">][</span><span class="s1">&#39;credit_nig&#39;</span><span class="p">]</span><span class="o">+=</span><span class="n">normal_round</span><span class="p">(</span><span class="n">marketplace_place_step4_requested_nig</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">DEFAULT_TRANSACTION_FEE_PERCENTAGE</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">),</span><span class="n">ROUND_VALUE_DIGIT</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-467"><a href="#MasterState.update_master_state-467"><span class="linenos">467</span></a>                                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-468"><a href="#MasterState.update_master_state-468"><span class="linenos">468</span></a>                                                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;####CHECK1###&quot;</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-469"><a href="#MasterState.update_master_state-469"><span class="linenos">469</span></a>                                                    <span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">][</span><span class="n">marketplace_place_step4_requested_currency</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">marketplace_place_step4_requested_amount</span>
</span><span id="MasterState.update_master_state-470"><a href="#MasterState.update_master_state-470"><span class="linenos">470</span></a>                                                    <span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">][</span><span class="n">marketplace_place_step4_requested_currency</span><span class="p">][</span><span class="s1">&#39;credit_nig&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">normal_round</span><span class="p">(</span><span class="n">marketplace_place_step4_requested_nig</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">DEFAULT_TRANSACTION_FEE_PERCENTAGE</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">),</span><span class="n">ROUND_VALUE_DIGIT</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-471"><a href="#MasterState.update_master_state-471"><span class="linenos">471</span></a>
</span><span id="MasterState.update_master_state-472"><a href="#MasterState.update_master_state-472"><span class="linenos">472</span></a>                                            <span class="k">if</span> <span class="n">step</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-473"><a href="#MasterState.update_master_state-473"><span class="linenos">473</span></a>                                                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;INFO ### marketplace_place added value seller&quot;</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-474"><a href="#MasterState.update_master_state-474"><span class="linenos">474</span></a>                                                <span class="c1">#this is the seller</span>
</span><span id="MasterState.update_master_state-475"><a href="#MasterState.update_master_state-475"><span class="linenos">475</span></a>                                                <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-476"><a href="#MasterState.update_master_state-476"><span class="linenos">476</span></a>                                                    <span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">][</span><span class="n">marketplace_place_step4_requested_currency</span><span class="p">][</span><span class="s1">&#39;debit&#39;</span><span class="p">]</span><span class="o">+=</span><span class="n">marketplace_place_step4_requested_amount</span>
</span><span id="MasterState.update_master_state-477"><a href="#MasterState.update_master_state-477"><span class="linenos">477</span></a>                                                    <span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">][</span><span class="n">marketplace_place_step4_requested_currency</span><span class="p">][</span><span class="s1">&#39;debit_nig&#39;</span><span class="p">]</span><span class="o">+=</span><span class="n">marketplace_place_step4_requested_nig</span>
</span><span id="MasterState.update_master_state-478"><a href="#MasterState.update_master_state-478"><span class="linenos">478</span></a>                                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-479"><a href="#MasterState.update_master_state-479"><span class="linenos">479</span></a>                                                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;####CHECK2###&quot;</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-480"><a href="#MasterState.update_master_state-480"><span class="linenos">480</span></a>                                                    <span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">][</span><span class="n">marketplace_place_step4_requested_currency</span><span class="p">][</span><span class="s1">&#39;debit&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">marketplace_place_step4_requested_amount</span>
</span><span id="MasterState.update_master_state-481"><a href="#MasterState.update_master_state-481"><span class="linenos">481</span></a>                                                    <span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_profit_details&#39;</span><span class="p">][</span><span class="n">marketplace_place_step4_requested_currency</span><span class="p">][</span><span class="s1">&#39;debit_nig&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">marketplace_place_step4_requested_nig</span>
</span><span id="MasterState.update_master_state-482"><a href="#MasterState.update_master_state-482"><span class="linenos">482</span></a>
</span><span id="MasterState.update_master_state-483"><a href="#MasterState.update_master_state-483"><span class="linenos">483</span></a>                                            <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-484"><a href="#MasterState.update_master_state-484"><span class="linenos">484</span></a>                                                <span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">account_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="MasterState.update_master_state-485"><a href="#MasterState.update_master_state-485"><span class="linenos">485</span></a>                                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-486"><a href="#MasterState.update_master_state-486"><span class="linenos">486</span></a>                                                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;marketplace_place_step4 removal issue with account: </span><span class="si">{</span><span class="n">account_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-487"><a href="#MasterState.update_master_state-487"><span class="linenos">487</span></a>                                                <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-488"><a href="#MasterState.update_master_state-488"><span class="linenos">488</span></a>
</span><span id="MasterState.update_master_state-489"><a href="#MasterState.update_master_state-489"><span class="linenos">489</span></a>
</span><span id="MasterState.update_master_state-490"><a href="#MasterState.update_master_state-490"><span class="linenos">490</span></a>                                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-491"><a href="#MasterState.update_master_state-491"><span class="linenos">491</span></a>                                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;marketplace_place_step4 removal issue with account: </span><span class="si">{</span><span class="n">account_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-492"><a href="#MasterState.update_master_state-492"><span class="linenos">492</span></a>                                        <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-493"><a href="#MasterState.update_master_state-493"><span class="linenos">493</span></a>                                    
</span><span id="MasterState.update_master_state-494"><a href="#MasterState.update_master_state-494"><span class="linenos">494</span></a>
</span><span id="MasterState.update_master_state-495"><a href="#MasterState.update_master_state-495"><span class="linenos">495</span></a>                                    <span class="n">data1</span><span class="o">=</span><span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-496"><a href="#MasterState.update_master_state-496"><span class="linenos">496</span></a>                                    <span class="n">data2</span><span class="o">=</span><span class="n">associated_account_dic_step4_to_update</span><span class="p">[</span><span class="s1">&#39;marketplace_archive&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-497"><a href="#MasterState.update_master_state-497"><span class="linenos">497</span></a>                                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;======&gt; associated_account_dic_step4: </span><span class="si">{</span><span class="n">associated_account_dic_step4</span><span class="si">}</span><span class="s2"> account_dic[&#39;marketplace&#39;]: </span><span class="si">{</span><span class="n">data1</span><span class="si">}</span><span class="s2"> account_dic[&#39;marketplace_archive&#39;] :</span><span class="si">{</span><span class="n">data2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-498"><a href="#MasterState.update_master_state-498"><span class="linenos">498</span></a>                                    <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">associated_account_dic_step4</span><span class="p">]</span><span class="o">=</span><span class="n">associated_account_dic_step4_to_update</span>
</span><span id="MasterState.update_master_state-499"><a href="#MasterState.update_master_state-499"><span class="linenos">499</span></a>                                    
</span><span id="MasterState.update_master_state-500"><a href="#MasterState.update_master_state-500"><span class="linenos">500</span></a>                                    
</span><span id="MasterState.update_master_state-501"><a href="#MasterState.update_master_state-501"><span class="linenos">501</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-502"><a href="#MasterState.update_master_state-502"><span class="linenos">502</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span><span class="o">+=</span><span class="n">normal_round</span><span class="p">(</span><span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">],</span><span class="n">ROUND_VALUE_DIGIT</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-503"><a href="#MasterState.update_master_state-503"><span class="linenos">503</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_utxo_key</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-504"><a href="#MasterState.update_master_state-504"><span class="linenos">504</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos_data&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState.update_master_state-505"><a href="#MasterState.update_master_state-505"><span class="linenos">505</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos_data&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">new_utxo_value_output</span>
</span><span id="MasterState.update_master_state-506"><a href="#MasterState.update_master_state-506"><span class="linenos">506</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;utxos_data&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">][</span><span class="s1">&#39;input&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">new_utxo_value_input_list</span>
</span><span id="MasterState.update_master_state-507"><a href="#MasterState.update_master_state-507"><span class="linenos">507</span></a>                            <span class="c1">#update of balance</span>
</span><span id="MasterState.update_master_state-508"><a href="#MasterState.update_master_state-508"><span class="linenos">508</span></a>                            <span class="k">if</span> <span class="n">old_utxo_key</span><span class="o">==</span><span class="n">account</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-509"><a href="#MasterState.update_master_state-509"><span class="linenos">509</span></a>                                <span class="c1">#try:account_dic[&#39;balance&#39;][&#39;credit&#39;].pop(old_utxo_key)</span>
</span><span id="MasterState.update_master_state-510"><a href="#MasterState.update_master_state-510"><span class="linenos">510</span></a>                                <span class="c1">#except:pass</span>
</span><span id="MasterState.update_master_state-511"><a href="#MasterState.update_master_state-511"><span class="linenos">511</span></a>                                <span class="k">pass</span>
</span><span id="MasterState.update_master_state-512"><a href="#MasterState.update_master_state-512"><span class="linenos">512</span></a>                            <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;account_credit_list&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">account_credit_list</span>
</span><span id="MasterState.update_master_state-513"><a href="#MasterState.update_master_state-513"><span class="linenos">513</span></a>                            <span class="c1">#if old_utxo_account is not None and old_utxo_account!=account:account_dic[&#39;balance&#39;][&#39;credit&#39;][new_utxo_key]=new_utxo_value_output</span>
</span><span id="MasterState.update_master_state-514"><a href="#MasterState.update_master_state-514"><span class="linenos">514</span></a>                            <span class="c1">#if old_utxo_account is not None and old_utxo_account!=account:self.update_old_utxo_key(old_utxo_account,old_utxo_key,new_utxo_key,new_utxo_value_output)</span>
</span><span id="MasterState.update_master_state-515"><a href="#MasterState.update_master_state-515"><span class="linenos">515</span></a>                            <span class="c1">#if old_utxo_account!=account:account_dic[&#39;balance&#39;][&#39;credit&#39;][new_utxo_key]=new_utxo_value_output</span>
</span><span id="MasterState.update_master_state-516"><a href="#MasterState.update_master_state-516"><span class="linenos">516</span></a>                        
</span><span id="MasterState.update_master_state-517"><a href="#MasterState.update_master_state-517"><span class="linenos">517</span></a>                            <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-518"><a href="#MasterState.update_master_state-518"><span class="linenos">518</span></a>                                <span class="n">new_utxo_value_output</span><span class="p">[</span><span class="s1">&#39;smart_contract_flag&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;smart_contract_flag&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-519"><a href="#MasterState.update_master_state-519"><span class="linenos">519</span></a>                                <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">]</span><span class="o">=</span><span class="n">new_utxo_value_output</span>
</span><span id="MasterState.update_master_state-520"><a href="#MasterState.update_master_state-520"><span class="linenos">520</span></a>                                <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">][</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-521"><a href="#MasterState.update_master_state-521"><span class="linenos">521</span></a>                            <span class="k">except</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-522"><a href="#MasterState.update_master_state-522"><span class="linenos">522</span></a>                                <span class="k">if</span> <span class="n">old_utxo_account</span><span class="o">!=</span><span class="n">account</span><span class="p">:</span><span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">]</span><span class="o">=</span><span class="n">new_utxo_value_output</span>
</span><span id="MasterState.update_master_state-523"><a href="#MasterState.update_master_state-523"><span class="linenos">523</span></a>                        
</span><span id="MasterState.update_master_state-524"><a href="#MasterState.update_master_state-524"><span class="linenos">524</span></a>                            <span class="k">if</span> <span class="n">old_utxo_account</span><span class="o">!=</span><span class="n">account</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">update_old_utxo_key</span><span class="p">(</span><span class="n">old_utxo_account</span><span class="p">,</span><span class="n">old_utxo_key</span><span class="p">,</span><span class="n">new_utxo_key</span><span class="p">,</span><span class="n">new_utxo_value_output</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-525"><a href="#MasterState.update_master_state-525"><span class="linenos">525</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">]</span><span class="o">=</span><span class="n">new_utxo_value_output</span>
</span><span id="MasterState.update_master_state-526"><a href="#MasterState.update_master_state-526"><span class="linenos">526</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;credit&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">][</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-527"><a href="#MasterState.update_master_state-527"><span class="linenos">527</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span><span class="o">=</span><span class="n">account_dic</span>
</span><span id="MasterState.update_master_state-528"><a href="#MasterState.update_master_state-528"><span class="linenos">528</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-529"><a href="#MasterState.update_master_state-529"><span class="linenos">529</span></a>                        <span class="c1">#account_list[0] is the Smart Contract account</span>
</span><span id="MasterState.update_master_state-530"><a href="#MasterState.update_master_state-530"><span class="linenos">530</span></a>                        <span class="c1">#account_list[1 and + ] are the other account associated to that Smart Contrat</span>
</span><span id="MasterState.update_master_state-531"><a href="#MasterState.update_master_state-531"><span class="linenos">531</span></a>                        <span class="k">if</span> <span class="n">marketplace_transaction_flag</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">marketplace_place_step4_flag</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-532"><a href="#MasterState.update_master_state-532"><span class="linenos">532</span></a>                            <span class="c1">#this is a marketplace transaction</span>
</span><span id="MasterState.update_master_state-533"><a href="#MasterState.update_master_state-533"><span class="linenos">533</span></a>                            <span class="k">if</span> <span class="n">account_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;marketplace&#39;</span><span class="p">]:</span><span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;marketplace&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">account_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="MasterState.update_master_state-534"><a href="#MasterState.update_master_state-534"><span class="linenos">534</span></a>                        <span class="k">elif</span> <span class="n">smart_contract_transaction_flag</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-535"><a href="#MasterState.update_master_state-535"><span class="linenos">535</span></a>                            <span class="c1">#this is a smart contract transaction</span>
</span><span id="MasterState.update_master_state-536"><a href="#MasterState.update_master_state-536"><span class="linenos">536</span></a>                            <span class="k">if</span> <span class="n">account_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;smart_contract&#39;</span><span class="p">]:</span><span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;smart_contract&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">account_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="MasterState.update_master_state-537"><a href="#MasterState.update_master_state-537"><span class="linenos">537</span></a>                        <span class="c1">#reputation_acount management</span>
</span><span id="MasterState.update_master_state-538"><a href="#MasterState.update_master_state-538"><span class="linenos">538</span></a>                        <span class="c1">#logging.info(f&quot;====&gt;reputation_acount2:{reputation_acount}&quot;)</span>
</span><span id="MasterState.update_master_state-539"><a href="#MasterState.update_master_state-539"><span class="linenos">539</span></a>                        <span class="k">if</span> <span class="n">reputation_acount</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-540"><a href="#MasterState.update_master_state-540"><span class="linenos">540</span></a>                            <span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;reputation&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">reputation_acount</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-541"><a href="#MasterState.update_master_state-541"><span class="linenos">541</span></a>                            <span class="k">try</span><span class="p">:</span><span class="n">account_dic</span><span class="p">[</span><span class="s1">&#39;smart_contract&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">reputation_acount</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="MasterState.update_master_state-542"><a href="#MasterState.update_master_state-542"><span class="linenos">542</span></a>                            <span class="k">except</span><span class="p">:</span><span class="k">pass</span>
</span><span id="MasterState.update_master_state-543"><a href="#MasterState.update_master_state-543"><span class="linenos">543</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span><span class="o">=</span><span class="n">account_dic</span>
</span><span id="MasterState.update_master_state-544"><a href="#MasterState.update_master_state-544"><span class="linenos">544</span></a>
</span><span id="MasterState.update_master_state-545"><a href="#MasterState.update_master_state-545"><span class="linenos">545</span></a>                <span class="c1">#Removal of association between some account and this SmartContract</span>
</span><span id="MasterState.update_master_state-546"><a href="#MasterState.update_master_state-546"><span class="linenos">546</span></a>                <span class="n">account_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_account_list_from_locking_script</span><span class="p">(</span><span class="s2">&quot;OP_DEL_SC&quot;</span><span class="p">,</span><span class="n">utxo</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-547"><a href="#MasterState.update_master_state-547"><span class="linenos">547</span></a>                <span class="k">for</span> <span class="n">account</span> <span class="ow">in</span> <span class="n">account_list</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-548"><a href="#MasterState.update_master_state-548"><span class="linenos">548</span></a>                    <span class="n">smart_contract_account</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s2">&quot;smart_contract_account&quot;</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-549"><a href="#MasterState.update_master_state-549"><span class="linenos">549</span></a>                    <span class="n">account_2_remove_dic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span>
</span><span id="MasterState.update_master_state-550"><a href="#MasterState.update_master_state-550"><span class="linenos">550</span></a>                    <span class="k">if</span> <span class="n">smart_contract_account</span> <span class="ow">in</span> <span class="n">account_2_remove_dic</span><span class="p">[</span><span class="s1">&#39;marketplace&#39;</span><span class="p">]:</span>
</span><span id="MasterState.update_master_state-551"><a href="#MasterState.update_master_state-551"><span class="linenos">551</span></a>                        <span class="n">account_2_remove_dic</span><span class="p">[</span><span class="s1">&#39;marketplace&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">smart_contract_account</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-552"><a href="#MasterState.update_master_state-552"><span class="linenos">552</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span><span class="o">=</span><span class="n">account_2_remove_dic</span>
</span><span id="MasterState.update_master_state-553"><a href="#MasterState.update_master_state-553"><span class="linenos">553</span></a>                    <span class="c1">#FYI, transaction are never removed from marketplace_archive to keep tracked</span>
</span><span id="MasterState.update_master_state-554"><a href="#MasterState.update_master_state-554"><span class="linenos">554</span></a>                    
</span><span id="MasterState.update_master_state-555"><a href="#MasterState.update_master_state-555"><span class="linenos">555</span></a>                <span class="n">output_index</span><span class="o">+=</span><span class="mi">1</span>
</span><span id="MasterState.update_master_state-556"><a href="#MasterState.update_master_state-556"><span class="linenos">556</span></a>            
</span><span id="MasterState.update_master_state-557"><a href="#MasterState.update_master_state-557"><span class="linenos">557</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="MasterState.update_master_state-558"><a href="#MasterState.update_master_state-558"><span class="linenos">558</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**** Transaction6: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-559"><a href="#MasterState.update_master_state-559"><span class="linenos">559</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="MasterState.update_master_state-560"><a href="#MasterState.update_master_state-560"><span class="linenos">560</span></a>
</span><span id="MasterState.update_master_state-561"><a href="#MasterState.update_master_state-561"><span class="linenos">561</span></a>        <span class="c1">#Step 4 update of balance</span>
</span></pre></div>


    

                            </div>
                            <div id="MasterState.update_old_utxo_key" class="classattr">
                                        <input id="MasterState.update_old_utxo_key-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_old_utxo_key</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">old_utxo_account</span>,</span><span class="param">	<span class="n">old_utxo_key</span>,</span><span class="param">	<span class="n">new_utxo_key</span>,</span><span class="param">	<span class="n">new_utxo_value_output</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MasterState.update_old_utxo_key-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MasterState.update_old_utxo_key"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MasterState.update_old_utxo_key-563"><a href="#MasterState.update_old_utxo_key-563"><span class="linenos">563</span></a>    <span class="k">def</span> <span class="nf">update_old_utxo_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">old_utxo_account</span><span class="p">,</span><span class="n">old_utxo_key</span><span class="p">,</span><span class="n">new_utxo_key</span><span class="p">,</span><span class="n">new_utxo_value_output</span><span class="p">):</span>
</span><span id="MasterState.update_old_utxo_key-564"><a href="#MasterState.update_old_utxo_key-564"><span class="linenos">564</span></a>        <span class="k">if</span> <span class="n">old_utxo_account</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">old_utxo_account</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
</span><span id="MasterState.update_old_utxo_key-565"><a href="#MasterState.update_old_utxo_key-565"><span class="linenos">565</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState.update_old_utxo_key-566"><a href="#MasterState.update_old_utxo_key-566"><span class="linenos">566</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">old_utxo_account</span><span class="p">][</span><span class="s1">&#39;balance&#39;</span><span class="p">][</span><span class="s1">&#39;debit&#39;</span><span class="p">][</span><span class="n">new_utxo_key</span><span class="p">]</span><span class="o">=</span><span class="n">new_utxo_value_output</span>
</span><span id="MasterState.update_old_utxo_key-567"><a href="#MasterState.update_old_utxo_key-567"><span class="linenos">567</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="MasterState.update_old_utxo_key-568"><a href="#MasterState.update_old_utxo_key-568"><span class="linenos">568</span></a>                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**** Transaction7: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="MasterState.update_old_utxo_key-569"><a href="#MasterState.update_old_utxo_key-569"><span class="linenos">569</span></a>                <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="MasterState.store_master_state_in_memory" class="classattr">
                                        <input id="MasterState.store_master_state_in_memory-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">store_master_state_in_memory</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">BlockPoH</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MasterState.store_master_state_in_memory-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MasterState.store_master_state_in_memory"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MasterState.store_master_state_in_memory-573"><a href="#MasterState.store_master_state_in_memory-573"><span class="linenos">573</span></a>    <span class="k">def</span> <span class="nf">store_master_state_in_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">BlockPoH</span><span class="p">):</span>
</span><span id="MasterState.store_master_state_in_memory-574"><a href="#MasterState.store_master_state_in_memory-574"><span class="linenos">574</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;to store the transaction in a file =&gt;store_master_state_in_memory</span>
</span><span id="MasterState.store_master_state_in_memory-575"><a href="#MasterState.store_master_state_in_memory-575"><span class="linenos">575</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="MasterState.store_master_state_in_memory-576"><a href="#MasterState.store_master_state_in_memory-576"><span class="linenos">576</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState.store_master_state_in_memory-577"><a href="#MasterState.store_master_state_in_memory-577"><span class="linenos">577</span></a>            <span class="c1">#logging.info(f&quot;**** self.current_master_state.keys(): {self.current_master_state.keys():}&quot;)</span>
</span><span id="MasterState.store_master_state_in_memory-578"><a href="#MasterState.store_master_state_in_memory-578"><span class="linenos">578</span></a>            <span class="k">for</span> <span class="n">account</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="MasterState.store_master_state_in_memory-579"><a href="#MasterState.store_master_state_in_memory-579"><span class="linenos">579</span></a>                <span class="n">new_master_state</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState.store_master_state_in_memory-580"><a href="#MasterState.store_master_state_in_memory-580"><span class="linenos">580</span></a>                <span class="n">current_master_state</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="MasterState.store_master_state_in_memory-581"><a href="#MasterState.store_master_state_in_memory-581"><span class="linenos">581</span></a>                <span class="n">new_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span>
</span><span id="MasterState.store_master_state_in_memory-582"><a href="#MasterState.store_master_state_in_memory-582"><span class="linenos">582</span></a>                <span class="c1">#saving the file</span>
</span><span id="MasterState.store_master_state_in_memory-583"><a href="#MasterState.store_master_state_in_memory-583"><span class="linenos">583</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporary_save_flag</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="MasterState.store_master_state_in_memory-584"><a href="#MasterState.store_master_state_in_memory-584"><span class="linenos">584</span></a>                    <span class="c1">#on a temporary file for LeaderNode</span>
</span><span id="MasterState.store_master_state_in_memory-585"><a href="#MasterState.store_master_state_in_memory-585"><span class="linenos">585</span></a>                    <span class="n">temporary_file_master_state_raw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temporary_storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
</span><span id="MasterState.store_master_state_in_memory-586"><a href="#MasterState.store_master_state_in_memory-586"><span class="linenos">586</span></a>                    <span class="k">if</span> <span class="n">temporary_file_master_state_raw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MasterState.store_master_state_in_memory-587"><a href="#MasterState.store_master_state_in_memory-587"><span class="linenos">587</span></a>                        <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState.store_master_state_in_memory-588"><a href="#MasterState.store_master_state_in_memory-588"><span class="linenos">588</span></a>                            <span class="n">temporary_file_master_state_raw</span><span class="p">[</span><span class="n">BlockPoH</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span>
</span><span id="MasterState.store_master_state_in_memory-589"><a href="#MasterState.store_master_state_in_memory-589"><span class="linenos">589</span></a>                        <span class="k">except</span><span class="p">:</span>
</span><span id="MasterState.store_master_state_in_memory-590"><a href="#MasterState.store_master_state_in_memory-590"><span class="linenos">590</span></a>                            <span class="n">temporary_file_master_state_raw</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState.store_master_state_in_memory-591"><a href="#MasterState.store_master_state_in_memory-591"><span class="linenos">591</span></a>                            <span class="n">temporary_file_master_state_raw</span><span class="p">[</span><span class="n">BlockPoH</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span>
</span><span id="MasterState.store_master_state_in_memory-592"><a href="#MasterState.store_master_state_in_memory-592"><span class="linenos">592</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="MasterState.store_master_state_in_memory-593"><a href="#MasterState.store_master_state_in_memory-593"><span class="linenos">593</span></a>                        <span class="n">temporary_file_master_state_raw</span><span class="o">=</span><span class="p">{}</span>
</span><span id="MasterState.store_master_state_in_memory-594"><a href="#MasterState.store_master_state_in_memory-594"><span class="linenos">594</span></a>                        <span class="n">temporary_file_master_state_raw</span><span class="p">[</span><span class="n">BlockPoH</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">]</span>
</span><span id="MasterState.store_master_state_in_memory-595"><a href="#MasterState.store_master_state_in_memory-595"><span class="linenos">595</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">temporary_storage_sharding</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">account</span><span class="p">,</span><span class="n">temporary_file_master_state_raw</span><span class="p">)</span>
</span><span id="MasterState.store_master_state_in_memory-596"><a href="#MasterState.store_master_state_in_memory-596"><span class="linenos">596</span></a>                    <span class="c1">#logging.info(f&quot;**** account: {account} ==&gt; new_master_state:{new_master_state[account]}&quot;)</span>
</span><span id="MasterState.store_master_state_in_memory-597"><a href="#MasterState.store_master_state_in_memory-597"><span class="linenos">597</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MasterState.store_master_state_in_memory-598"><a href="#MasterState.store_master_state_in_memory-598"><span class="linenos">598</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">storage_sharding</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">account</span><span class="p">,</span><span class="n">new_master_state</span><span class="p">[</span><span class="n">account</span><span class="p">])</span>
</span><span id="MasterState.store_master_state_in_memory-599"><a href="#MasterState.store_master_state_in_memory-599"><span class="linenos">599</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="MasterState.store_master_state_in_memory-600"><a href="#MasterState.store_master_state_in_memory-600"><span class="linenos">600</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**** Transaction8: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>to store the transaction in a file =&gt;store_master_state_in_memory</p>
</div>


                            </div>
                            <div id="MasterState.delete_TempBlockPoH" class="classattr">
                                        <input id="MasterState.delete_TempBlockPoH-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">delete_TempBlockPoH</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">transaction</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MasterState.delete_TempBlockPoH-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MasterState.delete_TempBlockPoH"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MasterState.delete_TempBlockPoH-603"><a href="#MasterState.delete_TempBlockPoH-603"><span class="linenos">603</span></a>    <span class="k">def</span> <span class="nf">delete_TempBlockPoH</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">transaction</span><span class="p">):</span>
</span><span id="MasterState.delete_TempBlockPoH-604"><a href="#MasterState.delete_TempBlockPoH-604"><span class="linenos">604</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;to delete TempBlockPoH associated to the Transaction </span>
</span><span id="MasterState.delete_TempBlockPoH-605"><a href="#MasterState.delete_TempBlockPoH-605"><span class="linenos">605</span></a><span class="sd">        at the end of the block creation</span>
</span><span id="MasterState.delete_TempBlockPoH-606"><a href="#MasterState.delete_TempBlockPoH-606"><span class="linenos">606</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="MasterState.delete_TempBlockPoH-607"><a href="#MasterState.delete_TempBlockPoH-607"><span class="linenos">607</span></a>        <span class="n">account_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_account_list_transaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>
</span><span id="MasterState.delete_TempBlockPoH-608"><a href="#MasterState.delete_TempBlockPoH-608"><span class="linenos">608</span></a>        <span class="c1">#logging.info(f&quot;**** account_list: {account_list}&quot;)</span>
</span><span id="MasterState.delete_TempBlockPoH-609"><a href="#MasterState.delete_TempBlockPoH-609"><span class="linenos">609</span></a>        <span class="k">for</span> <span class="n">account</span> <span class="ow">in</span> <span class="n">account_list</span><span class="p">:</span>
</span><span id="MasterState.delete_TempBlockPoH-610"><a href="#MasterState.delete_TempBlockPoH-610"><span class="linenos">610</span></a>            <span class="n">temporary_file_master_state_raw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temporary_storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
</span><span id="MasterState.delete_TempBlockPoH-611"><a href="#MasterState.delete_TempBlockPoH-611"><span class="linenos">611</span></a>            <span class="k">if</span> <span class="n">temporary_file_master_state_raw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MasterState.delete_TempBlockPoH-612"><a href="#MasterState.delete_TempBlockPoH-612"><span class="linenos">612</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState.delete_TempBlockPoH-613"><a href="#MasterState.delete_TempBlockPoH-613"><span class="linenos">613</span></a>                    <span class="c1">#logging.info(f&quot;**** temporary_file_master_state_raw: {type(temporary_file_master_state_raw)} {temporary_file_master_state_raw}&quot;)</span>
</span><span id="MasterState.delete_TempBlockPoH-614"><a href="#MasterState.delete_TempBlockPoH-614"><span class="linenos">614</span></a>                    <span class="n">temporary_file_master_state_raw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;TempBlockPoH&quot;</span><span class="p">)</span>
</span><span id="MasterState.delete_TempBlockPoH-615"><a href="#MasterState.delete_TempBlockPoH-615"><span class="linenos">615</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">temporary_storage_sharding</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">account</span><span class="p">,</span><span class="n">temporary_file_master_state_raw</span><span class="p">)</span>
</span><span id="MasterState.delete_TempBlockPoH-616"><a href="#MasterState.delete_TempBlockPoH-616"><span class="linenos">616</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="MasterState.delete_TempBlockPoH-617"><a href="#MasterState.delete_TempBlockPoH-617"><span class="linenos">617</span></a>                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**** Transaction9: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="MasterState.delete_TempBlockPoH-618"><a href="#MasterState.delete_TempBlockPoH-618"><span class="linenos">618</span></a>                    <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>to delete TempBlockPoH associated to the Transaction 
at the end of the block creation</p>
</div>


                            </div>
                            <div id="MasterState.clean_temporary_file_master_state" class="classattr">
                                        <input id="MasterState.clean_temporary_file_master_state-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">clean_temporary_file_master_state</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">transaction</span>, </span><span class="param"><span class="n">BlockPoH</span>, </span><span class="param"><span class="n">master_state_readiness</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MasterState.clean_temporary_file_master_state-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MasterState.clean_temporary_file_master_state"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MasterState.clean_temporary_file_master_state-620"><a href="#MasterState.clean_temporary_file_master_state-620"><span class="linenos">620</span></a>    <span class="k">def</span> <span class="nf">clean_temporary_file_master_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">transaction</span><span class="p">,</span><span class="n">BlockPoH</span><span class="p">,</span><span class="n">master_state_readiness</span><span class="p">):</span>
</span><span id="MasterState.clean_temporary_file_master_state-621"><a href="#MasterState.clean_temporary_file_master_state-621"><span class="linenos">621</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;to delete the transaction in the temporary_file_master</span>
</span><span id="MasterState.clean_temporary_file_master_state-622"><a href="#MasterState.clean_temporary_file_master_state-622"><span class="linenos">622</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="MasterState.clean_temporary_file_master_state-623"><a href="#MasterState.clean_temporary_file_master_state-623"><span class="linenos">623</span></a>        <span class="n">account_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_account_list_transaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>
</span><span id="MasterState.clean_temporary_file_master_state-624"><a href="#MasterState.clean_temporary_file_master_state-624"><span class="linenos">624</span></a>        <span class="k">for</span> <span class="n">account</span> <span class="ow">in</span> <span class="n">account_list</span><span class="p">:</span>
</span><span id="MasterState.clean_temporary_file_master_state-625"><a href="#MasterState.clean_temporary_file_master_state-625"><span class="linenos">625</span></a>            <span class="n">temporary_file_master_state_raw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temporary_storage_sharding</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
</span><span id="MasterState.clean_temporary_file_master_state-626"><a href="#MasterState.clean_temporary_file_master_state-626"><span class="linenos">626</span></a>            <span class="k">if</span> <span class="n">temporary_file_master_state_raw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MasterState.clean_temporary_file_master_state-627"><a href="#MasterState.clean_temporary_file_master_state-627"><span class="linenos">627</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="MasterState.clean_temporary_file_master_state-628"><a href="#MasterState.clean_temporary_file_master_state-628"><span class="linenos">628</span></a>                    <span class="n">temporary_file_master_state_raw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">BlockPoH</span><span class="p">)</span>
</span><span id="MasterState.clean_temporary_file_master_state-629"><a href="#MasterState.clean_temporary_file_master_state-629"><span class="linenos">629</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="MasterState.clean_temporary_file_master_state-630"><a href="#MasterState.clean_temporary_file_master_state-630"><span class="linenos">630</span></a>                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**** Transaction10: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="MasterState.clean_temporary_file_master_state-631"><a href="#MasterState.clean_temporary_file_master_state-631"><span class="linenos">631</span></a>                    <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="MasterState.clean_temporary_file_master_state-632"><a href="#MasterState.clean_temporary_file_master_state-632"><span class="linenos">632</span></a>                <span class="k">if</span> <span class="n">temporary_file_master_state_raw</span><span class="o">==</span><span class="p">{}:</span>
</span><span id="MasterState.clean_temporary_file_master_state-633"><a href="#MasterState.clean_temporary_file_master_state-633"><span class="linenos">633</span></a>                    <span class="c1">#the file is empty, let&#39;s delete it</span>
</span><span id="MasterState.clean_temporary_file_master_state-634"><a href="#MasterState.clean_temporary_file_master_state-634"><span class="linenos">634</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">temporary_storage_sharding</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">account</span><span class="p">,</span><span class="n">master_state_readiness</span><span class="p">)</span>
</span><span id="MasterState.clean_temporary_file_master_state-635"><a href="#MasterState.clean_temporary_file_master_state-635"><span class="linenos">635</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MasterState.clean_temporary_file_master_state-636"><a href="#MasterState.clean_temporary_file_master_state-636"><span class="linenos">636</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">temporary_storage_sharding</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">account</span><span class="p">,</span><span class="n">temporary_file_master_state_raw</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>to delete the transaction in the temporary_file_master</p>
</div>


                            </div>
                            <div id="MasterState.extract_account_list_from_locking_script" class="classattr">
                                        <input id="MasterState.extract_account_list_from_locking_script-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">extract_account_list_from_locking_script</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">op_elem</span>, </span><span class="param"><span class="n">utxo</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MasterState.extract_account_list_from_locking_script-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MasterState.extract_account_list_from_locking_script"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MasterState.extract_account_list_from_locking_script-638"><a href="#MasterState.extract_account_list_from_locking_script-638"><span class="linenos">638</span></a>    <span class="k">def</span> <span class="nf">extract_account_list_from_locking_script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">op_elem</span><span class="p">,</span><span class="n">utxo</span><span class="p">):</span>
</span><span id="MasterState.extract_account_list_from_locking_script-639"><a href="#MasterState.extract_account_list_from_locking_script-639"><span class="linenos">639</span></a>        <span class="n">account_list</span><span class="o">=</span><span class="p">[]</span>
</span><span id="MasterState.extract_account_list_from_locking_script-640"><a href="#MasterState.extract_account_list_from_locking_script-640"><span class="linenos">640</span></a>        <span class="n">op_elem_account_list</span><span class="o">=</span><span class="p">[]</span>
</span><span id="MasterState.extract_account_list_from_locking_script-641"><a href="#MasterState.extract_account_list_from_locking_script-641"><span class="linenos">641</span></a>        <span class="n">locking_script</span><span class="o">=</span><span class="n">utxo</span><span class="p">[</span><span class="s1">&#39;locking_script&#39;</span><span class="p">]</span>
</span><span id="MasterState.extract_account_list_from_locking_script-642"><a href="#MasterState.extract_account_list_from_locking_script-642"><span class="linenos">642</span></a>        <span class="n">locking_script_list</span> <span class="o">=</span> <span class="n">locking_script</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="MasterState.extract_account_list_from_locking_script-643"><a href="#MasterState.extract_account_list_from_locking_script-643"><span class="linenos">643</span></a>        <span class="c1">#list of op_elem</span>
</span><span id="MasterState.extract_account_list_from_locking_script-644"><a href="#MasterState.extract_account_list_from_locking_script-644"><span class="linenos">644</span></a>        <span class="c1"># =&gt;OP_SC is used to associate an account to a SmartContract</span>
</span><span id="MasterState.extract_account_list_from_locking_script-645"><a href="#MasterState.extract_account_list_from_locking_script-645"><span class="linenos">645</span></a>        <span class="c1"># =&gt;OP_DEL_SC is used to deassociate an account from a SmartContract</span>
</span><span id="MasterState.extract_account_list_from_locking_script-646"><a href="#MasterState.extract_account_list_from_locking_script-646"><span class="linenos">646</span></a>        <span class="c1">#ex: OP_DUP OP_HASH160 31f2ac8088005412c7b031a6e342b17a65a48d01 OP_EQUAL_VERIFY OP_CHECKSIG OP_SC 47866ef83717f16c24cb246deeef1f75f798b8e5 </span>
</span><span id="MasterState.extract_account_list_from_locking_script-647"><a href="#MasterState.extract_account_list_from_locking_script-647"><span class="linenos">647</span></a>        <span class="c1">##OP_SC 531c2e528bd177866f7213b192833846018686e5 OP_DEL_SC 3243223324GFDG</span>
</span><span id="MasterState.extract_account_list_from_locking_script-648"><a href="#MasterState.extract_account_list_from_locking_script-648"><span class="linenos">648</span></a>        <span class="n">flag_for_adding</span><span class="o">=</span><span class="kc">False</span>
</span><span id="MasterState.extract_account_list_from_locking_script-649"><a href="#MasterState.extract_account_list_from_locking_script-649"><span class="linenos">649</span></a>        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">locking_script_list</span><span class="p">:</span>
</span><span id="MasterState.extract_account_list_from_locking_script-650"><a href="#MasterState.extract_account_list_from_locking_script-650"><span class="linenos">650</span></a>            <span class="c1">#Step 1 list of account when there is no specific OP like OP_SC, OP_DEL_SC</span>
</span><span id="MasterState.extract_account_list_from_locking_script-651"><a href="#MasterState.extract_account_list_from_locking_script-651"><span class="linenos">651</span></a>            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;OP&quot;</span><span class="p">):</span>
</span><span id="MasterState.extract_account_list_from_locking_script-652"><a href="#MasterState.extract_account_list_from_locking_script-652"><span class="linenos">652</span></a>                <span class="k">pass</span>
</span><span id="MasterState.extract_account_list_from_locking_script-653"><a href="#MasterState.extract_account_list_from_locking_script-653"><span class="linenos">653</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MasterState.extract_account_list_from_locking_script-654"><a href="#MasterState.extract_account_list_from_locking_script-654"><span class="linenos">654</span></a>                <span class="k">if</span> <span class="n">element</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">account_list</span><span class="p">:</span><span class="n">account_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
</span><span id="MasterState.extract_account_list_from_locking_script-655"><a href="#MasterState.extract_account_list_from_locking_script-655"><span class="linenos">655</span></a>            <span class="c1">#Step 2 list for specific OP like OP_SC, OP_DEL_SC</span>
</span><span id="MasterState.extract_account_list_from_locking_script-656"><a href="#MasterState.extract_account_list_from_locking_script-656"><span class="linenos">656</span></a>            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">op_elem</span><span class="p">):</span><span class="n">flag_for_adding</span><span class="o">=</span><span class="kc">True</span>
</span><span id="MasterState.extract_account_list_from_locking_script-657"><a href="#MasterState.extract_account_list_from_locking_script-657"><span class="linenos">657</span></a>            <span class="k">elif</span> <span class="n">flag_for_adding</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="MasterState.extract_account_list_from_locking_script-658"><a href="#MasterState.extract_account_list_from_locking_script-658"><span class="linenos">658</span></a>                <span class="k">if</span> <span class="n">element</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">op_elem_account_list</span><span class="p">:</span><span class="n">op_elem_account_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
</span><span id="MasterState.extract_account_list_from_locking_script-659"><a href="#MasterState.extract_account_list_from_locking_script-659"><span class="linenos">659</span></a>                <span class="n">flag_for_adding</span><span class="o">=</span><span class="kc">False</span>
</span><span id="MasterState.extract_account_list_from_locking_script-660"><a href="#MasterState.extract_account_list_from_locking_script-660"><span class="linenos">660</span></a>        
</span><span id="MasterState.extract_account_list_from_locking_script-661"><a href="#MasterState.extract_account_list_from_locking_script-661"><span class="linenos">661</span></a>        <span class="k">if</span> <span class="n">op_elem_account_list</span><span class="o">!=</span><span class="p">[]:</span><span class="k">return</span> <span class="n">op_elem_account_list</span>
</span><span id="MasterState.extract_account_list_from_locking_script-662"><a href="#MasterState.extract_account_list_from_locking_script-662"><span class="linenos">662</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MasterState.extract_account_list_from_locking_script-663"><a href="#MasterState.extract_account_list_from_locking_script-663"><span class="linenos">663</span></a>            <span class="k">if</span> <span class="n">op_elem</span><span class="o">==</span><span class="s2">&quot;OP_DEL_SC&quot;</span><span class="p">:</span><span class="k">return</span> <span class="p">[]</span>
</span><span id="MasterState.extract_account_list_from_locking_script-664"><a href="#MasterState.extract_account_list_from_locking_script-664"><span class="linenos">664</span></a>            <span class="k">else</span><span class="p">:</span><span class="k">return</span> <span class="n">account_list</span>
</span></pre></div>


    

                            </div>
                            <div id="MasterState.extract_account_list_from_unlocking_public_key_hash" class="classattr">
                                        <input id="MasterState.extract_account_list_from_unlocking_public_key_hash-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">extract_account_list_from_unlocking_public_key_hash</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">utxo_account</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MasterState.extract_account_list_from_unlocking_public_key_hash-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MasterState.extract_account_list_from_unlocking_public_key_hash"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MasterState.extract_account_list_from_unlocking_public_key_hash-666"><a href="#MasterState.extract_account_list_from_unlocking_public_key_hash-666"><span class="linenos">666</span></a>    <span class="k">def</span> <span class="nf">extract_account_list_from_unlocking_public_key_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">utxo_account</span><span class="p">):</span>
</span><span id="MasterState.extract_account_list_from_unlocking_public_key_hash-667"><a href="#MasterState.extract_account_list_from_unlocking_public_key_hash-667"><span class="linenos">667</span></a>        <span class="c1">#special process Smart Contract</span>
</span><span id="MasterState.extract_account_list_from_unlocking_public_key_hash-668"><a href="#MasterState.extract_account_list_from_unlocking_public_key_hash-668"><span class="linenos">668</span></a>        <span class="c1">#when there is &quot;SC&quot; in unlocking_public_key_hash ex: &quot;31f2ac8088005412c7b031a6e342b17a65a48d01 SC f998212b2adc762f114c9ec2b0b2d9bd6c811688</span>
</span><span id="MasterState.extract_account_list_from_unlocking_public_key_hash-669"><a href="#MasterState.extract_account_list_from_unlocking_public_key_hash-669"><span class="linenos">669</span></a>        <span class="n">new_utxo_account</span><span class="o">=</span><span class="n">utxo_account</span>
</span><span id="MasterState.extract_account_list_from_unlocking_public_key_hash-670"><a href="#MasterState.extract_account_list_from_unlocking_public_key_hash-670"><span class="linenos">670</span></a>        <span class="k">if</span> <span class="n">utxo_account</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;SC &quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="MasterState.extract_account_list_from_unlocking_public_key_hash-671"><a href="#MasterState.extract_account_list_from_unlocking_public_key_hash-671"><span class="linenos">671</span></a>            <span class="n">new_utxo_account</span><span class="o">=</span><span class="n">utxo_account</span><span class="p">[</span><span class="n">utxo_account</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;SC &quot;</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">utxo_account</span><span class="p">)]</span>
</span><span id="MasterState.extract_account_list_from_unlocking_public_key_hash-672"><a href="#MasterState.extract_account_list_from_unlocking_public_key_hash-672"><span class="linenos">672</span></a>        <span class="k">return</span> <span class="n">new_utxo_account</span>
</span></pre></div>


    

                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>